<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fortified Porto: A Wine Master's Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-content {
            max-height: 80vh;
        }
        .prose-purple a {
            color: #9333ea;
        }
        .prose-purple a:hover {
            color: #7e22ce;
        }
        .timeline-item.selected {
            background-color: #6b21a8;
            color: white;
        }
        .flashcard-container {
            perspective: 1000px;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border-radius: 0.5rem;
        }
        .flashcard-front {
            background-color: #374151; /* gray-700 */
        }
        .flashcard-back {
            background-color: #4b5563; /* gray-600 */
            transform: rotateY(180deg);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="main-menu" class="min-h-screen flex flex-col items-center justify-center p-4">
        <h1 class="text-4xl md:text-5xl font-bold text-purple-400 mb-2 text-center">Fortified Porto</h1>
        <h2 class="text-2xl md:text-3xl font-semibold mb-8 text-center">A Wine Master's Challenge</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-4xl mb-8">
            <button data-module="historian" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Historian's Scroll</h3>
                <p class="text-gray-400">Order the key events that shaped the Port trade.</p>
            </button>
            <button data-module="terroir" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Terroir Architect</h3>
                <p class="text-gray-400">Master the soils, climate, and geography of the Douro.</p>
            </button>
            <button data-module="ampelographer" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Ampelographer's Challenge</h3>
                <p class="text-gray-400">Identify the Douro's key grape varieties.</p>
            </button>
            <button data-module="lawmaker" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Lawmaker's Desk</h3>
                <p class="text-gray-400">Navigate the complexities of IVDP law and production regulations.</p>
            </button>
            <button data-module="gastronome" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Gastronome's Table</h3>
                <p class="text-gray-400">Explore classic food pairings and local cuisine.</p>
            </button>
            <button data-module="critic" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Critic's Corner</h3>
                <p class="text-gray-400">Analyze vintages and iconic producers.</p>
            </button>
        </div>

        <div class="w-full max-w-4xl">
            <button data-module="flashcard" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300 w-full">
                <h3 class="text-xl font-bold mb-2">Flashcard Study</h3>
                <p class="text-gray-400">Build your knowledge with targeted review.</p>
            </button>
        </div>
    	
        <button id="ai-settings-btn" class="mt-8 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
            ⚙️ AI Settings
        </button>
    </div>

    <div id="game-screen" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
        </div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-content-wrapper" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl modal-content overflow-y-auto">
            </div>
    </div>

    <script>
        // This object contains the questions for the quiz modules
        const gameData = {
            historian: {
                title: "The Historian's Scroll",
                instructions: "For each of the 5 challenges, arrange the historical events in chronological order from earliest to latest. Tap an event to add it to your timeline, then submit your answer.",
                questions: [
                    {
                        question: "Arrange these foundational events that established the Port trade.",
                        events: [
                            { text: "The Methuen Treaty is signed, giving Portuguese wines preferential tax rates in England.", date: 1703 },
                            { text: "The Douro Wine Company (C.G.A.V.A.D.) is founded by the Marquis of Pombal.", date: 1756 },
                            { text: "The boundaries of the Douro Demarcated Region are physically marked with 335 granite pillars ('marcos de feitoria').", date: 1761 },
                            { text: "The Factory House, the British Association's headquarters, is completed in Porto.", date: 1790 },
                            { text: "The Douro Wine Company's monopoly is abolished, leading to a period of 'free trade'.", date: 1834 }
                        ]
                    },
                    {
                        question: "Order the key events of the tumultuous 19th century.",
                        events: [
                            { text: "The Peninsular War disrupts trade and leads to the sacking of Port lodges.", date: 1809 },
                            { text: "Baron de Forrester publishes his influential 'A Word or Two on Port Wine', criticizing Port production methods.", date: 1844 },
                            { text: "Oidium (powdery mildew) strikes the Douro for the first time.", date: 1851 },
                            { text: "Phylloxera is first identified in the Douro, leading to devastation.", date: 1868 },
                            { text: "Dona Antónia Adelaide Ferreira, 'A Ferreirinha', dies, having consolidated a vast vineyard empire.", date: 1896 }
                        ]
                    },
                    {
                        question: "Place these critical regulatory and stylistic developments in chronological order.",
                        events: [
                            { text: "The 'Lei do Terço' (Law of the Third) is introduced, limiting sales to protect prices.", date: 1907 },
                            { text: "The Casa do Douro is established to represent the interests of the region's growers.", date: 1932 },
                            { text: "The Instituto do Vinho do Porto (IVP) is created to regulate and promote the trade.", date: 1933 },
                            { text: "Taylor's launches the first-ever Late Bottled Vintage (LBV) Port from the 1965 vintage.", date: 1970 },
                            { text: "Portugal joins the European Economic Community (EEC), leading to major changes in trade regulations.", date: 1986 }
                        ]
                    },
                    {
                        question: "Sequence the evolution of the modern Port industry.",
                        events: [
                            { text: "The 'benefício' system is reformed, basing the A-F vineyard ranking on a 12-point system.", date: 1947 },
                            { text: "Legislation is passed allowing Douro producers to estate-bottle and export their Port directly.", date: 1986 },
                            { text: "The Symington family acquires the Dow's and Warre's brands.", date: 1970 },
                            { text: "AXA Millésimes acquires Quinta do Noval.", date: 1993 },
                            { text: "The IVP merges with other bodies to become the IVDP (Instituto dos Vinhos do Douro e Porto), overseeing both Port and Douro DOC wines.", date: 2003 }
                        ]
                    }
                ]
            },
            terroir: {
                title: "The Terroir Architect",
                instructions: "Answer 10 multiple-choice questions about the geology, geography, and climate of the Douro Valley.",
                questions: [
                    { q: "What is the dominant, heat-retaining soil type of the Douro Valley, crucial for ripening grapes?", a: "Schist", o: ["Granite", "Clay", "Limestone"] },
                    { q: "Which mountain range creates a rain shadow effect, making the Douro Valley significantly hotter and drier than the coast?", a: "Serra do Marão", o: ["Serra da Estrela", "Pyrenees", "Picos de Europa"] },
                    { q: "Which of the three official sub-regions of the Douro has the highest rainfall and is known for producing lighter styles of Port?", a: "Baixo Corgo", o: ["Cima Corgo", "Douro Superior", "Vinho Verde"] },
                    { q: "The Cima Corgo sub-region is centered around which town and is considered the heartland for classic Port production?", a: "Pinhão", o: ["Régua", "Vila Nova de Foz Côa", "Porto"] },
                    { q: "What is the name for the traditional, narrow, stone-walled terraces built by hand in the Douro?", a: "Socalcos", o: ["Patamares", "Lagar", "Feitoria"] },
                    { q: "What are 'patamares', the wider terraces built in the 1970s and 80s that allow for small tractor access?", a: "Mechanically built terraces with earth banks", o: ["Vertical planting rows", "Ancient Roman vineyards", "Single-vineyard estates"] },
                    { q: "The Douro vineyard classification system, known as the 'cadastro', rates vineyards on a scale from:", a: "A to F", o: ["1 to 10", "Grand Cru to Village", "Reserva to Gran Reserva"] },
                    { q: "Which of the following is NOT one of the 12 factors considered in the 'cadastro' vineyard rating?", a: "The age of the producer", o: ["Altitude", "Yield", "Grape Varieties"] },
                    { q: "The climate of the Douro Valley is best described as:", a: "Continental with hot, dry summers", o: ["Maritime with mild, wet summers", "Mediterranean with coastal breezes", "Alpine with cool temperatures"] },
                    { q: "Which sub-region is the hottest, driest, and most sparsely planted, but contains many top estates?", a: "Douro Superior", o: ["Cima Corgo", "Baixo Corgo", "Minho"] },
                    { q: "What is the primary viticultural advantage of the steep slopes in the Douro?", a: "They provide optimal sun exposure for ripening.", o: ["They retain water efficiently.", "They are easy to mechanize.", "They protect vines from wind."] },
                    { q: "The term 'Vinha ao Alto' refers to what type of planting system?", a: "Vertical rows planted up and down the slope", o: ["Head-trained bush vines", "Terraces with stone walls", "A high-trellised pergola system"] },
                    { q: "What type of schist is most common in the Douro, which splits vertically, allowing vine roots to penetrate deeply for water?", a: "Grauvakian Schist", o: ["Blue Slate", "Marlstone", "Gneiss"] },
                    { q: "Approximately what percentage of the Douro Demarcated Region is actually planted with vines?", a: "15%", o: ["50%", "30%", "75%"] },
                    { q: "A Class 'A' vineyard in the 'cadastro' system must score how many points?", a: "More than 1200", o: ["801-1000", "1001-1200", "601-800"] },
                    { q: "The Douro River flows from Spain, where it is known as the Duero, and empties into which ocean?", a: "The Atlantic Ocean", o: ["The Mediterranean Sea", "The Bay of Biscay", "The North Sea"] },
                    { q: "What is the primary viticultural challenge in the Douro Superior?", a: "Extreme heat and drought", o: ["Excessive rainfall and fungal disease", "Spring frosts", "Poor soil drainage"] },
                    { q: "Which city, located at the mouth of the Douro River, is the historical center for the aging and shipping of Port?", a: "Vila Nova de Gaia", o: ["Lisbon", "Régua", "Pinhão"] },
                    { q: "How does the schist soil contribute to the character of Port?", a: "It provides good drainage and retains heat, leading to concentrated, powerful wines.", o: ["It has high fertility, leading to high yields.", "It is high in pH, leading to low-acid wines.", "It is very cool, leading to delicate, aromatic wines."] },
                    { q: "The altitude of vineyards in the Douro ranges significantly. What is the main effect of higher altitude plantings?", a: "They produce wines with higher acidity and fresher aromatics.", o: ["They produce wines with higher alcohol and ripeness.", "They are immune to pests.", "They have higher yields."] },
                    { q: "What does the term 'Feitoria' refer to in the Douro's history?", a: "The area designated to produce the highest quality Port for export.", o: ["A cooperative of growers.", "A type of fermentation vessel.", "A local festival."] },
                    { q: "The Douro is a UNESCO World Heritage site, recognized for what?", a: "Its uniquely terraced vineyard landscape", o: ["Its ancient Roman ruins", "Its biodiversity", "Its traditional music"] },
                    { q: "What is the average annual rainfall in the Cima Corgo?", a: "~700mm", o: ["~900mm", "~400mm", "~1200mm"] },
                    { q: "What is the average annual rainfall in the Douro Superior?", a: "~400mm", o: ["~700mm", "~900mm", "~600mm"] },
                    { q: "Which direction do the best, most-valued vineyard sites typically face?", a: "South", o: ["North", "East", "West"] },
                    { q: "What is the role of the many side tributaries that flow into the Douro River, such as the Pinhão, Távora, and Tua?", a: "They create unique microclimates and valleys for top vineyard sites.", o: ["They are used for irrigation.", "They mark the boundaries of sub-regions.", "They are not suitable for viticulture."] },
                    { q: "A Class 'F' vineyard in the 'cadastro' system scores how many points?", a: "200 or less", o: ["401-600", "201-400", "601-800"] },
                    { q: "The 'benefício' authorization is directly linked to what?", a: "The vineyard's 'cadastro' rating", o: ["The producer's export sales", "The age of the vines", "The previous year's vintage quality"] },
                    { q: "Why are east-facing vineyards also highly prized in the Douro?", a: "They receive gentle morning sun and are protected from harsh afternoon heat.", o: ["They receive the most intense sun.", "They are protected from frost.", "They have the deepest soils."] },
                    { q: "The transition from 'socalcos' to 'patamares' was primarily driven by a need for what?", a: "Increased mechanization and economic viability", o: ["Better water retention", "Aesthetic appeal", "Frost protection"] },
                    { q: "What percentage of a vineyard's location score in the 'cadastro' is based on its altitude?", a: "50%", o: ["25%", "75%", "10%"] },
                    { q: "What natural barrier separates the Douro Superior from the Spanish border?", a: "A series of impassable gorges and rapids", o: ["A high mountain range", "A large desert", "A dense forest"] },
                    { q: "How is soil depth a critical factor in the Douro's terroir?", a: "Deep, fractured schist allows roots to access water during dry summers.", o: ["Shallow soils restrict vigor and concentrate flavors.", "Deep soils lead to excessive yields.", "Soil depth is not a major factor."] },
                    { q: "Which sub-region contains the highest percentage of 'A' and 'B' rated vineyards?", a: "Cima Corgo", o: ["Baixo Corgo", "Douro Superior", "All are equal"] },
                    { q: "The traditional method of planting on 'socalcos' required how many man-hours per hectare?", a: "Up to 10 times more than a modern vineyard", o: ["The same as a modern vineyard", "Half that of a modern vineyard", "Twice that of a modern vineyard"] },
                    { q: "What is the geological origin of the Douro's schist soils?", a: "They are Precambrian and Paleozoic metamorphic rocks.", o: ["They are volcanic basalt.", "They are sedimentary limestone.", "They are alluvial river deposits."] },
                    { q: "What is the primary soil type found just outside the demarcated region, which is less suitable for Port?", a: "Granite", o: ["Sand", "Clay", "Chalk"] },
                    { q: "The term 'quinta' refers to what?", a: "A wine-producing estate or farm", o: ["A type of barrel", "A grape variety", "A legal classification"] },
                    { q: "What is the primary viticultural risk in the Baixo Corgo?", a: "Higher rainfall leading to fungal disease and less concentration.", o: ["Extreme drought", "Spring frost", "Hail"] },
                    { q: "The Douro Demarcated Region was the world's first, established in what year?", a: "1756", o: ["1855", "1927", "1703"] },
                    { q: "Which factor in the 'cadastro' system can add the most points to a vineyard's score?", a: "Location (sub-region)", o: ["Soil type", "Grape varieties", "Vine age"] },
                    { q: "The 'patamares' system, while efficient, has been criticized for what environmental issue?", a: "Increased soil erosion", o: ["Decreased biodiversity", "Higher water usage", "Light pollution"] },
                    { q: "What is the maximum yield permitted for Port production?", a: "55 hl/ha", o: ["75 hl/ha", "35 hl/ha", "100 hl/ha"] },
                    { q: "What is the minimum planting density required in the Douro?", a: "3,000 vines per hectare", o: ["5,000 vines per hectare", "1,000 vines per hectare", "There is no minimum"] },
                    { q: "Which natural feature marks the western boundary of the Baixo Corgo?", a: "The village of Barqueiros", o: ["The Serra do Marão", "The Spanish border", "The city of Porto"] },
                    { q: "Which natural feature marks the eastern boundary of the Cima Corgo?", a: "The Cachão da Valeira gorge", o: ["The Pinhão River", "The Tua River", "The city of Régua"] },
                    { q: "The Douro landscape is often described as a 'patchwork quilt' due to what?", a: "The mix of vineyards, olive groves, and wild scrubland", o: ["The different colors of schist", "The variety of house paint colors", "The flags of different producers"] },
                    { q: "Why is irrigation generally disallowed for Port production?", a: "To maintain concentration and reflect the terroir of the vintage.", o: ["Because there is no water available.", "Because it is too expensive.", "Because it makes the grapes too sweet."] },
                    { q: "What is the typical diurnal temperature range during the Douro's summer growing season?", a: "Wide, with very hot days and cool nights", o: ["Narrow, with warm days and warm nights", "Moderate, with cool days and cool nights", "Extreme, with hot days and freezing nights"] },
                    { q: "The 'Instituto dos Vinhos do Douro e Porto' (IVDP) is based in which city?", a: "Régua", o: ["Porto", "Pinhão", "Lisbon"] }
                ]
            },
            ampelographer: {
                title: "The Ampelographer's Challenge",
                instructions: "Answer 10 multiple-choice questions about the key grape varieties and clones of the Douro. After a correct answer, you may have the option to generate an AI profile.",
                questions: [
                    { q: "Which grape is considered the Douro's finest, known for its intense color, structure, and floral (violet) aromatics?", a: "Touriga Nacional", o: ["Tinta Roriz", "Tinta Barroca", "Touriga Franca"], subjectType: 'grape', subjectName: 'Touriga Nacional' },
                    { q: "Which grape variety is the most widely planted in the Douro, valued for its resilience, consistent yields, and aromatic contribution to blends?", a: "Touriga Franca", o: ["Touriga Nacional", "Tinta Cão", "Tinta Amarela"], subjectType: 'grape', subjectName: 'Touriga Franca' },
                    { q: "Tinta Roriz is the Douro name for which famous Spanish grape variety?", a: "Tempranillo", o: ["Garnacha", "Monastrell", "Carignan"], subjectType: 'grape', subjectName: 'Tinta Roriz' },
                    { q: "Which of the 'big five' red grapes is known for providing high sugar levels (and thus alcohol) and a soft, velvety texture, but can be prone to color loss?", a: "Tinta Barroca", o: ["Tinta Cão", "Touriga Nacional", "Tinta Roriz"], subjectType: 'grape', subjectName: 'Tinta Barroca' },
                    { q: "Which grape, whose name means 'Red Dog', is a low-yielding variety prized for its high acidity and ability to add finesse and longevity to a blend?", a: "Tinta Cão", o: ["Sousão", "Tinta Amarela", "Touriga Franca"], subjectType: 'grape', subjectName: 'Tinta Cão' },
                    { q: "What is the term for the traditional Douro vineyard practice of planting numerous different grape varieties intermingled in the same plot?", a: "Field Blend (Vinha Velha)", o: ["Monovarietal Planting", "Clonal Selection", "Vertical Shoot Positioning"], subjectType: 'viticulture', subjectName: 'Field Blend' },
                    { q: "Which red grape is known for its intense color and searing acidity, often used in small quantities to adjust blends?", a: "Sousão", o: ["Tinta Barroca", "Bastardo", "Mourisco Tinto"], subjectType: 'grape', subjectName: 'Sousão' },
                    { q: "Which of the following is considered a top-tier white grape for producing dry Douro wines and White Port, known for its structure and acidity?", a: "Rabigato", o: ["Malvasia Fina", "Síria", "Folgasão"], subjectType: 'grape', subjectName: 'Rabigato' },
                    { q: "Malvasia Fina is a key grape for White Port, contributing what characteristic to the blend?", a: "Aromatic intensity (notes of molasses and nutmeg)", o: ["High acidity", "Deep color", "Tannic structure"], subjectType: 'grape', subjectName: 'Malvasia Fina' },
                    { q: "Gouveio, another key white grape, is the same variety as which Spanish grape?", a: "Godello", o: ["Verdejo", "Albariño", "Viura"], subjectType: 'grape', subjectName: 'Gouveio' },
                    { q: "What is the primary viticultural drawback of Touriga Nacional?", a: "Very low yields due to poor fruit set (coulure)", o: ["Susceptibility to botrytis", "Lack of color", "Low acidity"], subjectType: 'grape', subjectName: 'Touriga Nacional' },
                    { q: "Touriga Franca is a crossing of which two grape varieties?", a: "Touriga Nacional and Mourisco Tinto", o: ["Tinta Roriz and Tinta Cão", "Tinta Barroca and Sousão", "It is not a crossing"], subjectType: 'grape', subjectName: 'Touriga Franca' },
                    { q: "In a typical Port blend, Tinta Roriz is valued for providing what?", a: "Solid tannic structure and berry fruit flavors", o: ["High alcohol and softness", "Floral aromatics and acidity", "Intense, dark color"], subjectType: 'grape', subjectName: 'Tinta Roriz' },
                    { q: "Which grape variety is most likely to suffer from heat stress and berry shrivel in the hottest Douro vintages?", a: "Tinta Barroca", o: ["Tinta Cão", "Touriga Nacional", "Touriga Franca"], subjectType: 'grape', subjectName: 'Tinta Barroca' },
                    { q: "Approximately how many different grape varieties are authorized for Port production?", a: "Over 80", o: ["Around 20", "Exactly 10", "Less than 5"], subjectType: 'law', subjectName: 'Authorized Port Grapes' },
                    { q: "Viosinho is a high-quality white grape prized for what characteristic?", a: "Good acidity and concentration, adding structure to white blends", o: ["High yields", "Neutral flavor profile", "Pink-skinned berries"], subjectType: 'grape', subjectName: 'Viosinho' },
                    { q: "Which grape, also known as Trincadeira, is prone to rot in the Baixo Corgo but can perform well in the dry Douro Superior?", a: "Tinta Amarela", o: ["Touriga Nacional", "Tinta Cão", "Bastardo"], subjectType: 'grape', subjectName: 'Tinta Amarela' },
                    { q: "The move away from field blends towards single-variety blocks ('talhões') was driven by a desire for what?", a: "Greater control over ripeness and consistency", o: ["Adherence to EU regulations", "Higher yields", "Easier harvesting"], subjectType: 'viticulture', subjectName: 'Single-Variety Blocks' },
                    { q: "Which of the 'big five' is typically the earliest to ripen?", a: "Tinta Barroca", o: ["Touriga Nacional", "Tinta Cão", "Touriga Franca"] },
                    { q: "Which of the 'big five' is known for having thick skins, contributing to its intense color and tannin?", a: "Touriga Nacional", o: ["Tinta Barroca", "Tinta Cão", "Tinta Roriz"] },
                    { q: "What is the primary role of Touriga Franca in a blend?", a: "It provides aromatic complexity (wild herbs, flowers) and structure, acting as a bridge between other grapes.", o: ["It provides the primary alcohol content.", "It provides the main source of acidity.", "It is used solely for color."] },
                    { q: "What is the traditional training system for vines in the Douro?", a: "Spur-pruned, cordon-trained", o: ["Head-trained, cane-pruned", "Pergola", "Scott Henry"] },
                    { q: "Historically, why were so many varieties planted together in field blends?", a: "To hedge against the risk of a single variety failing in a given vintage.", o: ["Because growers did not know what they were planting.", "To confuse tax collectors.", "To increase yields."] },
                    { q: "Which white grape is known for its slight bitterness on the finish, which can add complexity to a blend?", a: "Gouveio", o: ["Rabigato", "Malvasia Fina", "Viosinho"] },
                    { q: "Tinta Francisca, a more obscure variety, is a crossing of Touriga Nacional and which other grape?", a: "Mourisco Tinto", o: ["Tinta Roriz", "Tinta Cão", "Tinta Barroca"] },
                    { q: "Which red grape is also known as Trousseau in the Jura region of France?", a: "Bastardo", o: ["Sousão", "Tinta Amarela", "Mourisco Tinto"] },
                    { q: "What is a major advantage of Touriga Franca from a grower's perspective?", a: "It is resistant to both oidium and downy mildew.", o: ["It ripens very early.", "It has extremely high yields.", "It requires no pruning."] },
                    { q: "Which of the top red grapes is known for its ability to withstand drought conditions exceptionally well?", a: "Tinta Cão", o: ["Tinta Barroca", "Tinta Roriz", "Touriga Nacional"] },
                    { q: "Donzelinho Branco is a white grape primarily used to add what to a blend?", a: "Acidity", o: ["Alcohol", "Color", "Sugar"] },
                    { q: "Why is clonal selection less common in the Douro compared to regions like Burgundy?", a: "The genetic diversity of old field blends is considered a major asset.", o: ["The IVDP prohibits it.", "The soil is not suitable for clones.", "Growers prefer to use massal selection."] },
                    { q: "Which grape adds a note of dark chocolate and ripe plum to a blend?", a: "Tinta Barroca", o: ["Tinta Cão", "Touriga Nacional", "Sousão"] },
                    { q: "The five 'officially recommended' red grapes were identified as superior after extensive research in which decade?", a: "1970s", o: ["1920s", "1950s", "1990s"] },
                    { q: "Codega do Larinho is a white variety known for what quality?", a: "High potential alcohol and low acidity, good for aged styles", o: ["Sharp acidity", "Intense color", "Tannic structure"] },
                    { q: "Which grape variety is known for its 'second crop' which ripens much later and is generally of lower quality?", a: "Tinta Roriz", o: ["Touriga Nacional", "Touriga Franca", "Tinta Barroca"] },
                    { q: "What is the primary reason that red grapes dominate the Douro plantings?", a: "The production of Port wine", o: ["They are easier to grow", "They command higher prices", "The climate is unsuitable for white grapes"] },
                    { q: "Which grape is known for its tight bunches, making it susceptible to botrytis in wetter years?", a: "Touriga Nacional", o: ["Tinta Cão", "Touriga Franca", "Sousão"] },
                    { q: "In dry Douro DOC red wines, Tinta Roriz provides a similar profile to its Spanish counterpart, with notes of:", a: "Red cherry and spice", o: ["Black pepper and smoke", "Violets and roses", "Graphite and tar"] },
                    { q: "Which of the following is NOT one of the five officially 'recommended' red varietals?", a: "Sousão", o: ["Touriga Nacional", "Touriga Franca", "Tinta Roriz"] },
                    { q: "Which grape is most likely to be found as a single-varietal Douro DOC wine due to its aromatic appeal?", a: "Touriga Nacional", o: ["Tinta Barroca", "Tinta Cão", "Sousão"] },
                    { q: "What is a 'Vinha Velha'?", a: "An old vineyard, typically planted with a field blend of many varieties", o: ["A vineyard that has been recently replanted", "A single-varietal plot", "A vineyard owned by the IVDP"] },
                    { q: "The aromatic profile of Touriga Franca is often described as having notes of:", a: "Wild flowers and blackberry", o: ["Violets and bergamot", "Plum and chocolate", "Red cherry and leather"] },
                    { q: "What is the primary reason Tinta Cão fell out of favor before its modern revival?", a: "Its extremely low yields made it uneconomical.", o: ["It was difficult to ripen.", "It had poor color.", "It was prone to disease."] },
                    { q: "Which white grape is also known as Síria or Roupeiro in other parts of Portugal?", a: "Codega", o: ["Gouveio", "Rabigato", "Viosinho"] },
                    { q: "What is 'massal selection'?", a: "A method of propagation using cuttings from many excellent older vines.", o: ["Planting a single, certified clone.", "Grafting a vine onto a new rootstock.", "A pruning technique."] },
                    { q: "Which grape is prized for adding a firm tannic 'backbone' to a blend?", a: "Touriga Nacional", o: ["Tinta Barroca", "Malvasia Fina", "Bastardo"] },
                    { q: "How many of the 'top 5' grapes are required to be planted for a vineyard to get the maximum score on the 'cadastro'?", a: "At least two", o: ["All five", "At least three", "Just one"] },
                    { q: "Which of these grapes is known for its upright growth habit, making it easier to manage in the vineyard?", a: "Tinta Barroca", o: ["Touriga Nacional", "Tinta Cão", "Tinta Roriz"] },
                    { q: "The DNA profiling that confirmed the parentage of Touriga Franca was conducted by which famous university?", a: "UC Davis", o: ["University of Bordeaux", "Geisenheim Institute", "University of Adelaide"] },
                    { q: "Which of the five main red grapes provides the most rustic and sometimes jammy character?", a: "Tinta Barroca", o: ["Touriga Nacional", "Tinta Cão", "Touriga Franca"] },
                    { q: "What is the primary contribution of 'Vinha Velha' (old field blend) vineyards to a final Port?", a: "Unparalleled complexity and layers of flavor", o: ["Consistency and predictability", "High yields and efficiency", "Fruity simplicity"] }
                ]
            },
            lawmaker: {
                title: "The Lawmaker's Desk",
                instructions: "Answer 10 multiple-choice questions about the appellation laws and winemaking regulations of Fortified Porto.",
                questions: [
                    { q: "What is the name of the governing body that regulates the production and trade of all Port wine?", a: "Instituto dos Vinhos do Douro e Porto (IVDP)", o: ["Casa do Douro", "Comissão Vitivinícola Regional", "The British Factory House"] },
                    { q: "What is the 'benefício'?", a: "The annual authorization of the quantity of grapes that can be made into Port.", o: ["A tax paid by Port shippers.", "The classification of a vintage.", "A subsidy for organic farming."] },
                    { q: "The fortification of Port must be done with a neutral grape spirit (aguardente) of what minimum strength?", a: "77% ABV", o: ["96% ABV", "50% ABV", "60% ABV"] },
                    { q: "What is the 'cadastro'?", a: "The official registry and classification of all vineyards in the Douro.", o: ["The legal document declaring a vintage.", "The permit to export Port.", "A list of authorized grape varieties."] },
                    { q: "Which of the following is NOT a legal category of Ruby Port?", a: "Aged Ruby", o: ["Ruby", "Ruby Reserva", "Late Bottled Vintage (LBV)"] },
                    { q: "A Tawny Port with an indication of age (10, 20, 30, 40, 50) must state what on the label?", a: "The year of bottling", o: ["The specific vintages in the blend", "The average age of the blend", "The date of fortification"] },
                    { q: "What is a 'Colheita' Port?", a: "A Tawny Port from a single vintage, aged at least 7 years in cask.", o: ["A Ruby Port from a single vintage, aged at least 7 years.", "A blend of multiple vintages.", "An unfiltered LBV Port."] },
                    { q: "A Vintage Port must be bottled between which dates following the harvest?", a: "July 1st of the second year and June 30th of the third year", o: ["January 1st and December 31st of the second year", "Two years and four years", "Four years and six years"] },
                    { q: "What is the key difference between a modern 'Unfiltered' LBV and a traditional LBV?", a: "Unfiltered LBVs are not fined or filtered and will throw a sediment, like a Vintage Port.", o: ["Unfiltered LBVs are aged longer in bottle.", "Unfiltered LBVs use different grape varieties.", "There is no legal difference."] },
                    { q: "What does the term 'Garrafeira' signify on a Port label?", a: "A rare category of single-vintage Port aged in cask then for a long period in glass demijohns ('bonbons').", o: ["A producer's reserve selection.", "A Port intended for cooking.", "A Port made by a cooperative."] },
                    { q: "The decision to 'declare' a vintage is made by whom?", a: "Each individual Port producer", o: ["The IVDP", "The Casa do Douro", "The British government"] },
                    { q: "What is the maximum amount of grape spirit that can be added during fortification?", a: "About 1 part spirit to 4 parts must", o: ["About 1 part spirit to 2 parts must", "As much as is needed to reach 22% ABV", "There is no maximum"] },
                    { q: "A 'Crusted' Port is a blend of high-quality Ruby Ports from several vintages that is bottled unfiltered and aged for how long before release?", a: "At least three years in bottle", o: ["At least two years in cask", "At least five years in bottle", "There is no minimum aging"] },
                    { q: "What is the primary purpose of the 'benefício' system?", a: "To control production and stabilize prices by matching supply with demand.", o: ["To encourage organic viticulture.", "To ensure all Port is of high quality.", "To tax Port producers."] },
                    { q: "The 'Lei do Terço' (Law of the Third) was an early 20th-century law that did what?", a: "It restricted growers to selling only one-third of their production each year.", o: ["It required one-third of all vineyards to be replanted.", "It taxed Port at one-third of its value.", "It mandated that one-third of all Port be aged in Gaia."] },
                    { q: "What is the minimum period a Late Bottled Vintage (LBV) Port must be aged in cask before bottling?", a: "Four years", o: ["Two years", "Seven years", "One year"] },
                    { q: "The IVDP's 'tasting chamber' (Câmara de Provadores) has the final say on what?", a: "Whether a wine meets the quality standards for its designated category.", o: ["The price of Port wine.", "The declaration of a vintage.", "The amount of 'benefício' to be released."] },
                    { q: "What is the name of the traditional shallow, open-topped vessel used for foot-treading grapes?", a: "Lagar", o: ["Pipa", "Balseiro", "Autovinifier"] },
                    { q: "The standard barrel used for aging and shipping Port is called a 'pipa'. What is its approximate size in the Douro?", a: "550 liters", o: ["225 liters", "1,000 liters", "300 liters"] },
                    { q: "What does 'Seco' on a White Port label indicate?", a: "It is dry.", o: ["It is sweet.", "It is from a single vineyard.", "It is unfiltered."] },
                    { q: "Under IVDP rules, fortification must halt the fermentation when the must reaches what approximate level of residual sugar?", a: "6-9% Baumé (approx. 100-150 g/L)", o: ["1-2% Baumé", "15-20% Baumé", "There is no rule."] },
                    { q: "What is the typical final alcohol range for Port wine?", a: "19-22% ABV", o: ["15-17% ABV", "25-30% ABV", "12-14% ABV"] },
                    { q: "For a Port to be labeled 'Reserva' or 'Reserve', it must be:", a: "A superior quality wine approved by the IVDP's tasting panel.", o: ["Aged for a minimum of 7 years.", "From a single vineyard.", "From a vintage that was not generally declared."] },
                    { q: "Which law, passed in 1986, was a major turning point that allowed producers to ship and export their own estate-bottled Port?", a: "The Douro Quintas Law", o: ["The Benefício Act", "The IVDP Charter", "The Gaia Monopoly Repeal"] },
                    { q: "A 20-Year-Old Tawny Port is best described as:", a: "A blend of wines whose average age is approximately 20 years, crafted to a consistent house style.", o: ["A single wine that has been aged for exactly 20 years.", "A wine from a vintage 20 years ago.", "A wine that can age for 20 more years."] },
                    { q: "Which of the following is NOT a legal requirement for Vintage Port?", a: "It must be foot-trodden in lagares.", o: ["It must be from a single, high-quality year.", "It must be approved by the IVDP.", "It must be bottled within a specific timeframe."] },
                    { q: "The term 'Single Quinta Vintage Port' refers to a Vintage Port from a single estate made in a year that was:", a: "Good but not generally 'declared' by the producer as a classic vintage.", o: ["The best vintage of the decade.", "Blended with wine from other estates.", "Aged for an extra period in cask."] },
                    { q: "What is the maximum residual sugar level allowed for a White Port labeled 'Extra Seco'?", a: "40 g/L", o: ["10 g/L", "65 g/L", "100 g/L"] },
                    { q: "The IVDP requires a sample of a potential Vintage Port to be submitted for approval in which year after harvest?", a: "The second year", o: ["The first year", "The third year", "The fifth year"] },
                    { q: "Which body historically represented the interests of the Douro's farmers ('lavradores')?", a: "The Casa do Douro", o: ["The IVDP", "The British Factory House", "The Port Shippers Guild"] },
                    { q: "What does the seal of guarantee from the IVDP on a bottle of Port signify?", a: "That the wine is genuine Port and conforms to all regulations.", o: ["That the wine is a top-quality example.", "That the wine has won an award.", "That the wine is ready to drink."] },
                    { q: "The term 'Vinho ao Roda' refers to a historical practice of what?", a: "Sending casks of wine on long sea voyages to mature them.", o: ["Rotating barrels in the lodge.", "A type of vine pruning.", "A festival celebrating the harvest."] },
                    { q: "What is the minimum required aging for a Rosé Port?", a: "There are no specific aging requirements, it's based on style.", o: ["2 years", "5 years", "6 months"] },
                    { q: "The amount of 'benefício' granted to a vineyard is a calculation based on its score and what other factor?", a: "The total amount of benefício authorized for that year.", o: ["The price of grapes.", "The producer's export volume.", "The age of the vines."] },
                    { q: "What is the legal definition of 'Envelhecido em Garrafa' on an LBV label?", a: "It must have been aged for at least three years in bottle before release.", o: ["It means the wine is unfiltered.", "It means the wine was aged in cask.", "It is a brand name."] },
                    { q: "Which Port category accounts for the largest volume of sales?", a: "Basic Ruby Port", o: ["Vintage Port", "Aged Tawny Port", "LBV Port"] },
                    { q: "What is the purpose of adding the aguardente during fermentation?", a: "To kill the yeasts, stopping fermentation and preserving natural grape sugar.", o: ["To add flavor and color.", "To increase the wine's acidity.", "To clarify the wine."] },
                    { q: "The term 'Shipper' in the context of Port refers to what?", a: "A company that buys grapes or wine, blends, ages, and markets it under their own name.", o: ["The person who physically loads the barrels onto boats.", "A grower who sells grapes to a big house.", "A government inspector."] },
                    { q: "Can a Port be made from 100% white grapes and still be labeled simply as 'Port'?", a: "Yes, but it is typically labeled 'White Port'.", o: ["No, it must be labeled 'Branco'.", "No, Port must be red.", "Only if it is sweet."] },
                    { q: "The regulations for Port production are an example of what kind of appellation system?", a: "One of the most heavily regulated in the world.", o: ["A very relaxed and informal system.", "A system based solely on producer reputation.", "A system with no geographical boundaries."] },
                    { q: "What is the maximum sweetness level for a White Port labeled 'Lágrima'?", a: "It is the sweetest style, with around 130 g/L of sugar.", o: ["It must be completely dry.", "It has the same sweetness as an LBV.", "It is moderately sweet."] },
                    { q: "Legally, where must Tawny Port with an indication of age be bottled?", a: "Anywhere, as long as it's IVDP approved.", o: ["Only in Vila Nova de Gaia.", "Only in the Douro Demarcated Region.", "Only in Portugal."] },
                    { q: "A 'declared' vintage typically occurs how often?", a: "About three times per decade.", o: ["Every year.", "Once a decade.", "Only in years ending in a '7'."] },
                    { q: "What is the legal minimum alcohol content for Port?", a: "19% ABV for most categories", o: ["15% ABV", "17.5% ABV", "There is no minimum."] },
                    { q: "Which Port style is required by law to be filtered before bottling?", a: "Standard LBV", o: ["Vintage Port", "Unfiltered LBV", "Crusted Port"] },
                    { q: "The term 'IVDP' must appear on which part of a Port bottle?", a: "On the guarantee seal over the cork.", o: ["On the front label.", "On the back label.", "Etched into the glass."] },
                    { q: "What did the 1756 demarcation by Pombal create?", a: "The world's first legally protected wine region.", o: ["The first wine cooperative.", "The first international trade treaty for wine.", "The first system of vineyard classification."] },
                    { q: "The addition of 'aguardente' is known as what process?", a: "Fortification or 'beneficiação'", o: ["Chaptalization", "Acidification", "Maceration"] },
                    { q: "What is a 'meio-seco' White Port?", a: "A medium-dry style.", o: ["A very sweet style.", "A dry style.", "A sparkling style."] },
                    { q: "Is it legal to declassify a potential Vintage Port into an LBV or a Single Quinta Vintage Port?", a: "Yes, this is a common practice.", o: ["No, once submitted as Vintage Port, it cannot be changed.", "Only with special permission from the IVDP.", "Only if it is blended with other wines."] }
                ]
            },
            gastronome: {
                title: "The Gastronome's Table",
                instructions: "Answer 10 multiple-choice questions about the cuisine, ingredients, and classic pairings of Fortified Porto. After a correct answer, you may have the option to generate an AI explanation.",
                questions: [
                    { q: "What is considered the most classic, quintessential food pairing for a mature Vintage Port?", a: "Stilton cheese", o: ["Goat cheese", "Fresh fruit", "Spicy sausage"], subjectType: 'wine_pairing', subjectName: 'Vintage Port and Stilton' },
                    { q: "A 20-Year-Old Tawny Port, with its nutty and caramel notes, is a classic match for which type of dessert?", a: "Crème brûlée or almond tart", o: ["Chocolate lava cake", "Lemon meringue pie", "Fresh strawberries"], subjectType: 'wine_pairing', subjectName: 'Tawny Port and Desserts' },
                    { q: "What is the popular modern way to serve a dry or extra-dry White Port?", a: "As a 'Porto Tónico' (Port and Tonic) with a slice of citrus", o: ["Heated with spices", "Mixed with cola", "On its own, very cold"], subjectType: 'beverage', subjectName: 'Port and Tonic' },
                    { q: "The lodges where Port is aged are not in Porto itself, but across the river in which city?", a: "Vila Nova de Gaia", o: ["Matosinhos", "Vila do Conde", "Régua"], subjectType: 'place', subjectName: 'Vila Nova de Gaia' },
                    { q: "What is 'Tripas à Moda do Porto'?", a: "A hearty stew of tripe and white beans, a traditional dish of Porto.", o: ["A type of sweet pastry.", "Grilled sardines.", "A seafood rice dish."], subjectType: 'dish', subjectName: 'Tripas à Moda do Porto' },
                    { q: "Serra da Estrela is a famous, pungent, and creamy Portuguese cheese made from the milk of which animal?", a: "Sheep", o: ["Goat", "Cow", "Water Buffalo"], subjectType: 'ingredient', subjectName: 'Serra da Estrela Cheese' },
                    { q: "A young, fruity Ruby Port is an excellent pairing for what type of cheese?", a: "Cheddar or other hard cow's milk cheeses", o: ["Blue cheese", "Soft goat cheese", "Smoked cheese"], subjectType: 'wine_pairing', subjectName: 'Ruby Port and Cheese' },
                    { q: "The 'Francesinha', a famous sandwich from Porto, is typically drenched in a sauce containing what alcoholic beverage?", a: "Port wine and beer", o: ["Brandy and white wine", "Whisky", "Red wine only"], subjectType: 'dish', subjectName: 'Francesinha' },
                    { q: "What were the traditional boats used to transport Port barrels from the Douro Valley down to Vila Nova de Gaia?", a: "Barcos Rabelos", o: ["Gondolas", "Feluccas", "Vapores"], subjectType: 'place', subjectName: 'Barcos Rabelos' },
                    { q: "What is a classic ingredient to pair with an aged Tawny Port?", a: "Walnuts or pecans", o: ["Olives", "Tomatoes", "Garlic"], subjectType: 'wine_pairing', subjectName: 'Tawny Port and Nuts' },
                    { q: "Which type of Port is most suitable for pairing with dark chocolate desserts?", a: "Late Bottled Vintage (LBV)", o: ["Dry White Port", "10-Year-Old Tawny Port", "Rosé Port"], subjectType: 'wine_pairing', subjectName: 'Port and Chocolate' },
                    { q: "Azeitão is another famous Portuguese cheese, known for its thistle-rennet character. What type of Port pairs well with it?", a: "Tawny Port", o: ["Vintage Port", "White Port", "Ruby Port"], subjectType: 'ingredient', subjectName: 'Azeitão Cheese' },
                    { q: "The English, Scottish, and Irish merchants who founded many Port houses were collectively known as the:", a: "Factory Houses", o: ["Shippers Guild", "Gaia Gentry", "Douro Barons"], subjectType: 'historian', subjectName: 'The British Factory Houses' },
                    { q: "What is the ideal serving temperature for a Vintage Port?", a: "16-18°C (61-64°F)", o: ["Ice cold", "Room temperature (~22°C/72°F)", "Warm"], subjectType: 'wine_style', subjectName: 'Serving Vintage Port' },
                    { q: "Why does the high salt content in Stilton cheese make it a great pairing for the sweetness of Vintage Port?", a: "The salt contrasts with and accentuates the fruit and sweetness of the Port.", o: ["The salt cancels out the sweetness.", "The salt matches the tannin in the Port.", "There is no gastronomic reason."], subjectType: 'wine_pairing', subjectName: 'Vintage Port and Stilton' },
                    { q: "Which of these is a traditional almond-based confectionary from the Douro region often served with Port?", a: "Toucinho do Céu", o: ["Pastel de Nata", "Tiramisu", "Churros"], subjectType: 'dish', subjectName: 'Toucinho do Céu' },
                    { q: "A chilled Tawny Port can be a surprisingly good pairing for what savory dish?", a: "Foie gras or pâté", o: ["Spicy curry", "Grilled steak", "Oysters"], subjectType: 'wine_pairing', subjectName: 'Tawny Port and Foie Gras' },
                    { q: "Why is it important to decant a Vintage or Crusted Port before serving?", a: "To separate the wine from its natural sediment.", o: ["To chill the wine quickly.", "To increase its alcohol content.", "It is not important."], subjectType: 'wine_style', subjectName: 'Decanting Port' },
                    { q: "The cuisine of the Douro valley itself (as opposed to Porto) is best described as:", a: "Rustic, hearty, and based on grilled meats and stews.", o: ["Light, delicate, and based on seafood.", "Spicy and influenced by Asian cuisine.", "Modern and molecular."], subjectType: 'gastronomy', subjectName: 'Douro Valley Cuisine' },
                    { q: "What does the term 'decanting' refer to?", a: "Carefully pouring wine from its bottle into another container.", o: ["Opening a bottle of wine.", "Chilling a bottle of wine.", "Aging a bottle of wine."] },
                    { q: "Which type of Port would be most appropriate to serve as an aperitif?", a: "Dry White Port", o: ["Vintage Port", "40-Year-Old Tawny", "LBV"] },
                    { q: "The 'roasting' of nuts or coffee beans brings out flavors that are complementary to which style of Port?", a: "Aged Tawny Port", o: ["Ruby Port", "Rosé Port", "Vintage Port"] },
                    { q: "What is 'Caldo Verde'?", a: "A traditional Portuguese soup made with potatoes, kale, and sausage.", o: ["A type of green wine.", "A spicy sauce.", "A seafood stew."], subjectType: 'dish', subjectName: 'Caldo Verde' },
                    { q: "The practice of aging Port in the cooler, more humid maritime climate of Vila Nova de Gaia has what effect on the wine?", a: "It allows for a slow, gentle maturation without excessive evaporation.", o: ["It makes the wine age much faster.", "It adds a salty flavor to the wine.", "It has no effect on the wine."] },
                    { q: "Which of these is NOT a traditional food from the Porto region?", a: "Paella", o: ["Bacalhau (salt cod)", "Sardinhas Assadas (grilled sardines)", "Broa de Avintes (a type of cornbread)"] },
                    { q: "A Rosé Port is best served:", a: "Chilled, as an aperitif or with light summer fruit.", o: ["At room temperature with steak.", "Warm with spices.", "With blue cheese."] },
                    { q: "The oxidative, nutty character of Amontillado Sherry is most similar to which style of Port?", a: "Aged Tawny", o: ["Vintage", "Ruby", "White"] },
                    { q: "What is the 'Vindima'?", a: "The annual grape harvest festival in the Douro.", o: ["A legal document.", "A type of barrel.", "A style of Port."] },
                    { q: "The pairing principle at play with Tawny Port and Crème brûlée is:", a: "Complementary, matching caramel flavors and creamy textures.", o: ["Contrasting, with acid cutting fat.", "Aromatic echo of herbs.", "No principle applies."] },
                    { q: "What is a 'cofradia' or confraria?", a: "A brotherhood or guild, like the Confraria do Vinho do Porto, dedicated to upholding the traditions of Port.", o: ["A cooperative winery.", "A vineyard worker.", "A type of tax."] },
                    { q: "Which Port style should be consumed within a day or two of opening?", a: "Vintage Port", o: ["Tawny Port", "Basic Ruby Port", "White Port"] },
                    { q: "Which Port style can last for several weeks after opening if kept refrigerated?", a: "Tawny Port", o: ["Vintage Port", "Crusted Port", "Unfiltered LBV"] },
                    { q: "The historical British preference for Port is directly linked to which political event?", a: "Trade wars with France in the 17th and 18th centuries.", o: ["The Napoleonic Wars.", "The American Revolution.", "World War I."] },
                    { q: "What is 'Bacalhau à Gomes de Sá'?", a: "A famous casserole of salt cod, potatoes, onions, and eggs from Porto.", o: ["A type of sausage.", "A sweet dessert.", "A bread soup."], subjectType: 'dish', subjectName: 'Bacalhau à Gomes de Sá' },
                    { q: "Which of these is a key flavor note in a classic 20-Year-Old Tawny?", a: "Orange peel and almonds", o: ["Blackcurrant and violet", "Strawberry and cherry", "Lemon and grapefruit"] },
                    { q: "The powerful tannins in a young Vintage Port are softened by what component in blue cheese?", a: "Fat and protein", o: ["Salt", "Acidity", "Sugar"] },
                    { q: "What is 'Queijo de Cabra Transmontano'?", a: "A goat cheese from the region behind the Douro, often served with Port.", o: ["A type of sausage.", "A bean stew.", "A seafood dish."], subjectType: 'ingredient', subjectName: 'Queijo de Cabra Transmontano' },
                    { q: "What is the 'St. George's Day' feast in the Factory House famous for?", a: "A lavish celebration of British-Portuguese relations and Port.", o: ["The declaration of the vintage.", "The blessing of the harvest.", "A charity auction."] },
                    { q: "Which Port style is often used in cooking, for example in sauces for red meat?", a: "Basic Ruby Port", o: ["Vintage Port", "40-Year-Old Tawny", "Dry White Port"] },
                    { q: "What is a 'Pastel de Nata'?", a: "A famous Portuguese egg custard tart.", o: ["A savory pie.", "A type of bread.", "A cheese puff."], subjectType: 'dish', subjectName: 'Pastel de Nata' },
                    { q: "Why are the lodges in Gaia built with thick granite walls and oriented to the north?", a: "To maintain a cool and stable temperature for aging wine.", o: ["For defensive purposes.", "For aesthetic reasons.", "To maximize sunlight."] },
                    { q: "The term 'oenotourism' refers to what?", a: "Wine tourism, a major industry in the Douro Valley and Gaia.", o: ["The scientific study of wine.", "A type of wine fault.", "A legal designation."] },
                    { q: "What is the role of the 'cellar master' or 'master blender' in a Port house?", a: "To maintain the consistent house style of blended Ports like Tawnies and Rubies.", o: ["To manage the vineyard.", "To handle sales and marketing.", "To command the barcos rabelos."] },
                    { q: "A simple pairing for a Ruby Port could be:", a: "A piece of dark chocolate.", o: ["A slice of lemon.", "An olive.", "A raw onion."] },
                    { q: "The tradition of passing the Port decanter to the left and not stopping its journey around the table originated from where?", a: "British naval and regimental dining etiquette.", o: ["Ancient Roman rituals.", "Portuguese peasant traditions.", "A law passed by the IVDP."] },
                    { q: "What is a 'copita'?", a: "A traditional, tulip-shaped glass used for tasting Port and Sherry.", o: ["A small plate of food.", "A type of barrel.", "A vineyard tool."] },
                    { q: "Which of these is NOT a classic pairing with Tawny Port?", a: "Spicy Mexican food", o: ["Apple pie", "Dried figs", "Pecans"] },
                    { q: "The 'Englishman's drink' is a historical nickname for which wine?", a: "Port", o: ["Sherry", "Madeira", "Claret"] },
                    { q: "What is 'Presunto'?", a: "A type of Portuguese dry-cured ham, similar to prosciutto.", o: ["Cheese", "Sausage", "Bread"], subjectType: 'ingredient', subjectName: 'Presunto' },
                    { q: "Which Port is most likely to be served slightly chilled?", a: "Tawny Port", o: ["Vintage Port", "Crusted Port", "Unfiltered LBV"] }
                ]
            },
            critic: {
                title: "The Critic's Corner",
                instructions: "Answer 10 multiple-choice questions about the vintages, producers, and market context of Fortified Porto. After a correct answer, you may have the option to generate an AI tasting note.",
                questions: [
                    { q: "Which producer is known for its powerful, structured, and long-lived Vintage Ports, often considered the most 'masculine' or austere style?", a: "Taylor Fladgate", o: ["Graham's", "Fonseca", "Warre's"], subjectType: 'producer', subjectName: 'Taylor Fladgate' },
                    { q: "Which 20th-century vintage is almost universally regarded as legendary and one of the greatest of all time?", a: "1963", o: ["1985", "1955", "1970"], subjectType: 'vintage', subjectName: '1963 Port Vintage' },
                    { q: "Quinta do Noval is famous for its 'Nacional', a Vintage Port made from a small parcel of what?", a: "Ungrafted, pre-phylloxera vines", o: ["A single grape variety", "The oldest vines in the Douro", "Vines owned by the nation of Portugal"], subjectType: 'wine', subjectName: 'Quinta do Noval Nacional' },
                    { q: "Which Port house, known for a rich, sweet, and opulent style, is part of the Symington Family Estates portfolio?", a: "Graham's", o: ["Taylor Fladgate", "Fonseca", "Niepoort"], subjectType: 'producer', subjectName: "Graham's" },
                    { q: "The 2011 vintage was widely and generally declared, and is characterized by what quality?", a: "Exceptional power, purity of fruit, and tannic structure", o: ["Lightness and elegance for early drinking", "High acidity and savory notes", "A very hot, raisined character"], subjectType: 'vintage', subjectName: '2011 Port Vintage' },
                    { q: "Fonseca, known for its lush, hedonistic, and fruit-forward style, is the sister company to which other major house?", a: "Taylor Fladgate", o: ["Graham's", "Dow's", "Warre's"], subjectType: 'producer', subjectName: 'Fonseca' },
                    { q: "Which two recent, back-to-back vintages were both generally declared, a rare occurrence?", a: "2016 and 2017", o: ["2007 and 2008", "2000 and 2001", "2010 and 2011"], subjectType: 'vintage', subjectName: '2016 & 2017 Port Vintages' },
                    { q: "Which Symington-owned house is known for a drier, more aromatic, and elegant style of Vintage Port?", a: "Dow's", o: ["Graham's", "Cockburn's", "Warre's"], subjectType: 'producer', subjectName: "Dow's" },
                    { q: "What is the name of Taylor Fladgate's famous single quinta, which often produces a wine in 'off' vintages?", a: "Quinta de Vargellas", o: ["Quinta do Bomfim", "Quinta da Roêda", "Quinta dos Malvedos"], subjectType: 'producer', subjectName: 'Quinta de Vargellas' },
                    { q: "Which producer is known for being a pioneer in both Douro DOC table wines and innovative Port styles like Rosé Port?", a: "Niepoort", o: ["Taylor Fladgate", "Symington Family Estates", "The Fladgate Partnership"], subjectType: 'producer', subjectName: 'Niepoort' },
                    { q: "The 1994 vintage is considered another modern benchmark, known for what characteristics?", a: "Balance, intense fruit, and firm structure for long aging", o: ["A very light and approachable style", "A hot and overripe character", "Being universally undeclared"], subjectType: 'vintage', subjectName: '1994 Port Vintage' },
                    { q: "The Fladgate Partnership is a major Port conglomerate that owns which of the following brands?", a: "Taylor Fladgate, Fonseca, Croft, and Krohn", o: ["Graham's, Dow's, and Warre's", "Sandeman, Ferreira, and Offley", "Quinta do Noval and Ramos Pinto"], subjectType: 'producer', subjectName: 'The Fladgate Partnership' },
                    { q: "What is the single quinta associated with Graham's?", a: "Quinta dos Malvedos", o: ["Quinta de Vargellas", "Quinta do Bomfim", "Quinta do Panascal"], subjectType: 'producer', subjectName: "Quinta dos Malvedos" },
                    { q: "The 1977 vintage is famous for its combination of power and elegance, but what was a key feature of its growing season?", a: "A cool spring leading to a late harvest.", o: ["A very hot and dry summer.", "Heavy rains during harvest.", "A mild and uneventful season."], subjectType: 'vintage', subjectName: '1977 Port Vintage' },
                    { q: "Which house is particularly renowned for its expertise in aged Tawny Ports?", a: "Taylor Fladgate", o: ["Fonseca", "Dow's", "Graham's"], subjectType: 'producer', subjectName: 'Taylor Fladgate' },
                    { q: "What is the single quinta associated with Dow's?", a: "Quinta do Bomfim", o: ["Quinta de Vargellas", "Quinta dos Malvedos", "Quinta da Roêda"], subjectType: 'producer', subjectName: "Quinta do Bomfim" },
                    { q: "The 2017 vintage was noted for what climatic conditions?", a: "Intense heat and drought throughout the season", o: ["A cool, wet summer", "A perfectly balanced, mild season", "Heavy hail storms"], subjectType: 'vintage', subjectName: '2017 Port Vintage' },
                    { q: "Which major producer is not owned by either the Symingtons or The Fladgate Partnership?", a: "Quinta do Noval", o: ["Graham's", "Fonseca", "Dow's"], subjectType: 'producer', subjectName: 'Quinta do Noval' },
                    { q: "Which house is credited with inventing the Late Bottled Vintage (LBV) style?", a: "Taylor Fladgate", o: ["Graham's", "Fonseca", "Sandeman"], subjectType: 'producer', subjectName: 'Taylor Fladgate' },
                    { q: "The 1970 vintage is known for being:", a: "A classically balanced and harmonious vintage, elegant and long-lived.", o: ["A powerhouse vintage with massive tannins.", "A light vintage for early drinking.", "A universally poor vintage."], subjectType: 'vintage', subjectName: '1970 Port Vintage' },
                    { q: "What is the single quinta for Warre's?", a: "Quinta da Cavadinha", o: ["Quinta de Vargellas", "Quinta do Bomfim", "Quinta dos Malvedos"] },
                    { q: "Which producer is known for pioneering the concept of a Single Quinta Vintage Port with their Quinta de Vargellas?", a: "Taylor Fladgate", o: ["Graham's", "Dow's", "Fonseca"] },
                    { q: "The 2003 vintage was generally declared but is known for what characteristic due to a heatwave?", a: "Very ripe, powerful, and sometimes 'roasted' fruit flavors.", o: ["High acidity and lean structure.", "Delicate floral aromatics.", "A very light color."] },
                    { q: "Which producer's house style is often seen as the quintessential balance of power and elegance in the Symington portfolio?", a: "Warre's", o: ["Graham's", "Dow's", "Cockburn's"] },
                    { q: "Ferreira is a historic Port house particularly famous in which market?", a: "Portugal", o: ["The United Kingdom", "The United States", "Brazil"] },
                    { q: "The 1985 vintage is known for being:", a: "Forward, charming, and more approachable in its youth than other great vintages.", o: ["Extremely tannic and backward.", "Light and diluted.", "Universally panned by critics."] },
                    { q: "Which of these is NOT a Symington-owned brand?", a: "Fonseca", o: ["Graham's", "Dow's", "Warre's"] },
                    { q: "Who is the legendary winemaker and former managing director of Quinta do Noval, famous for his 're-corking clinics'?", a: "Christian Seely", o: ["Dirk Niepoort", "David Guimaraens", "Paul Symington"] },
                    { q: "The 2007 vintage is often compared to the 1970 vintage for what quality?", a: "Its balance, elegance, and aromatic complexity.", o: ["Its raw power and concentration.", "Its early-drinking nature.", "Its poor quality."] },
                    { q: "Which producer makes a famous organic Vintage Port called 'Terra Prima'?", a: "Fonseca", o: ["Taylor Fladgate", "Dow's", "Niepoort"] },
                    { q: "Which vintage was small in quantity but high in quality, leading to powerful, concentrated wines?", a: "2000", o: ["1997", "2001", "1992"] },
                    { q: "What is the name of the single quinta for Fonseca?", a: "Quinta do Panascal", o: ["Quinta de Vargellas", "Quinta do Bomfim", "Quinta dos Malvedos"] },
                    { q: "Which producer is known for aging some of its Tawny Ports in the Douro Valley itself, rather than Gaia?", a: "Niepoort", o: ["Taylor Fladgate", "Graham's", "Dow's"] },
                    { q: "The 1997 vintage is generally characterized as:", a: "Elegant, aromatic, and approachable.", o: ["Tannic, powerful, and backward.", "Hot and overripe.", "A washout."] },
                    { q: "Which Port house is known for its iconic 'Don' logo?", a: "Sandeman", o: ["Ferreira", "Croft", "Cockburn's"] },
                    { q: "The market trend for Port over the last two decades has seen a decline in basic styles and a rise in what?", a: "Premium categories like Aged Tawny, LBV, and Vintage.", o: ["White Port sales.", "Bulk Port sales.", "Rosé Port sales."] },
                    { q: "Which of these vintages was very difficult due to rain and generally not declared?", a: "1995", o: ["1994", "1992", "1997"] },
                    { q: "The 'Symington Family Estates' is the largest landowner in the Douro. Which brand is NOT part of their portfolio?", a: "Ferreira", o: ["Graham's", "Dow's", "Cockburn's"] },
                    { q: "Which vintage, from a legendary year for all of Europe, produced famously long-lived and sought-after Ports?", a: "1945", o: ["1950", "1960", "1940"] },
                    { q: "Who is the head winemaker for The Fladgate Partnership, overseeing Taylor's, Fonseca, and Croft?", a: "David Guimaraens", o: ["Charles Symington", "Dirk Niepoort", "Christian Seely"] },
                    { q: "What is the single quinta of Croft?", a: "Quinta da Roêda", o: ["Quinta de Vargellas", "Quinta do Bomfim", "Quinta dos Malvedos"] },
                    { q: "The 1992 vintage is generally considered:", a: "A very good to excellent 'split' vintage, where some declared but not all.", o: ["A universally declared, legendary vintage.", "A complete failure.", "A light and early-drinking vintage."] },
                    { q: "Which house is famous for its very dry style of Aged Tawny, often with a pronounced 'vinagrinho' (volatile acidity) note?", a: "Niepoort", o: ["Taylor Fladgate", "Graham's", "Dow's"] },
                    { q: "Which was the last universally declared vintage of the 20th century?", a: "1994", o: ["1997", "2000", "1999"] },
                    { q: "The term 'house style' is most relevant for which category of Port?", a: "Non-vintage blended Ports like Tawnies and Rubies", o: ["Vintage Port", "Single Quinta Vintage Port", "Colheita Port"] },
                    { q: "Which producer is known for its 'Midnight' bottling, a Port designed for mixing in cocktails?", a: "Dow's", o: ["Taylor Fladgate", "Fonseca", "Graham's"] },
                    { q: "The 1983 vintage is best described as:", a: "A good, solid vintage that has aged well, though not a blockbuster.", o: ["A legendary, top-tier vintage.", "A very weak, rainy vintage.", "A hot, overripe vintage."] },
                    { q: "The 'Big 3' Port producers in terms of market influence are often considered to be The Fladgate Partnership, Symington Family Estates, and who?", a: "Quinta do Noval", o: ["Niepoort", "Sandeman", "Ramos Pinto"] },
                    { q: "Which vintage was the first to be generally declared after the legendary 1977?", a: "1985", o: ["1980", "1983", "1982"] },
                    { q: "Which producer owns the historic brand Cockburn's, famous for its 'Special Reserve'?", a: "Symington Family Estates", o: ["The Fladgate Partnership", "Sogrape", "AXA Millésimes"] }
                ]
            },
        };

        // This new object contains comprehensive flashcard data, separate from the quiz questions
        const flashcardData = {
            historian: [
                { q: "What year was the Methuen Treaty signed, creating favorable trade for Portuguese wines in England?", a: "1703" },
                { q: "Who was the powerful Portuguese statesman who founded the Douro Wine Company (C.G.A.V.A.D.)?", a: "The Marquis of Pombal" },
                { q: "In what year did the Marquis of Pombal establish the Douro as the world's first demarcated and regulated wine region?", a: "1756" },
                { q: "What are the 'marcos de feitoria'?", a: "The 335 granite pillars erected in 1761 to physically mark the boundaries of the best vineyard areas." },
                { q: "What is the Factory House in Porto?", a: "Completed in 1790, it is the Palladian-style building that served as the headquarters for the British Port shippers." },
                { q: "What was the significance of the Peninsular War (1807-1814) for the Port trade?", a: "It caused major disruption, invasion, and the sacking of lodges, but ultimately solidified the British-Portuguese alliance." },
                { q: "When was the devastating pest phylloxera first identified in the Douro?", a: "1868" },
                { q: "Who was Dona Antónia Adelaide Ferreira, known as 'A Ferreirinha'?", a: "A 19th-century Portuguese matriarch who became one of the most powerful and respected figures in the Douro, building a vast vineyard empire." },
                { q: "What was the 'Lei do Terço' or 'Law of the Third'?", a: "A 1907 law that restricted growers to selling only one-third of their production annually to prevent price collapses." },
                { q: "What is the Casa do Douro, founded in 1932?", a: "The official body representing the Douro's grape growers ('lavradores')." },
                { q: "When was the Instituto do Vinho do Porto (IVP) established to regulate the entire trade?", a: "1933" },
                { q: "Which house launched the first commercial Late Bottled Vintage (LBV) Port from the 1965 vintage?", a: "Taylor Fladgate (launched in 1970)" },
                { q: "What major regulatory change occurred in 1986?", a: "Portugal joined the EEC (now EU), and legislation was passed allowing Douro quintas to bottle and export their own Port." },
                { q: "What is the modern governing body for both Port and Douro DOC wines, formed in 2003?", a: "The IVDP (Instituto dos Vinhos do Douro e Porto)." },
                { q: "What were the 'Barcos Rabelos'?", a: "Traditional flat-bottomed boats used to transport barrels of new Port wine down the treacherous Douro River to the lodges in Gaia." },
                { q: "Why was Vila Nova de Gaia chosen as the site for aging Port?", a: "Its moderate, humid coastal climate was ideal for the slow maturation of the wine in barrel." },
                { q: "Who was Baron de Forrester?", a: "A prominent 19th-century figure in the Port trade who controversially argued against the use of fortification and elderberry for color." },
                { q: "What was the original purpose of fortifying wine with brandy?", a: "To stabilize the wine and ensure it survived the long sea journey to England without spoiling." },
                { q: "The term 'Shipper' originally referred to what?", a: "The merchants (often British) based in Porto who blended, aged, and 'shipped' the final product." },
                { q: "What event led to the decline of the 'Barcos Rabelos'?", a: "The construction of dams along the Douro River in the 1950s and 60s, which made the river navigable for larger ships and trucks more efficient." },
                { q: "The historical conflict between the Douro growers and the Gaia shippers was primarily over what?", a: "Price and control of the trade." },
                { q: "What was the significance of the 1974 Carnation Revolution in Portugal?", a: "It ended the dictatorship and led to land reforms in the Douro, though many were later reversed." },
                { q: "When was the first bridge between Porto and Gaia, the Ponte das Barcas, built?", a: "1806" },
                { q: "The term 'Port' is a protected designation of origin. What does this mean?", a: "Legally, only fortified wine from the Douro that follows IVDP rules can be called Port." },
                { q: "What was the primary market for Port throughout its history?", a: "The United Kingdom" },
                { q: "What was the role of the Douro Wine Company in the 18th century?", a: "It held a state-sanctioned monopoly, classifying vineyards and regulating quality and prices to combat fraud." },
                { q: "What impact did the arrival of the railway in the Douro in 1887 have?", a: "It provided a faster and safer alternative to the river for transporting wine and people." },
                { q: "Which family is one of the most influential in the modern Port trade, owning Dow's, Graham's, and Warre's?", a: "The Symington family" },
                { q: "Which family group owns Taylor's, Fonseca, and Croft?", a: "The Fladgate Partnership" },
                { q: "What was the historical importance of the city of Porto itself?", a: "It was the commercial hub and port from which the wine was exported, giving the wine its name." },
                { q: "What was 'jeropiga'?", a: "A sweet, often low-quality mixture of grape must and brandy, sometimes used illegally to sweeten or color wines." },
                { q: "How did phylloxera change the Douro vineyards?", a: "It forced the replanting of nearly all vineyards onto American rootstock." },
                { q: "What was the traditional currency for trading Port?", a: "The British Pound Sterling" },
                { q: "Who invented the 'autovinifier', a system of automated pump-overs, in the 1960s?", a: "The house of Ramos Pinto" },
                { q: "The first English 'factory' or trading post was established in Viana do Castelo in what year?", a: "1654" },
                { q: "What is the Confraria do Vinho do Porto?", a: "A 'brotherhood' of Port enthusiasts and key industry figures dedicated to promoting and defending the image of Port wine." },
                { q: "What decade saw the rise of the Single Quinta Vintage Port as a major category?", a: "The 1970s and 1980s" },
                { q: "What was the significance of the 1820 Liberal Revolution in Portugal?", a: "It challenged the old order and monopolies, contributing to the eventual decline of the Douro Wine Company's power." },
                { q: "What is the name of the iconic double-deck metal arch bridge connecting Porto and Gaia, designed by a student of Gustave Eiffel?", a: "Dom Luís I Bridge" },
                { q: "The term 'lavrador' refers to what?", a: "A farmer or grape-grower in the Douro." },
                { q: "What was the 'Entreposto'?", a: "The designated commercial area in Vila Nova de Gaia where all Port had to be stored, aged, and traded." },
                { q: "Which war solidified Britain's dependence on Portuguese wine over French claret?", a: "The War of the Spanish Succession (early 1700s)." },
                { q: "What was the original English name for the Douro Wine Company?", a: "The General Company for the Agriculture of the Vineyards of the Upper Douro." },
                { q: "Which century is often called the 'golden age' of Port?", a: "The 18th century" },
                { q: "What was the traditional unit of volume for Port sales?", a: "The 'pipa' or pipe (approximately 550 liters)." },
                { q: "What event in the 1930s caused a global collapse in demand for Port?", a: "The Great Depression" },
                { q: "When did the first Symington, Andrew James, arrive in Portugal?", a: "1882" },
                { q: "What is the oldest British Port house still in family ownership?", a: "Warre's (founded 1670)" },
                { q: "What is the oldest Port house overall?", a: "Croft (founded 1588)" },
                { q: "When was the first Rosé Port launched by Poças and Croft?", a: "2008" }
            ],
            terroir: [
                { q: "What is the dominant soil type of the Douro Valley?", a: "Schist (a slate-like metamorphic rock)." },
                { q: "Which mountain range to the west of the region creates a critical rain shadow?", a: "The Serra do Marão" },
                { q: "Name the three official sub-regions of the Douro, from west to east.", a: "Baixo Corgo, Cima Corgo, Douro Superior" },
                { q: "Which sub-region is the wettest and coolest, producing lighter Ports?", a: "Baixo Corgo" },
                { q: "Which sub-region is considered the heartland for high-quality Port, especially Vintage Port?", a: "Cima Corgo" },
                { q: "Which sub-region is the hottest, driest, and most sparsely planted?", a: "Douro Superior" },
                { q: "What are 'socalcos'?", a: "The ancient, narrow, stone-walled terraces built by hand." },
                { q: "What are 'patamares'?", a: "Wider, machine-built terraces that do not have stone walls, allowing for mechanization." },
                { q: "What is 'Vinha ao Alto'?", a: "A modern planting method where vines are planted in vertical rows directly up the slope." },
                { q: "What is the 'cadastro'?", a: "The official vineyard registry and classification system, which rates vineyards from A (best) to F." },
                { q: "How many criteria are used to determine a vineyard's 'cadastro' rating?", a: "12 (including location, altitude, slope, soil, varieties, vine age, etc.)." },
                { q: "The climate of the Douro is broadly classified as what?", a: "Continental, with very hot, dry summers and cold winters." },
                { q: "What is the name of the river that defines the region?", a: "The Douro River (Duero in Spain)." },
                { q: "What is the primary viticultural benefit of schist soil?", a: "It is friable and fractures vertically, allowing roots to access deep water reserves, and it retains and radiates heat." },
                { q: "What is the primary soil type just outside the demarcated region?", a: "Granite, which is generally less suitable for high-quality Port." },
                { q: "A Class 'A' vineyard must score over how many points in the 'cadastro'?", a: "1200 points." },
                { q: "The city where Port lodges are located, Vila Nova de Gaia, has what type of climate?", a: "A moderate, maritime climate due to its proximity to the Atlantic." },
                { q: "What is the average annual rainfall in the Douro Superior?", a: "Approximately 400mm." },
                { q: "What is the average annual rainfall in the Baixo Corgo?", a: "Approximately 900mm." },
                { q: "The best vineyard exposures are typically oriented in which direction to maximize sun?", a: "South-facing." },
                { q: "What is the highest possible 'cadastro' score a vineyard can achieve?", a: "Over 2000 points (though extremely rare)." },
                { q: "What is the primary viticultural challenge across the entire Douro region?", a: "Lack of water/drought." },
                { q: "What is the name of the main city within the Cima Corgo?", a: "Pinhão." },
                { q: "What is the name of the main city within the Baixo Corgo?", a: "Peso da Régua (often just called Régua)." },
                { q: "What is the term for the Douro's unique, man-made vineyard landscape?", a: "The cultural landscape, recognized as a UNESCO World Heritage Site." },
                { q: "How does slope (gradient) affect a vineyard's 'cadastro' score?", a: "Steeper slopes score more points, up to a certain degree." },
                { q: "Why is altitude a critical factor in Douro terroir?", a: "Higher altitudes result in cooler temperatures, higher acidity, and fresher aromatic profiles." },
                { q: "The Douro is one of the world's most mountainous wine regions. What percentage of the land has a slope of over 30%?", a: "Over 60%." },
                { q: "What does the term 'quinta' mean?", a: "A farm or estate." },
                { q: "What is the bedrock geology of the region?", a: "The 'Grauvakian Schist Complex,' dating to the Precambrian and Paleozoic eras." },
                { q: "Which tributary of the Douro is particularly famous for its high concentration of top quintas?", a: "The Pinhão River." },
                { q: "What is the maximum permitted yield for grapes destined for Port?", a: "55 hectoliters per hectare (hl/ha)." },
                { q: "What is the minimum planting density?", a: "3,000 vines per hectare." },
                { q: "Irrigation is generally forbidden, but what is the exception?", a: "Emergency irrigation ('rega de socorro') can be authorized by the IVDP in extreme drought." },
                { q: "What is the primary risk of the 'patamares' system?", a: "Increased soil erosion compared to the traditional 'socalcos'." },
                { q: "The eastern boundary of the Cima Corgo is marked by what geographical feature?", a: "The Cachão da Valeira, a narrow gorge." },
                { q: "What is the approximate length of the Douro River within Portugal?", a: "210 kilometers." },
                { q: "What is the typical diurnal range (difference between day and night temperature) in the Douro Superior during summer?", a: "Very large (e.g., 35°C day, 15°C night)." },
                { q: "How does the 'Vinha ao Alto' system compare to terraces for water management?", a: "It can lead to faster water runoff and erosion if not managed properly." },
                { q: "What is the name of the hot, dry wind that can sometimes blow from the east (from Spain)?", a: "The Iberian high pressure system." },
                { q: "The soil is very poor in which key nutrient, naturally limiting vine vigor?", a: "Organic matter." },
                { q: "The color of the schist soil is typically what?", a: "Dark brown to grey." },
                { q: "Which sub-region has the largest area under vine?", a: "Cima Corgo." },
                { q: "What is the primary viticultural risk in the Baixo Corgo compared to the other sub-regions?", a: "Fungal diseases like mildew, due to higher humidity and rainfall." },
                { q: "What is the approximate altitude range for vineyards in the Douro?", a: "From 40 meters to over 600 meters." },
                { q: "The term 'feitoria' was used by Pombal to designate what?", a: "The inner circle of the finest land, whose wines were destined for the English export market." },
                { q: "The 'ramo' was the area outside the feitoria whose wines were destined for where?", a: "The Brazilian market and domestic consumption." },
                { q: "What is the main advantage of the 'Vinha ao Alto' planting system?", a: "It allows for much higher planting densities." },
                { q: "What is the general trend for new plantings in the Douro Superior?", a: "They are often at higher altitudes to combat rising temperatures." },
                { q: "The Douro has more than half of Portugal's total area of what type of viticulture?", a: "Mountain viticulture." }
            ],
            ampelographer: [
                { q: "What are the five most widely planted and 'officially recommended' red grape varieties for Port?", a: "Touriga Nacional, Touriga Franca, Tinta Roriz, Tinta Barroca, and Tinta Cão." },
                { q: "Which grape is considered the 'king' of the Douro, providing structure, color, and intense floral (violet) aromatics, but suffers from very low yields?", a: "Touriga Nacional" },
                { q: "Which grape is the most widely planted, valued for its reliability, aromatic complexity (wild flowers, blackberry), and structural role in blends?", a: "Touriga Franca" },
                { q: "Tinta Roriz is the Portuguese synonym for which famous grape?", a: "Tempranillo" },
                { q: "Which grape provides high sugar (and thus alcohol) and a soft, jammy character, but can struggle in extreme heat?", a: "Tinta Barroca" },
                { q: "Which grape, meaning 'Red Dog', provides high acidity and peppery spice, adding longevity and finesse to a blend?", a: "Tinta Cão" },
                { q: "What is a 'Vinha Velha'?", a: "An old vineyard planted with a mix of many different, often unidentified, grape varieties (a field blend)." },
                { q: "What is the primary contribution of a 'Vinha Velha' to a blend?", a: "Exceptional complexity and a unique character that cannot be replicated with single-varietal plots." },
                { q: "Which red grape is known as a 'teinturier' for its intense color and is also prized for its high acidity?", a: "Sousão" },
                { q: "Name two of the most important white grape varieties for quality White Port.", a: "Gouveio and Malvasia Fina (also Viosinho, Rabigato)." },
                { q: "Gouveio is a synonym for which Spanish grape variety?", a: "Godello" },
                { q: "Malvasia Fina is prized in White Port for what characteristic?", a: "Its aromatic qualities, providing notes of nutmeg and molasses with age." },
                { q: "What is the primary role of Tinta Roriz in a Port blend?", a: "It adds body, structure, and flavors of red fruit." },
                { q: "What is the parentage of Touriga Franca?", a: "A cross between Touriga Nacional and Mourisco Tinto." },
                { q: "What is the main viticultural weakness of Touriga Nacional?", a: "Coulure (poor fruit set), which leads to very low yields." },
                { q: "Which of the 'top 5' red grapes is generally the first to be harvested?", a: "Tinta Barroca" },
                { q: "What does the term 'field blend' mean?", a: "Multiple grape varieties are planted, harvested, and usually fermented together." },
                { q: "Rabigato is a white grape whose name means 'cat's tail'. What is its main contribution to a blend?", a: "High acidity." },
                { q: "Viosinho is a low-yielding white grape that is gaining popularity for what reason?", a: "It provides both good acidity and body, adding structure and aging potential to white blends." },
                { q: "Tinta Amarela is the same grape as what?", a: "Trincadeira" },
                { q: "What is the main difficulty in growing Tinta Amarela?", a: "It is highly susceptible to rot." },
                { q: "The practice of planting single-variety blocks ('talhões') allows for what advantage?", a: "Producers can harvest each variety at its optimal ripeness." },
                { q: "Bastardo is the Portuguese name for which French grape?", a: "Trousseau (from the Jura)." },
                { q: "Approximately how many grape varieties are authorized for Port production?", a: "Over 80" },
                { q: "Which of the top 5 grapes is known for being the most resistant to fungal diseases?", a: "Touriga Franca" },
                { q: "Which of the top 5 grapes has the thickest skins?", a: "Touriga Nacional" },
                { q: "Which grape provides a characteristic note of dark chocolate to a blend?", a: "Tinta Barroca" },
                { q: "Which white grape variety is the most widely planted in the Douro?", a: "Malvasia Fina" },
                { q: "What is the main reason clonal selection has been slow to take hold in the Douro?", a: "The immense genetic diversity within the old vineyards is considered a priceless asset." },
                { q: "What is 'massal selection'?", a: "Propagating new vineyards with cuttings from numerous superior old vines to maintain genetic diversity." },
                { q: "Which grape is known for its upright growth habit, making it relatively easy to manage?", a: "Tinta Barroca" },
                { q: "The five 'recommended' red varieties were identified as superior after extensive research in which decade?", a: "The 1970s" },
                { q: "Codega do Larinho is a white grape that typically produces wines that are high in alcohol and low in what?", a: "Acidity" },
                { q: "Which grape is known for its long bunches and resilience in the vineyard?", a: "Touriga Franca" },
                { q: "What is the primary flavor profile of a young Touriga Nacional?", a: "Concentrated black fruits (cassis, blackberry) and floral notes (violets, bergamot)." },
                { q: "What is the primary flavor profile of Tinta Cão?", a: "Red cherry fruit with peppery and spicy notes." },
                { q: "The high acidity of Sousão makes it particularly useful in which kind of vintages?", a: "Hot vintages, where other grapes may lack acidity." },
                { q: "Which grape is NOT one of the 'big five'?", a: "Sousão" },
                { q: "Which grape is often used for high-quality single-varietal Douro DOC red wines?", a: "Touriga Nacional" },
                { q: "Which grape's berries are relatively small, leading to a good skin-to-pulp ratio?", a: "Tinta Cão" },
                { q: "Which white grape variety is also known as Folgasão?", a: "Terrantez" },
                { q: "The traditional Douro vineyard is an example of what kind of biodiversity?", a: "High genetic diversity within a single plot." },
                { q: "What rootstock is most commonly used in the Douro since phylloxera?", a: "American rootstock, such as Rupestris du Lot." },
                { q: "Which grape is known to produce a 'second crop' of lower quality grapes?", a: "Tinta Roriz" },
                { q: "In a blend, what is the role of a grape like Tinta Cão?", a: "It acts like 'salt and pepper,' adding complexity and structure rather than bulk." },
                { q: "What is the primary pruning method used for Douro vines?", a: "Spur pruning on a bilateral cordon (e.g., Guyot Poussart)." },
                { q: "What is the challenge with Tinta Roriz (Tempranillo) in the Douro's heat?", a: "It can lose acidity quickly if not harvested at the right time." },
                { q: "Which grape is known for its rustic, sometimes slightly earthy character?", a: "Tinta Barroca" },
                { q: "Historically, what was the reputation of Touriga Nacional?", a: "It was a 'shy-bearing' grape, respected for quality but often overlooked for more productive varieties." },
                { q: "Modern viticulture in the Douro increasingly focuses on planting the right grape variety in the right what?", a: "Location (altitude, aspect)." }
            ],
            lawmaker: [
                { q: "What is the full name of the IVDP, the governing body for Port?", a: "Instituto dos Vinhos do Douro e Porto." },
                { q: "What is the 'benefício'?", a: "The official authorization, set annually, of the total amount of grape must that can be fortified into Port." },
                { q: "What is the 'cadastro'?", a: "The official registry and A-F classification of all Douro vineyards." },
                { q: "Fortification must be done with a neutral grape spirit ('aguardente') of what specific strength?", a: "77% ABV." },
                { q: "What is a 'lagar'?", a: "A traditional shallow, open-topped fermentation vessel, typically made of granite, where grapes are foot-trodden." },
                { q: "A Vintage Port must be bottled between July 1 of the 2nd year and June 30 of the 3rd year after harvest. True or False?", a: "True." },
                { q: "What is a 'Colheita' Port?", a: "A Tawny Port from a single vintage, aged for a minimum of 7 years in wood." },
                { q: "What is the minimum aging period in wood for a Late Bottled Vintage (LBV) Port?", a: "Four years (bottled between the 4th and 6th year)." },
                { q: "What does an age statement on a Tawny Port (e.g., 10, 20, 30, 40, 50) signify?", a: "It represents the approximate average age of the wines in the blend, and the wine should taste characteristic of that age." },
                { q: "The decision to 'declare' a vintage is made by whom?", a: "Each individual Port house decides for itself." },
                { q: "What is a 'Crusted' Port?", a: "A blend of high-quality Ruby Ports from several years, bottled unfiltered, and aged for at least 3 years in bottle before release." },
                { q: "What is the standard size of a Port 'pipa' (cask) in the Douro?", a: "550 liters." },
                { q: "When does fortification occur?", a: "During fermentation, when about half of the natural sugar has been converted to alcohol." },
                { q: "What is the purpose of fortification?", a: "To stop fermentation by killing the yeast, thereby preserving a high level of natural grape sugar." },
                { q: "What is the typical final alcohol by volume (ABV) of Port wine?", a: "19-22%." },
                { q: "What must a producer do to have a wine approved as Vintage Port?", a: "Submit a sample to the IVDP's tasting panel in the second year after harvest for approval." },
                { q: "What is the key difference between a 'Traditional' (Unfiltered) LBV and a modern, filtered LBV?", a: "A traditional LBV is bottled without filtration and will age and throw a sediment in the bottle, requiring decanting." },
                { q: "What does 'Garrafeira' mean on a Port label?", a: "A very rare style of single vintage Port, aged in wood and then for many years in large glass demijohns ('bonbons')." },
                { q: "What is the 'Lei do Terço' (Law of the Third)?", a: "A former law that only allowed growers to sell one-third of their stocks each year to prevent prices from crashing." },
                { q: "What does the IVDP seal on the neck of a bottle guarantee?", a: "Authenticity and that the wine meets all the legal requirements for its stated category." },
                { q: "White Port is categorized by what?", a: "Sweetness level (e.g., Extra Seco, Seco, Doce, Lágrima)." },
                { q: "What does the term 'Reserva' or 'Reserve' signify for a Ruby or Tawny Port?", a: "A blend of superior quality, as confirmed by the IVDP's tasting panel." },
                { q: "What 1986 law fundamentally changed the Port trade?", a: "The law allowing Douro quintas to bottle and export their own wine directly, breaking the Gaia shippers' monopoly." },
                { q: "The amount of 'benefício' a vineyard receives is directly tied to its what?", a: "Its 'cadastro' (A-F) rating." },
                { q: "Is chaptalization (the addition of sugar) permitted in Port production?", a: "No, the sweetness comes from preserved natural grape sugar." },
                { q: "What is the sweetest style of White Port called?", a: "Lágrima (Tears)." },
                { q: "What is the maximum yield allowed for grapes intended for Port?", a: "55 hl/ha." },
                { q: "What is 'Single Quinta Vintage Port'?", a: "A Vintage Port from a single estate, typically produced in good years that were not 'declared' as a classic vintage by the house." },
                { q: "All Port wines must be submitted to whom for approval before being sold?", a: "The IVDP's Câmara de Provadores (tasting chamber)." },
                { q: "What is the minimum alcohol content for Port?", a: "19% (with some exceptions for lighter styles)." },
                { q: "What is the term for the process of fortifying the wine?", a: "Beneficiação." },
                { q: "What does the bottling date on an aged Tawny indicate?", a: "When the wine was transferred from cask to bottle, stopping its oxidative aging process." },
                { q: "Is acidification permitted in the Douro?", a: "Yes, it is often necessary in hot vintages." },
                { q: "What is the legal definition of 'Envelhecido em Garrafa'?", a: "Aged in bottle. For an LBV, it means at least 3 years of bottle aging before release." },
                { q: "Who established the Douro as the world's first demarcated wine region in 1756?", a: "The Marquis of Pombal." },
                { q: "Where must a wine be fortified to be legally considered Port?", a: "Within the Douro Demarcated Region." },
                { q: "What is the difference between a Colheita and a 10-Year-Old Tawny?", a: "A Colheita is from a single vintage, while a 10-Year-Old is a blend of multiple vintages to an average age." },
                { q: "The historical monopoly on aging and shipping Port was held by the merchants based in which city?", a: "Vila Nova de Gaia." },
                { q: "Which Port style does not improve with bottle age and should be consumed shortly after purchase?", a: "Filtered Tawny and Ruby Ports." },
                { q: "Which Port styles require decanting due to heavy sediment?", a: "Vintage Port, Crusted Port, and Traditional (Unfiltered) LBV." },
                { q: "What is the IVDP's role in the 'benefício'?", a: "It sets the total amount of 'benefício' for the year based on market conditions and stock levels." },
                { q: "The term 'Feitoria' was used in the 18th century to designate the area for wines of what quality?", a: "The highest quality, destined for export." },
                { q: "Is it legal to add caramel color to adjust the appearance of a Tawny Port?", a: "Yes, it is permitted to maintain consistency of the house style." },
                { q: "What is the legal maximum amount of volatile acidity allowed in Port?", a: "It varies by style, but is generally higher than for table wines." },
                { q: "What is the minimum time a Crusted Port must spend in bottle before release?", a: "Three years." },
                { q: "What is Rosé Port?", a: "A style made with red grapes but with limited skin contact to achieve a pink color, served chilled." },
                { q: "What is a 'Vinho ao Roda'?", a: "A historical term for wine that matured on a round-trip sea journey through the tropics." },
                { q: "The grape spirit used for fortification is legally required to be what?", a: "Neutral and free of congeners or flavors." },
                { q: "What is the name of the special tongs used to open a very old bottle of Vintage Port by cracking the neck of the bottle with thermal shock?", a: "Port tongs." },
                { q: "Who regulates the unfortified DOC Douro table wines?", a: "The IVDP, the same body that regulates Port." }
            ],
            gastronome: [
                { q: "What is the most famous and classic pairing for Vintage Port?", a: "A strong, salty blue cheese, especially Stilton." },
                { q: "What is a 'Porto Tónico'?", a: "A popular aperitif cocktail made with White Port, tonic water, and a citrus garnish." },
                { q: "Aged Tawny Ports, with their nutty, caramel, and dried fruit notes, pair beautifully with what kind of desserts?", a: "Nut tarts, crème brûlée, apple pie, or simply a bowl of walnuts." },
                { q: "What is 'Tripas à Moda do Porto'?", a: "The signature dish of Porto, a hearty stew of tripe, white beans, sausage, and vegetables." },
                { q: "The Port lodges, where the wine is aged, are located in which city?", a: "Vila Nova de Gaia, across the river from Porto." },
                { q: "What is 'Serra da Estrela'?", a: "Portugal's most famous cheese, a rich, pungent, and creamy sheep's milk cheese." },
                { q: "What is a 'Francesinha'?", a: "A famously indulgent sandwich from Porto, layered with meats, covered in melted cheese, and drenched in a spicy tomato, beer, and Port sauce." },
                { q: "What were the 'Barcos Rabelos'?", a: "The traditional flat-bottomed boats used to transport Port barrels down the Douro River." },
                { q: "A simple Ruby Port is a good match for what type of food?", a: "Hard cheeses like cheddar or a simple dark chocolate dessert." },
                { q: "What does it mean to 'decant' a Port?", a: "To carefully pour the wine from the bottle into a separate container (a decanter) to leave the natural sediment behind." },
                { q: "Which Port styles must always be decanted before serving?", a: "Vintage Port, Crusted Port, and Traditional (Unfiltered) LBV." },
                { q: "What is the ideal serving temperature for a Tawny Port?", a: "Slightly chilled (12-14°C or 54-57°F)." },
                { q: "What is the ideal serving temperature for a Vintage Port?", a: "Slightly below room temperature (16-18°C or 61-64°F)." },
                { q: "What is 'Bacalhau'?", a: "Dried and salted codfish, a staple of Portuguese cuisine prepared in countless ways." },
                { q: "Which Port style can be kept for several weeks after opening if refrigerated?", a: "Tawny Port (due to its oxidative aging)." },
                { q: "Which Port style should be consumed within a few days of opening, similar to a regular table wine?", a: "Vintage Port." },
                { q: "What is a 'copita'?", a: "The traditional tulip-shaped glass used for serving and tasting Port." },
                { q: "A chilled Tawny Port is a classic, if luxurious, pairing for what savory starter?", a: "Pâté or seared foie gras." },
                { q: "What is the 'Vindima'?", a: "The Portuguese word for the grape harvest." },
                { q: "Why do the saltiness of Stilton and the sweetness of Vintage Port work so well together?", a: "It's a classic contrast pairing, where the salt accentuates the fruit and sweetness of the wine while the wine's power stands up to the cheese." },
                { q: "What is a 'Pastel de Nata'?", a: "A classic Portuguese egg custard tart, often sprinkled with cinnamon." },
                { q: "Why are the Port lodges in Gaia built with thick granite walls and high ceilings?", a: "To maintain a cool, stable temperature and humidity, ideal for slow wine maturation." },
                { q: "Azeitão is a creamy sheep's milk cheese made using what as a coagulant?", a: "Thistle flower." },
                { q: "The cuisine of the inner Douro Valley is best described as what?", a: "Rustic and hearty, based on wood-fired oven dishes, stews, and cured meats." },
                { q: "What is 'Presunto'?", a: "Portuguese dry-cured ham, similar to Spanish Jamón or Italian Prosciutto." },
                { q: "What is 'Caldo Verde'?", a: "A traditional Portuguese soup of puréed potatoes, finely sliced kale, and chouriço sausage." },
                { q: "A young, unoaked White Port could be paired with what?", a: "Olives, almonds, or light appetizers." },
                { q: "The pairing of Tawny Port with a dessert like crème brûlée is an example of what kind of pairing?", a: "A complementary pairing, matching the caramel and nutty notes in both." },
                { q: "The tradition of passing the Port decanter to the left is said to originate from where?", a: "British naval etiquette, to keep one's sword arm free." },
                { q: "What is a 'confraria'?", a: "A brotherhood or guild, like the Confraria do Vinho do Porto, that promotes and protects the traditions of a product." },
                { q: "Which style of Port is most often used in cooking?", a: "Basic Ruby Port." },
                { q: "What is a 'Bacalhau à Brás'?", a: "A popular dish made with shredded salt cod, onions, potatoes, and scrambled eggs." },
                { q: "What are 'tremoços'?", a: "Lupini beans, a popular salty snack often served with beer or aperitifs in Portugal." },
                { q: "Which city is the gastronomic capital of Portugal?", a: "Porto." },
                { q: "The 'Factory House' in Porto was the exclusive club for which group?", a: "The British Port shippers." },
                { q: "Which Port style is a good match for desserts featuring red or black fruits?", a: "Late Bottled Vintage (LBV)." },
                { q: "What is the name of the main market hall in Porto?", a: "Mercado do Bolhão." },
                { q: "The term 'sobremesa' in Portuguese means what?", a: "Dessert." },
                { q: "Why is Port rarely paired with spicy food?", a: "The high alcohol in Port can amplify the sensation of heat from capsaicin." },
                { q: "What is 'Alheira'?", a: "A type of Portuguese sausage, traditionally made with poultry and bread." },
                { q: "An aged White Port with nutty, oxidized notes would pair well with what?", a: "Hard, aged cheeses like Parmesan or aged Gouda." },
                { q: "What are 'bifanas'?", a: "A popular Portuguese sandwich of thinly sliced, marinated pork served on a bread roll." },
                { q: "The historical diet of the Douro vineyard workers was based on what staples?", a: "Soup, sardines, bread, and rough wine." },
                { q: "What is the role of a 'master blender' in a Port lodge?", a: "To maintain the consistency and house style of non-vintage blends like Tawny and Ruby by blending wines from different years." },
                { q: "How is a very old bottle of Port traditionally opened to avoid a crumbling cork?", a: "With heated Port tongs, which crack the neck of the bottle cleanly." },
                { q: "What is a 'meia-desfeita'?", a: "A traditional codfish and chickpea salad." },
                { q: "Rosé Port, with its notes of strawberry and raspberry, pairs well with what?", a: "Light summer desserts, fruit salads, or on its own as an aperitif." },
                { q: "What is 'Arroz de Pato'?", a: "A traditional dish of duck rice, baked in the oven." },
                { q: "Why is it important for the aguardente used in fortification to be neutral?", a: "So that it doesn't impart any unwanted flavors to the Port." },
                { q: "What is the 'capital' of the Douro wine region (where the IVDP is based)?", a: "Peso da Régua." }
            ],
            critic: [
                { q: "Which producer's Vintage Ports are known for their immense structure, power, and longevity, often described as austere in their youth?", a: "Taylor Fladgate", subjectType: 'producer', subjectName: 'Taylor Fladgate' },
                { q: "Which legendary 20th-century vintage is renowned for its perfect balance, concentration, and aromatic complexity?", a: "1963", subjectType: 'vintage', subjectName: '1963 Port Vintage' },
                { q: "Quinta do Noval's 'Nacional' is a tiny-production Vintage Port from what kind of vines?", a: "A 2.5-hectare parcel of ungrafted, pre-phylloxera vines.", subjectType: 'wine', subjectName: 'Quinta do Noval Nacional' },
                { q: "Which Symington-owned house is known for a rich, sweet, opulent style, often described as hedonistic?", a: "Graham's", subjectType: 'producer', subjectName: "Graham's" },
                { q: "The 2011 vintage was widely declared and is known for what characteristics?", a: "Exceptional concentration, purity of fruit, and massive but well-integrated tannins.", subjectType: 'vintage', subjectName: '2011 Port Vintage' },
                { q: "Fonseca is known for a lush, exotic, and intensely fruity style. It is the sister house of which other producer?", a: "Taylor Fladgate", subjectType: 'producer', subjectName: 'Fonseca' },
                { q: "What was unusual about the declarations of the 2016 and 2017 vintages?", a: "It was the first time since the 19th century that most major houses made back-to-back general declarations.", subjectType: 'vintage', subjectName: '2016 & 2017 Port Vintages' },
                { q: "Which major house, owned by the Symingtons, is known for a comparatively drier and more aromatic style of Vintage Port?", a: "Dow's", subjectType: 'producer', subjectName: "Dow's" },
                { q: "What is the name of Taylor Fladgate's premier single vineyard (quinta)?", a: "Quinta de Vargellas", subjectType: 'place', subjectName: 'Quinta de Vargellas' },
                { q: "Which family-owned house is known for its intellectual, sometimes quirky, style and is a pioneer of both high-quality Douro DOC wines and aged White Ports?", a: "Niepoort", subjectType: 'producer', subjectName: 'Niepoort' },
                { q: "The 1994 vintage is considered a modern classic, noted for its:", a: "Superb balance, ripe tannins, and great aging potential.", subjectType: 'vintage', subjectName: '1994 Port Vintage' },
                { q: "What are the three main brands of The Fladgate Partnership?", a: "Taylor Fladgate, Fonseca, and Croft.", subjectType: 'producer', subjectName: 'The Fladgate Partnership' },
                { q: "Quinta dos Malvedos is the backbone of which Port house's vintage blend?", a: "Graham's", subjectType: 'producer', subjectName: "Quinta dos Malvedos" },
                { q: "The 1977 vintage is celebrated for its combination of what two qualities?", a: "Richness of fruit and powerful structure, with great elegance.", subjectType: 'vintage', subjectName: '1977 Port Vintage' },
                { q: "Which house is arguably the most famous for its extensive stocks and mastery of aged Tawny Ports?", a: "Taylor Fladgate", subjectType: 'producer', subjectName: 'Taylor Fladgate' },
                { q: "Quinta do Bomfim provides the core of which house's Vintage Ports?", a: "Dow's", subjectType: 'producer', subjectName: "Quinta do Bomfim" },
                { q: "The 2017 vintage was the result of what kind of growing season?", a: "An exceptionally hot and dry one, leading to an early and very concentrated harvest.", subjectType: 'vintage', subjectName: '2017 Port Vintage' },
                { q: "Which major house is owned by the French insurance group AXA Millésimes?", a: "Quinta do Noval", subjectType: 'producer', subjectName: 'Quinta do Noval' },
                { q: "Who invented the Late Bottled Vintage (LBV) style?", a: "Taylor Fladgate", subjectType: 'producer', subjectName: 'Taylor Fladgate' },
                { q: "The 1970 vintage is known for its classicism, balance, and what other trait?", a: "Its aromatic complexity and longevity.", subjectType: 'vintage', subjectName: '1970 Port Vintage' },
                { q: "Warre's, the oldest British Port company, has what house style?", a: "Elegant and aromatic, often with fresh floral and spicy notes.", subjectType: 'producer', subjectName: "Warre's" },
                { q: "A 'Single Quinta Vintage Port' is typically released from a top estate in a year that was:", a: "Very good, but not quite great enough for the house to make a general 'classic' declaration.", subjectType: 'wine', subjectName: 'Single Quinta Vintage Port' },
                { q: "The 2003 vintage was very hot across Europe. How did this affect the style of the Ports?", a: "They are very ripe, powerful, and sometimes have a 'roasted' or baked fruit character.", subjectType: 'vintage', subjectName: '2003 Port Vintage' },
                { q: "Ferreira, a historic house founded by Dona Antónia Ferreira, is now owned by which company?", a: "Sogrape", subjectType: 'producer', subjectName: 'Ferreira' },
                { q: "How is the 1985 vintage generally regarded?", a: "As a forward and charming vintage that was approachable earlier than the more structured '77 or '83.", subjectType: 'vintage', subjectName: '1985 Port Vintage' },
                { q: "Which of these famous houses is NOT part of the Symington Family Estates?", a: "Fonseca", subjectType: 'producer', subjectName: 'Symington Family Estates' },
                { q: "Who is the head winemaker for the Symington family, overseeing brands like Graham's and Dow's?", a: "Charles Symington", subjectType: 'critic', subjectName: 'Charles Symington' },
                { q: "The 1945 vintage, produced just as WWII ended, is legendary for its:", a: "Incredible concentration, power, and near-immortality.", subjectType: 'vintage', subjectName: '1945 Port Vintage' },
                { q: "Fonseca produces a famous organic Vintage Port under what name?", a: "Terra Prima", subjectType: 'wine', subjectName: 'Fonseca Terra Prima' },
                { q: "The 2000 vintage is known for being:", a: "Well-structured and balanced, though perhaps overshadowed by the '94 and '11.", subjectType: 'vintage', subjectName: '2000 Port Vintage' },
                { q: "Quinta da Roêda is the flagship estate for which Port house?", a: "Croft", subjectType: 'place', subjectName: 'Quinta da Roêda' },
                { q: "The house style of Niepoort's aged Tawnies is known for being particularly:", a: "Oxidative and complex, with high acidity ('vinagrinho').", subjectType: 'producer', subjectName: 'Niepoort' },
                { q: "How is the 1997 vintage regarded?", a: "As a very good, elegant, and aromatic vintage that was somewhat underrated after the great '94.", subjectType: 'vintage', subjectName: '1997 Port Vintage' },
                { q: "The iconic 'Don' silhouette on a bottle belongs to which brand?", a: "Sandeman", subjectType: 'producer', subjectName: 'Sandeman' },
                { q: "The market for Port has shifted from high-volume basic styles to what?", a: "Higher-value premium categories.", subjectType: 'critic', subjectName: 'Port Market Trends' },
                { q: "Which of these vintages was plagued by rain, leading to few declarations?", a: "1991", subjectType: 'vintage', subjectName: '1991 Port Vintage' },
                { q: "Cockburn's, famous for its Special Reserve, was acquired by which group in 2010?", a: "Symington Family Estates", subjectType: 'producer', subjectName: "Cockburn's" },
                { q: "Who is the head winemaker for The Fladgate Partnership?", a: "David Guimaraens", subjectType: 'critic', subjectName: 'David Guimaraens' },
                { q: "How is the 1992 vintage rated?", a: "A very good 'split' vintage, where some houses declared but others did not.", subjectType: 'vintage', subjectName: '1992 Port Vintage' },
                { q: "Which was the last generally declared vintage of the 20th Century?", a: "1994", subjectType: 'vintage', subjectName: '1994 Port Vintage' },
                { q: "The term 'house style' is most critical for ensuring the consistency of which Port type?", a: "Blended Tawny Port with an indication of age.", subjectType: 'wine_style', subjectName: 'House Style' },
                { q: "Which vintage was known for being floral and elegant, but perhaps lacking the power of other great years?", a: "1983", subjectType: 'vintage', subjectName: '1983 Port Vintage' },
                { q: "Which producer is known for releasing very old Colheita Tawnies, sometimes over 100 years old?", a: "Kopke", subjectType: 'producer', subjectName: 'Kopke' },
                { q: "Which vintage produced wines that were initially very tannic and backward, taking a long time to become approachable?", a: "1977", subjectType: 'vintage', subjectName: '1977 Port Vintage' },
                { q: "The Fladgate Partnership and the Symington Family together account for roughly what percentage of total Port sales?", a: "Over 50%", subjectType: 'critic', subjectName: 'Port Market Structure' },
                { q: "What is a 'classic' vintage declaration?", a: "When a Port house decides the quality is high enough to bottle and release its main Vintage Port, not just a single quinta.", subjectType: 'wine_style', subjectName: 'Classic Vintage Declaration' },
                { q: "Which vintage was declared by Noval but almost no one else, producing a legendary wine?", a: "1931", subjectType: 'vintage', subjectName: '1931 Port Vintage' },
                { q: "Ramos Pinto, known for its beautiful Belle Époque advertising, is owned by which company?", a: "Louis Roederer", subjectType: 'producer', subjectName: 'Ramos Pinto' },
                { q: "Which vintage was the first to be generally declared in the 21st century?", a: "2000", subjectType: 'vintage', subjectName: '2000 Port Vintage' },
                { q: "What is a 'second wine' in the context of Port?", a: "This concept doesn't really exist; instead, undeclared vintage-quality wine is often used for Single Quinta, LBV, or aged Tawny Ports." }
            ]
        };

        const mainMenu = document.getElementById('main-menu');
        const gameScreen = document.getElementById('game-screen');
        const modalContainer = document.getElementById('modal-container');
        const modalContentWrapper = document.getElementById('modal-content-wrapper');
        const aiSettingsBtn = document.getElementById('ai-settings-btn');

        let currentModule;
        let currentQuestionIndex;
        let score;
        let questions = [];
        let userTimeline = [];
        let historianAvailableEvents = [];
        let flashcardDeck = [];
        let currentFlashcardIndex = 0;
        let userApiKey = localStorage.getItem('geminiApiKey') || '';

        // --- Event Listeners ---
        document.querySelectorAll('.module-btn').forEach(button => {
            button.addEventListener('click', () => {
                const module = button.dataset.module;
                if (module === 'flashcard') {
                    showFlashcardTopicSelection();
                } else {
                    showInstructionalModal(module);
                }
            });
        });

        aiSettingsBtn.addEventListener('click', showAiSettingsModal);
    	
        // --- Modal Functions ---
        function showModal(content) {
            modalContentWrapper.innerHTML = content;
            modalContainer.classList.remove('hidden');
        }

        function hideModal() {
            modalContainer.classList.add('hidden');
            modalContentWrapper.innerHTML = '';
        }
    	
        function showWelcomeModal() {
            if (sessionStorage.getItem('welcomed')) return;
            const content = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">Welcome to the Gauntlet!</h2>
                    <p class="mb-4 text-gray-300">This is "Fortified Porto: A Wine Master's Challenge," an interactive study game designed for advanced wine students.</p>
                    <p class="mb-6 text-gray-300">Test your knowledge across history, terroir, grapes, law, and more. All questions are derived from a comprehensive research document on the region. Good luck!</p>
                    <button onclick="closeWelcomeModal()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Begin</button>
                </div>
            `;
            showModal(content);
        }

        function closeWelcomeModal() {
            sessionStorage.setItem('welcomed', 'true');
            hideModal();
        }

        function showInstructionalModal(module) {
            currentModule = module;
            const moduleData = gameData[module];
            const content = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">${moduleData.title}</h2>
                    <p class="mb-6 text-gray-300">${moduleData.instructions}</p>
                    <button onclick="startGame()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Start Challenge</button>
                </div>
            `;
            showModal(content);
        }

        function showEndGameModal() {
            const moduleData = gameData[currentModule];
            const content = `
                <div class="p-6 text-center">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">Module Complete!</h2>
                    <p class="text-lg mb-2 text-gray-300">You completed "${moduleData.title}".</p>
                    <p class="text-4xl font-bold mb-6">Score: ${score} / ${questions.length}</p>
                    <div class="flex space-x-4">
                        <button onclick="startGame()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Keep Going</button>
                        <button onclick="returnToMenu()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Main Menu</button>
                    </div>
                </div>
            `;
            showModal(content);
        }

        function showAiSettingsModal() {
            const content = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-purple-400">AI Settings</h2>
                        <button onclick="hideModal()" class="text-gray-400 hover:text-white">&times;</button>
                    </div>
                    <p class="mb-4 text-gray-300">To use the AI-powered features, please enter your Google AI Studio API key. You can get a key at <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-purple-400 hover:underline">aistudio.google.com/app/apikey</a>.</p>
                    <p class="text-sm text-yellow-400 mb-4">Security Reminder: Treat your API key like a password. It is saved in your browser's local storage for convenience but is not transmitted anywhere else.</p>
                    <div class="mb-4">
                        <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-1">Google AI API Key</label>
                        <input type="password" id="api-key-input" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" value="${userApiKey}">
                    </div>
                    <button onclick="saveApiKey()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Save and Close</button>
                </div>
            `;
            showModal(content);
        }
    	
        function saveApiKey() {
            userApiKey = document.getElementById('api-key-input').value;
            localStorage.setItem('geminiApiKey', userApiKey);
            hideModal();
        }

        // --- Game Flow ---
        function startGame() {
            hideModal();
            mainMenu.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            score = 0;
            currentQuestionIndex = 0;

            if (currentModule === 'historian') {
                questions = shuffleArray([...gameData.historian.questions]).slice(0, 4); // Historian has a fixed number of questions
                loadHistorianQuestion();
            } else {
                const allModuleQuestions = [...gameData[currentModule].questions];
                const correctLog = JSON.parse(localStorage.getItem('correctlyAnsweredQuestions')) || {};
                const correctQuestionsForModule = correctLog[currentModule] || [];

                let availableQuestions = allModuleQuestions.filter(q => !correctQuestionsForModule.includes(q.q));

                if (availableQuestions.length === 0 && allModuleQuestions.length > 0) {
                    const masteryContent = `
                        <div class="p-6 text-center">
                            <h2 class="text-2xl font-bold mb-4 text-green-400">Module Mastered!</h2>
                            <p class="mb-4 text-gray-300">Congratulations! You've correctly answered all questions in this module. Your progress will be reset so you can continue to sharpen your knowledge.</p>
                            <button onclick="resetAndStartGame()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Play Again</button>
                        </div>
                    `;
                    showModal(masteryContent);
                    return; 
                }
            	
                questions = shuffleArray(availableQuestions).slice(0, 10);
                loadQuestion();
            }
        }

        function resetAndStartGame() {
            let correctLog = JSON.parse(localStorage.getItem('correctlyAnsweredQuestions')) || {};
            correctLog[currentModule] = [];
            localStorage.setItem('correctlyAnsweredQuestions', JSON.stringify(correctLog));
            startGame();
        }

        function returnToMenu() {
            hideModal();
            gameScreen.classList.add('hidden');
            mainMenu.classList.remove('hidden');
            gameScreen.innerHTML = '';
            checkGlobalMastery();
        }

        // --- Multiple Choice Logic ---
        function loadQuestion() {
            if (questions.length === 0 || currentQuestionIndex >= questions.length) {
                showEndGameModal();
                return;
            }

            const q = questions[currentQuestionIndex];
            const options = shuffleArray([q.a, ...q.o]);
        	
            gameScreen.innerHTML = `
                <div class="w-full max-w-3xl">
                    <div class="flex justify-between items-center mb-2">
                        <button onclick="returnToMenu()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded text-sm">← Menu</button>
                        <p class="text-right text-gray-400">${currentQuestionIndex + 1} / ${questions.length} | Score: ${score}</p>
                    </div>
                    <div class="bg-gray-800 p-8 rounded-lg">
                        <p class="text-xl md:text-2xl font-medium mb-6">${q.q}</p>
                        <div class="space-y-4">
                            ${options.map(option => `
                                <button class="answer-btn block w-full text-left bg-gray-700 p-4 rounded-lg hover:bg-purple-700 transition-colors duration-200" onclick="checkAnswer('${option.replace(/'/g, "\\'")}')">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                        <div id="feedback-container" class="mt-6"></div>
                    </div>
                </div>
            `;
        }
    	
        function nextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }
    	
        function generateAiButtonHtml(question, isCorrect) {
            if (!question.subjectType || !question.subjectName) {
                return '';
            }
        	
            let buttonText;
            switch(question.subjectType) {
                case 'grape':
                case 'clone':
                case 'viticulture':
                    buttonText = isCorrect ? `➡️ Generate Ampelography Profile` : `💡 Learn about ${question.subjectName}`;
                    break;
                case 'producer':
                case 'vintage':
                case 'wine':
                case 'place':
                case 'wine_style':
                    buttonText = isCorrect ? `➡️ Generate Critic's Analysis` : `💡 Learn about ${question.subjectName}`;
                    break;
                case 'wine_pairing':
                case 'dish':
                    buttonText = isCorrect ? `➡️ Explain the Pairing` : `💡 Learn about this Pairing`;
                    break;
                default:
                        buttonText = isCorrect ? `➡️ Dive Deeper on ${question.subjectName}` : `💡 Learn More about ${question.subjectName}`;
            }

            return `<button onclick="handleAiRequest('${question.subjectType}', '${question.subjectName.replace(/'/g, "\\'")}')" class="mt-4 bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded text-sm">${buttonText}</button>`;
        }

        function checkAnswer(selectedOption) {
            const q = questions[currentQuestionIndex];
            const isCorrect = selectedOption === q.a;
            const feedbackContainer = document.getElementById('feedback-container');
        	
            let feedbackHtml = '';
            if (isCorrect) {
                score++;
                const questionText = q.q;
                let correctLog = JSON.parse(localStorage.getItem('correctlyAnsweredQuestions')) || {};
                if (!correctLog[currentModule]) {
                    correctLog[currentModule] = [];
                }
                if (!correctLog[currentModule].includes(questionText)) {
                    correctLog[currentModule].push(questionText);
                }
                localStorage.setItem('correctlyAnsweredQuestions', JSON.stringify(correctLog));

                feedbackHtml = `<div class="p-4 rounded-lg bg-green-900 border border-green-700">
                                    <p class="font-bold text-green-300">Correct!</p>
                                    <p class="text-green-400">${q.a}</p>
                                    ${generateAiButtonHtml(q, true)}
                                </div>`;
            } else {
                feedbackHtml = `<div class="p-4 rounded-lg bg-red-900 border border-red-700">
                                    <p class="font-bold text-red-300">Incorrect.</p>
                                    <p class="text-red-400">The correct answer was: ${q.a}</p>
                                        ${generateAiButtonHtml(q, false)}
                                </div>`;
            }

            feedbackContainer.innerHTML = feedbackHtml;
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.disabled = true;
                if(btn.innerText === q.a) {
                    btn.classList.remove('hover:bg-purple-700');
                    btn.classList.add('bg-green-700');
                }
            });
            feedbackContainer.innerHTML += `<button onclick="nextQuestion()" class="mt-4 w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Continue</button>`;
        }
    	
        // --- Historian's Scroll Logic ---
        function loadHistorianQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showEndGameModal();
                return;
            }

            const q = questions[currentQuestionIndex];
            userTimeline = [];
        	
            const eventsWithIds = q.events.map((event, index) => ({ ...event, id: `${currentQuestionIndex}-${index}` }));
            historianAvailableEvents = shuffleArray(eventsWithIds);

            gameScreen.innerHTML = `
                <div class="w-full max-w-4xl">
                    <div class="flex justify-between items-center mb-2">
                        <button onclick="returnToMenu()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded text-sm">← Menu</button>
                        <p class="text-center text-gray-400">Question ${currentQuestionIndex + 1} / ${questions.length} | Score: ${score}</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <p class="text-xl text-center font-medium mb-6">${q.question}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="font-bold text-lg mb-2 text-purple-400 text-center">Available Events</h3>
                                <div id="available-events" class="space-y-2">
                                    ${historianAvailableEvents.map(event => `
                                        <button data-id="${event.id}" class="timeline-item w-full text-left bg-gray-700 p-3 rounded hover:bg-purple-800 transition-colors duration-200">
                                            ${event.text}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-2 text-purple-400 text-center">Your Timeline (Earliest to Latest)</h3>
                                <div id="user-timeline" class="space-y-2 bg-gray-900 p-3 rounded-lg min-h-[200px]"></div>
                            </div>
                        </div>
                        <div class="text-center mt-6">
                            <button id="submit-timeline" class="bg-purple-700 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-lg" onclick="checkTimeline()">Submit</button>
                        </div>
                    </div>
                </div>
            `;
        	
            document.querySelectorAll('#available-events .timeline-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    const eventId = e.currentTarget.dataset.id;
                    const event = historianAvailableEvents.find(ev => ev.id === eventId);
                    if (event && !userTimeline.some(e => e.id === event.id)) {
                        userTimeline.push(event);
                        e.currentTarget.classList.add('selected', 'opacity-50', 'cursor-not-allowed');
                        e.currentTarget.disabled = true;
                        renderUserTimeline();
                    }
                });
            });
        }
    	
        function renderUserTimeline() {
            const timelineContainer = document.getElementById('user-timeline');
            timelineContainer.innerHTML = userTimeline.map((event, index) => `
                <div class="bg-purple-900 p-3 rounded flex items-center justify-between">
                    <span>${index + 1}. ${event.text}</span>
                    <button class="text-red-400 hover:text-red-200 font-bold" onclick="removeFromTimeline('${event.id}')">&times;</button>
                </div>
            `).join('');
        }

        function removeFromTimeline(eventId) {
            const indexToRemove = userTimeline.findIndex(event => event.id === eventId);

            if (indexToRemove > -1) {
                userTimeline.splice(indexToRemove, 1);
                const buttonToReEnable = document.querySelector(`#available-events .timeline-item[data-id="${eventId}"]`);
                if (buttonToReEnable) {
                    buttonToReEnable.disabled = false;
                    buttonToReEnable.classList.remove('selected', 'opacity-50', 'cursor-not-allowed');
                }
                renderUserTimeline();
            }
        }

        function checkTimeline() {
            const q = questions[currentQuestionIndex];
            const correctTimeline = [...q.events].sort((a, b) => a.date - b.date);
            let isCompletelyCorrect = userTimeline.length === correctTimeline.length;
        	
            if (isCompletelyCorrect) {
                for (let i = 0; i < correctTimeline.length; i++) {
                    if (userTimeline[i].text !== correctTimeline[i].text) {
                        isCompletelyCorrect = false;
                        break;
                    }
                }
            }
        	
            if(isCompletelyCorrect) {
                score++;
            }

            const userTimelineHtml = userTimeline.map((event, i) => {
                const isEventInCorrectPosition = correctTimeline[i] && correctTimeline[i].text === event.text;
                const borderColor = isEventInCorrectPosition ? 'border-green-500' : 'border-red-500';
                return `<li class="p-2 bg-gray-700 rounded border-2 ${borderColor}">${event.text}</li>`;
            }).join('');

            const correctTimelineHtml = correctTimeline.map(e => 
                `<li class="p-2 bg-gray-700 rounded border-2 border-green-500">${e.text} <span class="text-gray-400 text-sm">(${e.date})</span></li>`
            ).join('');
        	
            const feedbackContent = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 ${isCompletelyCorrect ? 'text-green-400' : 'text-yellow-400'}">${isCompletelyCorrect ? 'Perfect!' : 'Review Your Timeline'}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-bold text-lg mb-2 text-purple-400">Your Timeline</h3>
                            <ol class="list-decimal list-inside space-y-2">
                                ${userTimelineHtml}
                            </ol>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-2 text-purple-400">Correct Timeline</h3>
                            <ol class="list-decimal list-inside space-y-2">
                                ${correctTimelineHtml}
                            </ol>
                        </div>
                    </div>
                    <button onclick="nextHistorianQuestion()" class="mt-6 w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Continue</button>
                </div>
            `;
            showModal(feedbackContent);
        }

        function nextHistorianQuestion() {
            hideModal();
            currentQuestionIndex++;
            loadHistorianQuestion();
        }

        // --- Mastery Logic ---
        function checkGlobalMastery() {
            if (sessionStorage.getItem('globalMasteryAcknowledged')) {
                return;
            }

            const modulesToMaster = ['terroir', 'ampelographer', 'lawmaker', 'gastronome', 'critic'];
            const correctLog = JSON.parse(localStorage.getItem('correctlyAnsweredQuestions')) || {};
        	
            let allMastered = true;
            for (const module of modulesToMaster) {
                const totalQuestions = gameData[module].questions.length;
                const correctlyAnswered = (correctLog[module] || []).length;
                if (correctlyAnswered < totalQuestions) {
                    allMastered = false;
                    break;
                }
            }

            if (allMastered) {
                showGlobalMasteryModal();
            }
        }

        function showGlobalMasteryModal() {
            const content = `
                <div class="p-6 text-center">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">Congratulations, Port Master!</h2>
                    <p class="mb-4 text-gray-300">You have demonstrated exceptional knowledge by correctly answering every question across all core modules. You have truly mastered Fortified Porto!</p>
                    <p class="mb-6 text-gray-300">To keep your expertise sharp, continue to practice with the <strong>Flashcard Study</strong> decks.</p>
                    <button onclick="closeGlobalMasteryModal()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Continue</button>
                </div>
            `;
            showModal(content);
        }

        function closeGlobalMasteryModal() {
            sessionStorage.setItem('globalMasteryAcknowledged', 'true');
            hideModal();
        }

        // --- Flashcard Logic ---
        function showFlashcardTopicSelection() {
            const topics = Object.keys(flashcardData); // Use flashcardData keys
            const content = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">Build Your Flashcard Deck</h2>
                    <p class="mb-6 text-gray-300">Select the topics you want to study. These decks cover the entire source document.</p>
                    <div id="flashcard-topics" class="space-y-2 mb-4">
                        ${topics.map(topic => `
                            <label class="flex items-center bg-gray-700 p-3 rounded-lg hover:bg-gray-600 cursor-pointer">
                                <input type="checkbox" class="form-checkbox h-5 w-5 text-purple-600 bg-gray-800 border-gray-600 rounded focus:ring-purple-500" data-topic="${topic}">
                                <span class="ml-3 text-white">${gameData[topic].title}</span>
                            </label>
                        `).join('')}
                    </div>
                     <label class="flex items-center bg-gray-700 p-3 rounded-lg hover:bg-gray-600 cursor-pointer mb-6">
                        <input type="checkbox" id="select-all-topics" class="form-checkbox h-5 w-5 text-purple-600 bg-gray-800 border-gray-600 rounded focus:ring-purple-500">
                        <span class="ml-3 text-white font-bold">Select All</span>
                    </label>
                    <button onclick="startFlashcardSession()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Start Studying</button>
                </div>
            `;
            showModal(content);
        	
            document.getElementById('select-all-topics').addEventListener('change', (e) => {
                document.querySelectorAll('#flashcard-topics input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });
        }

        function startFlashcardSession() {
            flashcardDeck = [];
            const selectedTopics = Array.from(document.querySelectorAll('#flashcard-topics input:checked')).map(cb => cb.dataset.topic);

            if (selectedTopics.length === 0) {
                showModal(`<div class="p-6 text-center">
                    <p class="text-lg text-yellow-400 mb-4">Please select at least one topic.</p>
                    <button onclick="showFlashcardTopicSelection()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Go Back</button>
                </div>`);
                return;
            }

            selectedTopics.forEach(topic => {
                if (flashcardData[topic]) {
                    flashcardDeck.push(...flashcardData[topic]);
                }
            });

            flashcardDeck = shuffleArray(flashcardDeck);
            currentFlashcardIndex = 0;
            hideModal();
            mainMenu.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            loadFlashcard();
        }

        function loadFlashcard() {
            if (flashcardDeck.length === 0) {
                gameScreen.innerHTML = `<div class="text-center">
                    <p class="text-2xl mb-4">No topics selected.</p>
                    <button onclick="returnToMenu()" class="bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Main Menu</button>
                </div>`;
                return;
            }
            const card = flashcardDeck[currentFlashcardIndex];
            gameScreen.innerHTML = `
                <div class="w-full max-w-2xl flex flex-col items-center">
                    <p class="text-gray-400 mb-4">${currentFlashcardIndex + 1} / ${flashcardDeck.length}</p>
                    <div class="flashcard-container w-full h-80 mb-6">
                        <div class="flashcard" onclick="this.classList.toggle('is-flipped')">
                            <div class="flashcard-face flashcard-front text-2xl font-semibold text-center">${card.q}</div>
                            <div class="flashcard-face flashcard-back text-xl text-center overflow-y-auto">${card.a}</div>
                        </div>
                    </div>
                    <div class="flex justify-between w-full">
                        <button id="prev-card" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded">&larr; Previous</button>
                        <button onclick="returnToMenu()" class="bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-6 rounded">End Session</button>
                        <button id="next-card" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded">Next &rarr;</button>
                    </div>
                </div>
            `;
        	
            document.getElementById('prev-card').addEventListener('click', () => {
                if (currentFlashcardIndex > 0) {
                    currentFlashcardIndex--;
                    loadFlashcard();
                }
            });
            document.getElementById('next-card').addEventListener('click', () => {
                if (currentFlashcardIndex < flashcardDeck.length - 1) {
                    currentFlashcardIndex++;
                    loadFlashcard();
                }
            });
        }
    	
        // --- AI Integration ---
        async function handleAiRequest(subjectType, subjectName) {
            if (!userApiKey) {
                showModal(`<div class="p-6 text-center">
                    <h2 class="text-2xl font-bold mb-4 text-yellow-400">API Key Required</h2>
                    <p class="mb-4 text-gray-300">Please set your Google AI API key in the 'AI Settings' on the main menu to use this feature.</p>
                    <button onclick="hideModal()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Close</button>
                </div>`);
                return;
            }

            let prompt;
            let title;
            const region = "the Douro Valley for Fortified Porto";

            switch (subjectType) {
                case 'clone':
                case 'grape':
                case 'viticulture':
                    title = `Ampelography Profile: ${subjectName}`;
                    prompt = `You are a master ampelographer and wine educator with a specialization in ${region}. Your task is to profile the grape or viticultural topic: ${subjectName}. Your response must follow this strict pyramid of importance: 1. The subject's specific expression and role within ${region}. 2. Its general viticultural characteristics as they manifest in ${region}'s climate. 3. Its history within the region. Your entire response must be framed through the lens of ${region}. Synthesize information from authoritative sources, but always prioritize the context of ${region}. Structure your response with the following sections: Overview and History in ${region}, Viticultural Characteristics in ${region}, and Typical ${region} Wine Profile. Format the output in simple HTML.`;
                    break;
                case 'wine':
                case 'producer':
                case 'vintage':
                case 'place':
                case 'wine_style':
                    title = `Critic's Focus: ${subjectName}`;
                    prompt = `You are a world-renowned wine critic specializing exclusively in the wines of ${region}. Your task is to write a professional profile for the following iconic ${region} topic: ${subjectName}. Your analysis must adhere to a strict pyramid of importance: 1) The specific subject's style or character. 2) The character of its specific appellation within ${region}. 3) The general characteristics of ${region}. Do not mention wines from other regions unless making a direct, essential stylistic comparison. Synthesize information from authoritative sources like Vinous, The Wine Advocate, and JancisRobinson.com, but ensure the final note is your own expert synthesis. Format in simple HTML.`;
                    break;
                case 'dish':
                case 'wine_pairing':
                    title = `Gastronomic Pairing: ${subjectName}`;
                    prompt = `You are a master sommelier and food theorist specializing in the cuisine and wine of ${region}. Your task is to explain the classic wine pairing for the dish: ${subjectName}. Your explanation must follow this strict pyramid of importance: 1. The specific characteristics of the dish as found in the region. 2. The typical profile of a ${region} wine that pairs with it. 3. The underlying gastronomic principles (complement, contrast, texture) that make the pairing successful within the context of the region's culture. Synthesize information from expert sources, but frame your entire response within the context of ${region}. Format in simple HTML.`;
                    break;
                case 'ingredient':
                case 'gastronomy':
                    title = `Ingredient Focus: ${subjectName}`;
                    prompt = `You are a food and wine expert specializing in the cuisine of Portugal and ${region}. Your task is to provide a detailed overview of the ingredient: ${subjectName}. Your response must follow this strict pyramid of importance: 1. How this ingredient is used in the local cuisine of ${region}. 2. Its typical flavor and aromatic profile. 3. How its profile might be reflected in or complement the local wines, but do not focus on specific pairings unless it is intrinsic to the ingredient itself. Synthesize from authoritative sources. Format in simple HTML.`;
                    break;
                case 'beverage':
                    title = `Beverage Profile: ${subjectName}`;
                    prompt = `You are an expert on the spirits and beverages of Portugal, with a specialization in ${region}. Your task is to provide a detailed overview of ${subjectName}. Your response must follow this strict pyramid of importance: 1. How ${subjectName} is made and consumed specifically within ${region}. 2. Its key ingredients and typical flavor profile. 3. Its cultural significance in ${region}. Do not focus on wine pairings unless it is a key part of its consumption. Synthesize information from authoritative sources. Format in simple HTML.`;
                    break;
                default:
                    title = `Expert Overview: ${subjectName}`;
                    prompt = `You are a wine and food expert specializing in ${region}. Provide a concise and informative overview of the following topic: ${subjectName}, ensuring your response is strictly relevant to its context within ${region}. Format in simple HTML.`;
            }
        	
            showModal(`<div class="p-6 text-center">
                <h2 class="text-2xl font-bold mb-4 text-purple-400">Generating AI Response...</h2>
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto"></div>
                <p class="mt-4 text-gray-400">Please wait, contacting the master of wine...</p>
            </div>`);

            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userApiKey}`;
            	
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `API request failed with status ${response.status}`);
                }

                const result = await response.json();
            	
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    const text = result.candidates[0].content.parts[0].text;
                    const aiContent = `
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-purple-400">${title}</h2>
                                <button onclick="hideModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            <div class="prose prose-invert prose-purple max-w-none">${text.replace(/\n/g, '<br>')}</div>
                        </div>`;
                    showModal(aiContent);
                } else {
                        throw new Error("Invalid response structure from API.");
                }

            } catch (error) {
                console.error("AI Generation Error:", error);
                const errorContent = `
                    <div class="p-6">
                        <h2 class="text-2xl font-bold mb-4 text-red-400">Error</h2>
                        <p class="mb-4 text-gray-300">Could not generate AI response. Please check your API key and network connection.</p>
                        <p class="text-sm text-gray-500 bg-gray-900 p-2 rounded">${error.message}</p>
                        <button onclick="hideModal()" class="mt-4 w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Close</button>
                    </div>`;
                showModal(errorContent);
            }
        }

        // --- Utility Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- FIX: Make functions for inline event handlers global ---
        window.closeWelcomeModal = closeWelcomeModal;
        window.startGame = startGame;
        window.returnToMenu = returnToMenu;
        window.checkAnswer = checkAnswer;
        window.saveApiKey = saveApiKey;
        window.hideModal = hideModal;
        window.nextQuestion = nextQuestion;
        window.handleAiRequest = handleAiRequest;
        window.resetAndStartGame = resetAndStartGame;
        window.checkTimeline = checkTimeline;
        window.removeFromTimeline = removeFromTimeline;
        window.nextHistorianQuestion = nextHistorianQuestion;
        window.showFlashcardTopicSelection = showFlashcardTopicSelection;
        window.startFlashcardSession = startFlashcardSession;
        window.closeGlobalMasteryModal = closeGlobalMasteryModal;


        // --- Initial Load ---
        window.onload = showWelcomeModal;

    </script>
</body>
</html>
