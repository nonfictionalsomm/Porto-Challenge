<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Porto: A Wine Master's Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-content {
            max-height: 80vh;
        }
        .prose-purple a {
            color: #9333ea;
        }
        .prose-purple a:hover {
            color: #7e22ce;
        }
        .timeline-item.selected {
            background-color: #6b21a8;
            color: white;
        }
        .flashcard-container {
            perspective: 1000px;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
        }
        .flashcard-front {
            background-color: #374151; /* gray-700 */
        }
        .flashcard-back {
            background-color: #4b5563; /* gray-600 */
            transform: rotateY(180deg);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">




    <div id="main-menu" class="min-h-screen flex flex-col items-center justify-center p-4">
        <h1 class="text-4xl md:text-5xl font-bold text-purple-400 mb-2 text-center">Porto</h1>
        <h2 class="text-2xl md:text-3xl font-semibold mb-8 text-center">A Wine Master's Challenge</h2>




        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-4xl mb-8">
            <button data-module="historian" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Historian's Scroll</h3>
                <p class="text-gray-400">Order the key events that shaped the Douro Valley.</p>
            </button>
            <button data-module="terroir" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Terroir Architect</h3>
                <p class="text-gray-400">Master the soils, climate, and geography of the Douro.</p>
            </button>
            <button data-module="ampelographer" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Ampelographer's Challenge</h3>
                <p class="text-gray-400">Identify the region's key grape varieties.</p>
            </button>
            <button data-module="lawmaker" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Lawmaker's Desk</h3>
                <p class="text-gray-400">Navigate the complexities of Port law and winemaking regulations.</p>
            </button>
            <button data-module="gastronome" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Gastronome's Table</h3>
                <p class="text-gray-400">Explore classic food pairings and local cuisine.</p>
            </button>
            <button data-module="critic" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Critic's Corner</h3>
                <p class="text-gray-400">Analyze vintages and iconic producers.</p>
            </button>
        </div>




        <div class="w-full max-w-4xl">
             <button data-module="flashcard" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300 w-full">
                <h3 class="text-xl font-bold mb-2">Flashcard Study</h3>
                <p class="text-gray-400">Build your knowledge with targeted review.</p>
            </button>
        </div>
    	
        <button id="ai-settings-btn" class="mt-8 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
            ⚙️ AI Settings
        </button>
    </div>




    <!-- Game Screen -->
    <div id="game-screen" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Content will be injected here -->
    </div>




    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-content-wrapper" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl modal-content overflow-y-auto">
            <!-- Modal content will be injected here -->
        </div>
    </div>




    <script>
        // This object contains the questions for the quiz modules
        const gameData = {
            historian: {
                title: "The Historian's Scroll",
                instructions: "For each of the challenges, arrange the historical events in chronological order from earliest to latest. Tap an event to add it to your timeline, then submit your answer.",
                questions: [
                    {
                        question: "Arrange these foundational events that established the Port trade.",
                        events: [
                            { text: "The Treaty of Windsor establishes a close alliance between Portugal and England.", date: 1386 },
                            { text: "The first officially recorded shipment of a wine explicitly named 'Vinho do Porto' occurs.", date: 1678 },
                            { text: "The Methuen Treaty grants Portuguese wines preferential import duties into England.", date: 1703 },
                            { text: "The Marquês de Pombal establishes the Companhia Geral da Agricultura das Vinhas do Alto Douro.", date: 1756 },
                            { text: "George Sandeman establishes his Port house, pioneering branding with 'The Don' logo.", date: 1790 },
                        ]
                    },
                    {
                        question: "Order the key 19th-century challenges and figures that reshaped the Douro.",
                        events: [
                            { text: "Joseph James Forrester, later Barão de Forrester, begins mapping the Douro River.", date: 1831 },
                            { text: "Forrester publishes his controversial pamphlet, 'A Word or Two about Port Wine'.", date: 1844 },
                            { text: "Oidium (powdery mildew) first strikes the Douro vineyards.", date: 1840 },
                            { text: "The phylloxera epidemic reaches the Douro, devastating vineyards.", date: 1870 },
                            { text: "Dona Antónia Adelaide Ferreira passes away, having become a dominant force in the Port trade.", date: 1896 },
                        ]
                    },
                    {
                        question: "Place these 20th-century regulatory and landmark events in the correct chronological order.",
                        events: [
                            { text: "The Sanctuary of Nossa Senhora dos Remédios in Lamego is completed.", date: 1905 },
                            { text: "The authoritarian Estado Novo regime establishes the Instituto do Vinho do Porto (IVP).", date: 1933 },
                            { text: "The iconic azulejo tile panels are installed at Pinhão Railway Station.", date: 1938 },
                            { text: "The first vintage of Barca Velha, the Douro's first iconic dry red, is produced.", date: 1952 },
                            { text: "Portugal's entry into the European Economic Community sparks a 'modern quality revolution'.", date: 1986 },
                        ]
                    },
                    {
                        question: "Sequence the key events of the modern era in the Douro.",
                        events: [
                            { text: "Portugal joins the European Economic Community, bringing new investment.", date: 1986 },
                            { text: "The 'entreposto' law is overturned, allowing producers to age and bottle wine at their quintas.", date: 1986 },
                            { text: "The IVP is renamed the IVDP to include unfortified Douro wines.", date: 2003 },
                            { text: "The pioneering 'Douro Boys' collective begins their collaboration.", date: 2003 },
                            { text: "The IVDP begins to authorize drip irrigation in cases of severe hydric stress.", date: 2019 },
                        ]
                    }
                ]
            },
            terroir: {
                title: "The Terroir Architect",
                instructions: "Answer 10 multiple-choice questions about the geology, geography, and climate of the Douro Valley.",
                questions: [
                    { q: "What is the overwhelmingly dominant bedrock of the Douro Valley, crucial for high-quality viticulture?", a: "Schist", o: ["Granite", "Limestone", "Basalt"] },
                    { q: "The parent rock of the Douro is officially identified as the Pre-Cambrian 'Complexo Xisto...' what?", a: "Grauvaquico", o: ["Basaltico", "Granitico", "Arenito"] },
                    { q: "Which mountain range to the west of the Douro creates a significant rain shadow effect?", a: "Serra do Marão", o: ["Serra da Estrela", "Pyrenees", "Picos de Europa"] },
                    { q: "Which of the three sub-regions is the coolest, wettest, and most fertile?", a: "Baixo Corgo", o: ["Cima Corgo", "Douro Superior", "Trás-os-Montes"] },
                    { q: "Which sub-region is considered the heart of quality Port production, where most famous quintas are located?", a: "Cima Corgo", o: ["Baixo Corgo", "Douro Superior", "Vinho Verde"] },
                    { q: "Which sub-region is the hottest, driest, and most extreme, extending to the Spanish border?", a: "Douro Superior", o: ["Cima Corgo", "Baixo Corgo", "Alentejo"] },
                    { q: "What is the average annual rainfall in the arid Douro Superior?", a: "Below 400-600 mm", o: ["900 - 1200 mm", "650 - 900 mm", "Over 1500 mm"] },
                    { q: "The vertical layering, or foliation, of the schist is crucial for what reason?", a: "It allows vine roots to penetrate deep to find water reserves.", o: ["It makes the soil highly fertile.", "It reflects sunlight onto the grapes.", "It prevents erosion completely."] },
                    { q: "The dominant soil units in the Douro, defined as very shallow soils over bedrock, are classified as what?", a: "Leptosols", o: ["Cambisols", "Regosols", "Luvisols"] },
                    { q: "In the vineyard classification system, a high content of which rock type results in a deduction of points?", a: "Granite", o: ["Schist", "Slate", "Quartz"] },
                    { q: "What is the most pressing viticultural risk in the Cima Corgo and Douro Superior, often causing vines to shut down photosynthesis?", a: "Drought and Heat Stress", o: ["Late Spring Frosts", "Hail", "Botrytis"] },
                    { q: "The entire system of terracing in the Douro is a monumental human effort primarily designed to mitigate what threat?", a: "Erosion", o: ["Frost", "Wind damage", "Animal pests"] },
                    { q: "Despite hot summers, what is a significant viticultural risk due to cold air sinking into valley bottoms on clear nights?", a: "Late Spring Frosts", o: ["Powdery Mildew", "Drought", "Sunburn"] },
                    { q: "What effect do the dark-colored stones on the soil surface have?", a: "They absorb heat during the day and radiate it back at night.", o: ["They cool the soil by reflecting sunlight.", "They increase the soil's water retention.", "They prevent weeds from growing."] },
                    { q: "The Douro is legally divided into how many sub-regions?", a: "Three", o: ["Two", "Four", "Five"] },
                    { q: "Wines from the Baixo Corgo typically form the base for which styles of Port?", a: "Entry-level Ruby and Tawny Ports", o: ["Vintage Ports", "Aged Tawny Ports", "Colheita Ports"] },
                    { q: "The soils of the Douro are naturally acidic, which has what effect on the vines?", a: "It naturally checks vigor and promotes concentration.", o: ["It encourages vigorous canopy growth.", "It makes nutrients more available.", "It requires heavy liming."] },
                    { q: "The Douro Demarcated Region is described as the world's largest area of what?", a: "Mountain viticulture", o: ["Organic viticulture", "Desert viticulture", "Coastal viticulture"] },
                    { q: "Vineyards in the Douro are planted at elevations ranging from 40 meters to over what?", a: "650 meters", o: ["250 meters", "450 meters", "1000 meters"] },
                    { q: "The Cima Corgo is the primary source for which top-tier Port styles?", a: "Vintage, LBV, and Aged Tawny", o: ["Basic Ruby and White Port", "Rosé Port", "Moscatel do Douro"] },
                    { q: "What is the typical texture of the soils derived from the region's schist bedrock?", a: "Light clay-schist", o: ["Heavy clay", "Sandy loam", "Silt"] },
                    { q: "The term 'distric' is used to categorize Douro soils that are what?", a: "Acidic", o: ["Less acidic", "Alkaline", "High in organic matter"] },
                    { q: "The rain shadow effect is the primary reason for the Douro's hot, dry, ______ climate.", a: "Continental", o: ["Maritime", "Mediterranean", "Subtropical"] },
                    { q: "What is the average annual rainfall in the Baixo Corgo, the wettest sub-region?", a: "900 - 1200 mm", o: ["< 400 - 600 mm", "650 - 900 mm", "400 - 500 mm"] },
                    { q: "The condition where intense heat causes vines to stop photosynthesis to conserve water is known as what?", a: "Hydric stress", o: ["Coulure", "Millerandage", "Veraison"] },
                    { q: "The low fertility of the schistous soils naturally results in what?", a: "Low yields of intensely concentrated berries", o: ["High yields of diluted berries", "Vigorous and leafy vines", "Early ripening"] },
                    { q: "The Douro River flows from the Spanish border to which coastal city?", a: "Porto", o: ["Lisbon", "Faro", "Coimbra"] },
                    { q: "Which sub-region has the highest density of vineyards?", a: "Baixo Corgo", o: ["Cima Corgo", "Douro Superior", "They are all equal"] },
                    { q: "The Douro Superior is the source for many of the finest and most long-lived examples of which Port style?", a: "Vintage Port", o: ["Basic Tawny", "White Port", "Ruby Reserve"] },
                    { q: "Which soil chemical property is more common in the hotter, drier Douro Superior?", a: "Eutric (less acidic)", o: ["Distric (acidic)", "Calcaric (calcareous)", "Salic (salty)"] },
                    { q: "The steep slopes in the Douro often exceed what gradient, making terracing necessary?", a: "30%", o: ["10%", "20%", "50%"] },
                    { q: "The excellent drainage of schist soils is beneficial in preventing what?", a: "Root rot during winter rains", o: ["Drought during summer", "Nutrient deficiencies", "Excessive vine vigor"] },
                    { q: "Which sub-region is described as having a 'transitional' climate between the other two?", a: "Cima Corgo", o: ["Baixo Corgo", "Douro Superior", "Minho"] },
                    { q: "The Douro's climate is characterized by a pronounced gradient that intensifies from west to ____.", a: "East", o: ["West", "North", "South"] },
                    { q: "What is the primary reason schist is preferred over granite for high-quality viticulture in the Douro?", a: "Its vertical fissures allow for deep root penetration to water.", o: ["It is more fertile than granite.", "It is easier to build terraces with.", "It retains less heat."] },
                    { q: "The low pH of the soil limits the availability of which key nutrients, naturally checking vine vigor?", a: "Potassium and phosphorus", o: ["Nitrogen and calcium", "Iron and magnesium", "Sulfur and zinc"] },
                    { q: "The protection from maritime influence is primarily due to what topographical feature?", a: "The Serra do Marão and Serra de Montemuro mountain ranges", o: ["The Douro River gorge", "The high plateau of the Meseta", "The coastal plains"] },
                    { q: "The town of Pinhão is located in the heart of which sub-region?", a: "Cima Corgo", o: ["Baixo Corgo", "Douro Superior", "Vila Real"] },
                    { q: "What is a major consequence of the Douro being the world's largest area of mountain viticulture?", a: "High labor costs and reliance on manual work", o: ["Uniform ripening across all vineyards", "Easy mechanization", "Low risk of erosion"] },
                    { q: "The intense summer heat in the Douro Superior can often exceed what temperature?", a: "40°C (104°F)", o: ["30°C (86°F)", "35°C (95°F)", "25°C (77°F)"] },
                    { q: "How does the terroir of the Douro force vines to struggle for survival?", a: "Through a combination of poor soils, steep slopes, and a hot, dry climate.", o: ["Through excessive rainfall and fertile soils.", "Through a cool, damp climate and flat terrain.", "Through highly alkaline soils and constant wind."] },
                    { q: "Which sub-region produces wines that are generally lighter and mature earlier?", a: "Baixo Corgo", o: ["Cima Corgo", "Douro Superior", "Porto"] },
                    { q: "The Douro Demarcated Region spans approximately how many hectares?", a: "250,000", o: ["50,000", "100,000", "500,000"] },
                    { q: "What is the typical character of grapes from the Douro Superior?", a: "Powerfully structured and deeply concentrated", o: ["Light, acidic, and floral", "Soft, fruity, and early-maturing", "High in sugar but low in tannins"] },
                    { q: "The climatic progression from west to east in the Douro is a direct result of what?", a: "The rain shadow effect", o: ["The soil type changing", "The altitude increasing", "The river flowing faster"] },
                    { q: "How does the schist soil contribute to phenolic maturity in grapes?", a: "By retaining and radiating heat, extending the ripening period.", o: ["By providing abundant water.", "By cooling the roots at night.", "By having high nitrogen content."] },
                    { q: "The low organic matter content of Douro soils contributes to what?", a: "Low natural vine vigor", o: ["High water retention", "Neutral soil pH", "Rapid vine growth"] },
                    { q: "Which is NOT a primary viticultural risk in the Douro?", a: "Hail damage", o: ["Drought", "Erosion", "Spring Frost"] },
                    { q: "The town of Lamego, an important early wine trade center, is located in which sub-region?", a: "Baixo Corgo", o: ["Cima Corgo", "Douro Superior", "Vila Real"] },
                    { q: "The unique combination of geology, topography, and climate in the Douro results in grapes of exceptional _____.", a: "Concentration and complexity", o: ["Yield and size", "Acidity and lightness", "Simplicity and fruitiness"] }
                ]
            },
            ampelographer: {
                title: "The Ampelographer's Challenge",
                instructions: "Answer 10 multiple-choice questions about the key grape varieties and vineyard techniques of the Douro. After a correct answer, you may have the option to generate an AI profile.",
                questions: [
                    { q: "Which grape is unanimously regarded as Portugal's premier red grape and the cornerstone of the finest Vintage Ports?", a: "Touriga Nacional", o: ["Touriga Franca", "Tinta Roriz", "Tinto Cão"], subjectType: 'grape', subjectName: 'Touriga Nacional' },
                    { q: "Which grape is the most widely planted in the Douro, valued for its reliability and aromatic contribution of roses and wildflowers?", a: "Touriga Franca", o: ["Touriga Nacional", "Tinta Barroca", "Tinta Roriz"], subjectType: 'grape', subjectName: 'Touriga Franca' },
                    { q: "Tinta Roriz is the Portuguese name for which famous Iberian grape variety?", a: "Tempranillo", o: ["Garnacha", "Monastrell", "Carignan"], subjectType: 'grape', subjectName: 'Tinta Roriz' },
                    { q: "Which early-ripening variety is often planted on cooler, north-facing slopes to preserve freshness and is valued for its ability to accumulate high sugar levels?", a: "Tinta Barroca", o: ["Tinto Cão", "Touriga Nacional", "Sousão"], subjectType: 'grape', subjectName: 'Tinta Barroca' },
                    { q: "Which ancient, notoriously low-yielding variety's name translates to 'red dog' and is prized for the finesse and bright acidity it brings to a blend?", a: "Tinto Cão", o: ["Tinta Amarela", "Bastardo", "Marufo"], subjectType: 'grape', subjectName: 'Tinto Cão' },
                    { q: "Touriga Franca is a natural cross of Touriga Nacional and which other variety?", a: "Marufo", o: ["Tinta Roriz", "Mourisco Tinto", "Bastardo"], subjectType: 'grape', subjectName: 'Touriga Franca' },
                    { q: "What is the defining aromatic signature of Touriga Nacional, often described as Earl Grey tea?", a: "Bergamot", o: ["Black pepper", "Eucalyptus", "Anise"], subjectType: 'grape', subjectName: 'Touriga Nacional' },
                    { q: "What are the ancient, narrow terraces supported by hand-built dry stone walls called?", a: "Socalcos", o: ["Patamares", "Lagares", "Quintas"], subjectType: 'viticulture', subjectName: 'Socalcos' },
                    { q: "What is the modern, machine-built terracing system that uses earthen banks instead of stone walls?", a: "Patamares", o: ["Socalcos", "Vinha ao Alto", "Mortuários"], subjectType: 'viticulture', subjectName: 'Patamares' },
                    { q: "What is the name for the modern planting system where vines are planted in vertical rows directly up and down the slope?", a: "Vinha ao Alto", o: ["Socalcos", "Patamares", "Encosta"], subjectType: 'viticulture', subjectName: 'Vinha ao Alto' },
                    { q: "What is the maximum authorized yield for Port production, as set by the IVDP?", a: "55 hl/ha", o: ["30 hl/ha", "75 hl/ha", "100 hl/ha"] },
                    { q: "The term 'Vinhas Velhas' refers to what?", a: "Old vine vineyards planted with a field blend of many varieties.", o: ["Vineyards planted only with Touriga Nacional.", "The youngest, most productive vineyards.", "A specific type of vine training system."], subjectType: 'viticulture', subjectName: 'Vinhas Velhas' },
                    { q: "Historically, what was the primary reason for planting field blends ('vinhas velhas')?", a: "As a risk-mitigation strategy to ensure a viable harvest.", o: ["To confuse regulators.", "Because nurseries only sold mixed cuttings.", "To increase yields."] },
                    { q: "Which of the 'top five' red varieties is known for its susceptibility to poor fruit set, a condition called coulure?", a: "Touriga Nacional", o: ["Touriga Franca", "Tinta Barroca", "Tinto Cão"], subjectType: 'grape', subjectName: 'Touriga Nacional' },
                    { q: "Which of the 'top five' red varieties is a sibling to Touriga Franca, also resulting from a cross of Touriga Nacional and Mourisco Tinto?", a: "Tinta Barroca", o: ["Tinta Roriz", "Tinto Cão", "Sousão"], subjectType: 'grape', subjectName: 'Tinta Barroca' },
                    { q: "Which of these is a principal white variety used for White Port?", a: "Gouveio", o: ["Touriga Nacional", "Sousão", "Tinto Cão"], subjectType: 'grape', subjectName: 'Gouveio' },
                    { q: "The teinturier grape Sousão is sometimes used in blends for what primary purpose?", a: "To add intense color", o: ["To add high acidity", "To lower the alcohol", "To provide floral aromas"], subjectType: 'grape', subjectName: 'Sousão' },
                    { q: "Which aromatic grape variety is used to produce the fortified Moscatel do Douro?", a: "Moscatel Galego", o: ["Malvasia Fina", "Viosinho", "Rabigato"], subjectType: 'grape', subjectName: 'Moscatel do Douro' },
                    { q: "In response to climate change, the IVDP now permits what practice in cases of severe hydric stress?", a: "Drip irrigation", o: ["Overhead sprinklers", "Chaptalization", "Acidification"], subjectType: 'viticulture', subjectName: 'Irrigation in the Douro' },
                    { q: "What is the typical planting density for modern vertical 'vinha ao alto' systems?", a: "4,500-5,000 vines/ha", o: ["3,000-3,800 vines/ha", "6,000-6,500 vines/ha", "Over 7,000 vines/ha"] },
                    { q: "Which red variety contributes robust structure and savory hints of resin and spice to a Port blend?", a: "Tinta Roriz", o: ["Tinta Barroca", "Tinto Cão", "Touriga Franca"], subjectType: 'grape', subjectName: 'Tinta Roriz' },
                    { q: "Which of these is NOT one of the 'Top Five' superior red varieties identified in the 1970s study?", a: "Sousão", o: ["Touriga Nacional", "Touriga Franca", "Tinta Barroca"], subjectType: 'grape', subjectName: 'Top Five Douro Grapes' },
                    { q: "Due to the harsh climate and poor soils, the regional average yield is significantly lower than the legal maximum, at around:", a: "30 hl/ha", o: ["55 hl/ha", "45 hl/ha", "20 hl/ha"] },
                    { q: "Which terracing system is a protected UNESCO World Heritage feature but is prohibitively expensive to build and maintain today?", a: "Socalcos", o: ["Patamares", "Vinha ao Alto", "Mortuários"], subjectType: 'viticulture', subjectName: 'Socalcos' },
                    { q: "Which modern terracing system is most susceptible to soil erosion?", a: "Patamares", o: ["Socalcos", "Lagares", "Barcos"] },
                    { q: "Which variety has thick skins that provide excellent resistance to rot, but is very low-yielding?", a: "Tinto Cão", o: ["Tinta Barroca", "Tinta Roriz", "Bastardo"], subjectType: 'grape', subjectName: 'Tinto Cão' },
                    { q: "Which of these is another name for the Tinta Amarela grape?", a: "Trincadeira", o: ["Bastardo", "Marufo", "Rufete"], subjectType: 'grape', subjectName: 'Tinta Amarela' },
                    { q: "Which of these is another name for the Bastardo grape?", a: "Trousseau", o: ["Pinot Noir", "Syrah", "Gamay"], subjectType: 'grape', subjectName: 'Bastardo' },
                    { q: "Which principal white grape is NOT typically used for dry Douro Branco wines?", a: "Moscatel Galego", o: ["Malvasia Fina", "Gouveio", "Viosinho"], subjectType: 'grape', subjectName: 'Douro White Grapes' },
                    { q: "The high levels of the terpene 'linalool' contribute to what signature aroma in Touriga Nacional?", a: "Floral and bergamot notes", o: ["Earthy and leather notes", "Spicy and peppery notes", "Jammy red fruit notes"], subjectType: 'grape', subjectName: 'Touriga Nacional' },
                    { q: "Viticulture in the Douro is often described as what form of agriculture?", a: "Heroic agriculture", o: ["Industrial agriculture", "Subsistence agriculture", "Organic agriculture"] },
                    { q: "The annual 'benefício' quota limits the amount of harvest that can legally be what?", a: "Fortified into Port wine", o: ["Made into Douro DOC table wine", "Exported", "Distilled into brandy"] },
                    { q: "Which of the 'top five' varieties is an early-ripening grape, as indicated by its Spanish name?", a: "Tinta Roriz", o: ["Tinta Barroca", "Tinto Cão", "Touriga Nacional"], subjectType: 'grape', subjectName: 'Tinta Roriz' },
                    { q: "Which planting system allows for the most efficient mechanization but carries the highest risk of erosion?", a: "Vinha ao Alto", o: ["Socalcos", "Patamares", "Field Blends"] },
                    { q: "According to IVDP regulations, what is not permitted for vineyards producing grapes for Port Wine?", a: "Wire trellising", o: ["Hand harvesting", "Irrigation", "Use of American rootstock"] },
                    { q: "The most common modern vine training systems in the Douro are Guyot and what else?", a: "Cordon de Royat", o: ["Gobelet", "Pergola", "Lyre"], subjectType: 'viticulture', subjectName: 'Vine Training in the Douro' },
                    { q: "Which red grape adds finesse and a perfumed lift to the final wine blend?", a: "Touriga Franca", o: ["Tinta Roriz", "Tinta Barroca", "Sousão"], subjectType: 'grape', subjectName: 'Touriga Franca' },
                    { q: "The landmark study that identified the 'Top Five' red varieties was conducted in which decade?", a: "1970s", o: ["1950s", "1980s", "1990s"] },
                    { q: "Which variety is sensitive to extreme heat and can suffer from berry shriveling?", a: "Tinta Barroca", o: ["Touriga Nacional", "Tinto Cão", "Touriga Franca"], subjectType: 'grape', subjectName: 'Tinta Barroca' },
                    { q: "Which variety contributes softness and ripe, jammy fruit character to a blend?", a: "Tinta Barroca", o: ["Tinto Cão", "Touriga Nacional", "Tinta Roriz"], subjectType: 'grape', subjectName: 'Tinta Barroca' },
                    { q: "What is a key structural contribution of Tinta Roriz to a blend?", a: "Body and firm tannins", o: ["High acidity", "Intense floral aromas", "Softness"] },
                    { q: "What is a key structural contribution of Tinto Cão to a blend?", a: "Acidity and longevity", o: ["Deep color", "High alcohol", "Jammy fruit"] },
                    { q: "The planting density on traditional socalcos could be as high as:", a: "6,000-6,500 vines per hectare", o: ["3,000-3,800 vines per hectare", "4,500-5,000 vines per hectare", "1,500-2,000 vines per hectare"] },
                    { q: "Which of these is NOT a principal white grape for Port?", a: "Alvarinho", o: ["Rabigato", "Viosinho", "Malvasia Fina"], subjectType: 'grape', subjectName: 'Douro White Grapes' },
                    { q: "The practice of co-fermenting dozens of interplanted varieties is a feature of what?", a: "Vinhas Velhas", o: ["Patamares", "Vinha ao Alto", "Quintas"] },
                    { q: "Which of the top five grapes is a late-ripening variety that thrives in the Douro's heat?", a: "Touriga Franca", o: ["Tinta Barroca", "Tinta Roriz", "Touriga Nacional"] },
                    { q: "What is the primary contribution of Touriga Nacional in a blend?", a: "Structure, color, and aging potential", o: ["Softness and high sugar", "Bright acidity and low tannins", "Aromatic lift and elegance"] },
                    { q: "Which system has the lowest planting densities, at around 3,000-3,800 vines/ha?", a: "Patamares", o: ["Socalcos", "Vinha ao Alto", "Traditional field blends"] },
                    { q: "Tinta Roriz is native to which country?", a: "Spain", o: ["Portugal", "France", "Italy"], subjectType: 'grape', subjectName: 'Tinta Roriz' },
                    { q: "Viticulture in the Douro is dictated by overcoming the challenges of what?", a: "Extreme terrain", o: ["Excessive rainfall", "Cool temperatures", "Fertile soils"] }
                ]
            },
            lawmaker: {
                title: "The Lawmaker's Desk",
                instructions: "Answer 10 multiple-choice questions about the appellation laws and winemaking regulations of the Douro.",
                questions: [
                    { q: "What is the name of the powerful governing body that regulates all Port and Douro DOC wines?", a: "IVDP (Instituto dos Vinhos do Douro e do Porto)", o: ["Casa do Douro", "Gremio dos Exportadores", "Companhia Geral"] },
                    { q: "The legally mandated range for the final alcohol content of most Port wine is:", a: "19% to 22% ABV", o: ["16.5% to 18.5% ABV", "22% to 25% ABV", "18% to 20% ABV"] },
                    { q: "The practice of chaptalization (adding sugar to must) in the Douro is:", a: "Strictly illegal", o: ["Common in cool years", "Permitted for white wines only", "Allowed up to 1% potential alcohol"] },
                    { q: "What is the 'benefício'?", a: "The annual quota that dictates how much of a vineyard's harvest can be made into Port.", o: ["A tax paid by Port shippers.", "The classification system for vineyards.", "The type of brandy used for fortification."] },
                    { q: "A vineyard's A-F classification is primarily used to determine its what?", a: "Benefício allocation", o: ["Selling price per bottle", "Eligibility for Douro DOC status", "Maximum permitted yield"] },
                    { q: "What is the minimum time a Vintage Port must be aged in wood before bottling?", a: "Approximately 2 years", o: ["4 to 6 years", "Minimum 7 years", "There is no minimum"] },
                    { q: "A Late Bottled Vintage (LBV) Port must be aged in large vats for how long?", a: "4 to 6 years", o: ["2 to 3 years", "Minimum 7 years", "At least 10 years"] },
                    { q: "A Colheita is a Tawny Port from a single vintage that must be aged in small casks for a minimum of how many years?", a: "7 years", o: ["2 years", "4 years", "10 years"] },
                    { q: "What is the name of the official register of all vineyards in the Douro, maintained by the IVDP?", a: "Cadastro", o: ["Benefício", "Selo de Garantia", "Quinta"] },
                    { q: "What is the highest quality potential rating a vineyard can receive in the 'cadastro' system?", a: "A", o: ["F", "DOCG", "Grand Cru"] },
                    { q: "The addition of 'aguardente' (grape spirit) serves what primary purpose in Port production?", a: "To arrest fermentation", o: ["To increase acidity", "To add color", "To clarify the wine"] },
                    { q: "The 'Porto DOC' designation is reserved exclusively for what type of wine from the Douro Demarcated Region?", a: "Fortified wine", o: ["Unfortified red wine", "Sparkling wine", "Late harvest wine"] },
                    { q: "What is the typical alcohol strength of the 'aguardente' used for fortification?", a: "77% ABV", o: ["40% ABV", "55% ABV", "96% ABV"] },
                    { q: "Which Port style must be held in bottle for a minimum of 3 years before release and is a blend of vintages?", a: "Crusted Port", o: ["Late Bottled Vintage", "Colheita", "Vintage Port"] },
                    { q: "The term 'Vinho Regional Duriense' is equivalent to which European wine classification?", a: "PGI (Protected Geographical Indication)", o: ["PDO (Protected Designation of Origin)", "DOCG", "Qualitätswein"] },
                    { q: "What is the highest tier of the Portuguese wine classification system?", a: "DOC (Denominação de Origem Controlada)", o: ["Vinho Regional (VR)", "IPR", "Vinho"] },
                    { q: "In the vineyard classification system, which factor is rewarded with the most potential points?", a: "Location", o: ["Grape Varieties", "Vine Age", "Slope"] },
                    { q: "Which factor in the vineyard classification system can result in the largest point deduction?", a: "Altitude", o: ["Yield", "Bedrock", "Variety"] },
                    { q: "A Vintage Port must be bottled between July 1 of the 2nd year and what date?", a: "June 30 of the 3rd year", o: ["December 31 of the 2nd year", "December 31 of the 6th year", "May 1 of the 2nd year"] },
                    { q: "What is the minimum ABV for a Light Dry White Port?", a: "16.5%", o: ["19%", "18%", "20%"] },
                    { q: "What is the name of the shallow, open-topped granite tanks used for traditional foot treading?", a: "Lagares", o: ["Pipas", "Socalcos", "Barcos Rabelos"] },
                    { q: "The 'Selo de Garantia' is what?", a: "The official guarantee seal from the IVDP on every bottle.", o: ["A tax on Port exports.", "The name of the fortification brandy.", "A list of approved producers."] },
                    { q: "Which Port style has an average age on the label (e.g., 10, 20, 30, 40) but is a blend of multiple vintages?", a: "Aged Tawny", o: ["Colheita", "Vintage Port", "Late Bottled Vintage"] },
                    { q: "The national classification 'Vinho' was formerly known as what?", a: "Vinho de Mesa (Table Wine)", o: ["Vinho Regional", "DOC", "Garrafeira"] },
                    { q: "The Douro Demarcated Region was first officially demarcated in what year, making it the world's first?", a: "1756", o: ["1678", "1933", "1880"] },
                    { q: "Who pioneered the development of 'robotic lagares' to replicate human treading?", a: "The Symington family", o: ["The Fladgate Partnership", "Quinta do Noval", "Niepoort"] },
                    { q: "Which of these is NOT one of the 12 factors evaluated in the vineyard classification system?", a: "Producer Reputation", o: ["Location", "Altitude", "Grape Varieties"] },
                    { q: "The 'Douro DOC' designation applies to what type of wines?", a: "Unfortified red, white, and rosé wines", o: ["Fortified Port wine only", "Only wines from the Douro Superior", "Sparkling wines"] },
                    { q: "What is 'Colheita Tardia'?", a: "A sweet, unfortified late harvest wine", o: ["A single vintage Tawny Port", "A sparkling wine from the Douro", "A type of rosé Port"] },
                    { q: "Which Port style is aged reductively in large, often inert vessels?", a: "Ruby styles (including Vintage and LBV)", o: ["Tawny styles", "Colheita", "White Port"] },
                    { q: "Which Port style is aged oxidatively in smaller oak casks?", a: "Tawny styles", o: ["Ruby styles", "Vintage Port", "LBV"] },
                    { q: "The legal designation for quality sparkling wine from the region is:", a: "Espumante do Douro (VEQPRD)", o: ["Cava do Douro", "Prosecco Duriense", "Crémant de Porto"] },
                    { q: "What is the name of the traditional 550-liter wooden cask used for aging and transporting Port?", a: "Pipa", o: ["Lagar", "Balseiro", "Tonneau"] },
                    { q: "A 'Single Quinta Vintage' Port is a wine from a single estate from a single vintage, typically produced in years that are:", a: "Good, but not generally 'declared' as classic.", o: ["The very best, classic years.", "The poorest quality years.", "Blended across multiple years."] },
                    { q: "Which of these is a key legal difference between an LBV and a Vintage Port?", a: "LBV is aged in wood much longer (4-6 years vs ~2).", o: ["Vintage Port is a blend of years, LBV is not.", "LBV must be from A-rated vineyards only.", "Vintage Port is filtered, LBV is not."] },
                    { q: "What is the IPR (Indicação de Proveniência Regulamentada) category?", a: "A now largely obsolete transitional category for regions seeking DOC status.", o: ["A higher level than DOC.", "The category for all fortified wines.", "A category for experimental wines."] },
                    { q: "What is the purpose of the 'benefício'?", a: "To control volume, maintain price stability, and prioritize quality.", o: ["To encourage higher yields.", "To tax growers based on vineyard size.", "To promote specific grape varieties."] },
                    { q: "The law requires that grapes for sparkling wine production are usually sourced from where?", a: "Higher-altitude vineyards", o: ["The Douro Superior", "Vineyards close to the river", "The oldest vineyards"] },
                    { q: "What does a lower letter grade (e.g., F) mean for a vineyard's 'benefício'?", a: "It receives the smallest allocation.", o: ["It receives the largest allocation.", "It is not allowed to grow grapes.", "It must only produce Douro DOC wine."] },
                    { q: "The practice of acidification with tartaric acid in Port winemaking is:", a: "Not common, as structure relies more on tannin, sugar, and alcohol.", o: ["Mandatory for all red Ports.", "Illegal, like chaptalization.", "Common for White Ports only."] },
                    { q: "A producer can label their wine as Duriense IGP if they use what?", a: "Grape varieties not sanctioned under the stricter DOC rules.", o: ["A specific fortification method.", "Grapes from outside the Douro region.", "A minimum of 10 years of aging."] },
                    { q: "Which of these is NOT a sub-region of the Douro DOC?", a: "Vila Nova de Gaia", o: ["Baixo Corgo", "Cima Corgo", "Douro Superior"] },
                    { q: "What is the term for a farm or estate in the Douro?", a: "Quinta", o: ["Casa", "Bodega", "Château"] },
                    { q: "The fundamental division between Ruby and Tawny styles is created and enforced by what?", a: "Strict IVDP aging regulations", o: ["The grape varieties used", "The sub-region of origin", "The type of brandy used"] },
                    { q: "What is the primary aim of both traditional and modernist vinification approaches?", a: "To achieve the highest quality of extraction in a short time.", o: ["To minimize skin contact.", "To achieve a long, slow fermentation.", "To lower the final alcohol content."] },
                    { q: "When was the 'entreposto' law, which mandated aging in Vila Nova de Gaia, overturned?", a: "1986", o: ["1756", "1933", "2003"] },
                    { q: "The Portuguese term for 'late harvest' is:", a: "Colheita Tardia", o: ["Vindima Tardia", "Colheita", "Tardia"] },
                    { q: "Which body, along with the IVDP, makes up the modern tripartite regulatory structure?", a: "Casa do Douro (growers' association) and Gremio dos Exportadores (shippers' guild)", o: ["The Portuguese Government", "The European Union Wine Council", "The Douro Boys Collective"] },
                    { q: "What must be stated on the label of a Colheita Port?", a: "The vintage year and the bottling date", o: ["The average age", "The vineyard classification", "The grape blend"] },
                    { q: "What is the key difference between a Tawny Reserve and a 10-Year-Old Tawny?", a: "Tawny Reserve has a minimum age (7 yrs), while 10-Year-Old must match an age profile.", o: ["Tawny Reserve is a single vintage, 10-Year-Old is not.", "10-Year-Old has a minimum age, Tawny Reserve does not.", "There is no legal difference."] }
                ]
            },
            gastronome: {
                title: "The Gastronome's Table",
                instructions: "Answer 10 multiple-choice questions about the cuisine, ingredients, and classic pairings of Porto. After a correct answer, you may have the option to generate an AI explanation.",
                questions: [
                    { q: "Which dish is so iconic to Porto that its residents are nicknamed 'Tripeiros' (tripe-eaters)?", a: "Tripas à Moda do Porto", o: ["Francesinha", "Bacalhau à Gomes de Sá", "Cabrito Assado"], subjectType: 'dish', subjectName: 'Tripas à Moda do Porto' },
                    { q: "What is a 'Francesinha'?", a: "A formidable sandwich with steak, ham, and sausage, covered in cheese and a spicy sauce.", o: ["A type of salted cod casserole.", "A stew made from tripe and white beans.", "A roasted kid goat dish."], subjectType: 'dish', subjectName: 'Francesinha' },
                    { q: "Which world-famous classic pairing matches the intense fruit and power of a mature Vintage Port with the salty, piquant character of a blue cheese?", a: "Vintage Port & Stilton Cheese", o: ["Tawny Port & Cheddar Cheese", "Ruby Port & Goat Cheese", "White Port & Brie"], subjectType: 'wine_pairing', subjectName: 'Vintage Port and Stilton' },
                    { q: "The nutty, caramel notes of an Aged Tawny Port pair beautifully with which type of desserts?", a: "Desserts with almonds, caramel, or dried fruits (e.g., crème brûlée)", o: ["Rich dark chocolate cakes", "Lemon tarts and citrus sorbets", "Fresh berry pavlova"], subjectType: 'wine_pairing', subjectName: 'Aged Tawny Port and Desserts' },
                    { q: "What is 'Bacalhau'?", a: "Salted cod, a staple of Portuguese cuisine.", o: ["A type of smoked sausage.", "A creamy sheep's milk cheese.", "A local breed of cattle."], subjectType: 'ingredient', subjectName: 'Bacalhau' },
                    { q: "What is the classic aperitif in Porto, often made with dry White Port?", a: "Porto Tónico (Port and Tonic)", o: ["Port and Coke", "Port Sangria", "A Port-based Negroni"], subjectType: 'beverage', subjectName: 'Porto Tónico' },
                    { q: "Which PDO-protected, intensely aromatic, creamy sheep's milk cheese from a nearby mountain range is a sublime pairing for Port?", a: "Queijo Serra da Estrela", o: ["Manchego", "Parmigiano-Reggiano", "Feta"], subjectType: 'ingredient', subjectName: 'Queijo Serra da Estrela' },
                    { q: "The vibrant, dark fruit character of a Late Bottled Vintage (LBV) Port is an excellent match for what?", a: "Rich dark chocolate desserts", o: ["Grilled fish", "Light salads", "Vanilla ice cream"], subjectType: 'wine_pairing', subjectName: 'LBV Port and Chocolate' },
                    { q: "What is 'Aguardente Vínica'?", a: "High-quality, aged grape brandy from the Douro, similar to Cognac.", o: ["The neutral spirit used to fortify Port.", "A pomace brandy made from leftover grape skins.", "A sweet cherry liqueur."], subjectType: 'beverage', subjectName: 'Aguardente Vínica' },
                    { q: "Which sweet liqueur is made by infusing sour cherries ('ginja') in aguardente?", a: "Ginjinha", o: ["Licor Beirão", "Amêndoa Amarga", "Aguardente Bagaceira"], subjectType: 'liqueur', subjectName: 'Ginjinha' },
                    { q: "What is 'Cabrito Assado com Arroz de Forno', a traditional feast dish in the Douro Valley?", a: "Roasted kid goat with oven-baked rice", o: ["Pork and clams", "Seafood rice", "Duck rice"], subjectType: 'dish', subjectName: 'Cabrito Assado' },
                    { q: "What is 'Posta Mirandesa'?", a: "A thick, bone-in steak from the protected Mirandesa breed of cattle.", o: ["A grilled sardine platter.", "A type of pork sausage.", "A vegetable stew."], subjectType: 'dish', subjectName: 'Posta Mirandesa' },
                    { q: "Which of these is a PDO-protected olive oil from the region adjacent to the Douro?", a: "Azeite de Trás-os-Montes", o: ["Olio di Puglia", "Kalamata Olive Oil", "Huile de Provence"], subjectType: 'ingredient', subjectName: 'Azeite de Trás-os-Montes' },
                    { q: "What is 'Aguardente Bagaceira'?", a: "A rustic, fiery pomace brandy distilled from leftover grape skins and seeds.", o: ["A smooth, aged grape brandy.", "A neutral spirit for fortification.", "An herbal liqueur."], subjectType: 'spirit', subjectName: 'Aguardente Bagaceira' },
                    { q: "Licor Beirão is a popular Portuguese liqueur made from a secret recipe of what?", a: "12 botanicals, including spices and citrus", o: ["Sour cherries", "Almonds", "Coffee beans"], subjectType: 'liqueur', subjectName: 'Licor Beirão' },
                    { q: "Which PDO-protected meat comes from the native Bísaro pig?", a: "Carne de Bísaro Transmontano", o: ["Carne Mirandesa", "Jamón Ibérico", "Prosciutto di Parma"], subjectType: 'ingredient', subjectName: 'Carne de Bísaro Transmontano' },
                    { q: "What is the origin story of 'Tripas à Moda do Porto'?", a: "Citizens gave the best meat to ships, leaving only offal for themselves.", o: ["It was created by a French chef for a Portuguese king.", "It was a dish invented to use leftover fish.", "It was a traditional harvest festival meal."], subjectType: 'dish', subjectName: 'Tripas à Moda do Porto' },
                    { q: "A chilled dry White Port served with tonic is typically accompanied by what snacks?", a: "Salted almonds and olives", o: ["Chocolate and cheese", "Cakes and pastries", "Spicy sausages"], subjectType: 'wine_pairing', subjectName: 'White Port Aperitif' },
                    { q: "The Mateus Palace, famous from the rosé wine label, is a testament to the wealth brought to northern Portugal by what?", a: "The wine trade", o: ["The cork industry", "Fishing", "Olive oil production"], subjectType: 'gastronomy', subjectName: 'Mateus Palace' },
                    { q: "What does 'Posta' refer to in the dish 'Posta Mirandesa'?", a: "A thick steak or chop", o: ["A type of marinade", "A cooking method", "A side dish"] },
                    { q: "Aguardente Vínica do Douro is matured in what, giving it a complex profile?", a: "Oak casks", o: ["Stainless steel tanks", "Glass demijohns", "Clay amphorae"], subjectType: 'beverage', subjectName: 'Aguardente Vínica' },
                    { q: "Which dish originated in Porto and is one of Portugal's most famous recipes for salted cod?", a: "Bacalhau à Gomes de Sá", o: ["Bacalhau à Brás", "Bacalhau com Natas", "Pastéis de Bacalhau"], subjectType: 'dish', subjectName: 'Bacalhau à Gomes de Sá' },
                    { q: "The gastronomic culture of the Douro is described as being built upon what?", a: "High-quality local ingredients and traditional, hearty dishes", o: ["Modern, light, and molecular gastronomy", "Spicy and exotic international influences", "Simple, unadorned grilled seafood"] },
                    { q: "What are 'enchidos'?", a: "Smoked sausages", o: ["White beans", "Hard-boiled eggs", "Black olives"], subjectType: 'ingredient', subjectName: 'Enchidos' },
                    { q: "A Ruby Reserve Port is a good match for what type of cheese?", a: "Strong, hard cheeses like mature farmhouse Cheddar", o: ["Creamy blue cheese like Stilton", "Soft goat cheese", "Fresh mozzarella"], subjectType: 'wine_pairing', subjectName: 'Ruby Port and Cheese' },
                    { q: "While the beer market is dominated by national brands, some Douro wine estates like Quinta de La Rosa have begun doing what?", a: "Brewing their own artisanal beers", o: ["Distilling gin", "Making cider", "Producing soft drinks"], subjectType: 'beverage', subjectName: 'Craft Beer in the Douro' },
                    { q: "Which of these is NOT a key ingredient in Bacalhau à Gomes de Sá?", a: "Tomatoes", o: ["Shredded salt cod", "Thinly sliced potatoes", "Onions and garlic"], subjectType: 'dish', subjectName: 'Bacalhau à Gomes de Sá' },
                    { q: "Which PDO ingredient from the Douro is often used in confectionery?", a: "Amêndoa Douro (Almonds)", o: ["Azeite de Trás-os-Montes (Olive Oil)", "Carne Mirandesa (Beef)", "Queijo Serra da Estrela (Cheese)"] },
                    { q: "A 20-Year-Old Tawny Port would be a classic pairing for what dessert?", a: "Pecan pie", o: ["Dark chocolate lava cake", "Key lime pie", "Strawberry shortcake"], subjectType: 'wine_pairing', subjectName: 'Aged Tawny Port and Desserts' },
                    { q: "Unaged 'bagaceira' is typically what color?", a: "Clear", o: ["Amber", "Dark brown", "Red"], subjectType: 'spirit', subjectName: 'Aguardente Bagaceira' },
                    { q: "What are the key ingredients of the formidable 'Francesinha' sandwich?", a: "Steak, ham, sausage, cheese, and a spicy tomato-beer sauce", o: ["Tripe, white beans, and smoked sausages", "Salted cod, potatoes, and onions", "Roasted goat and rice"] },
                    { q: "What is the traditional feast to mark the end of the grape harvest in the Douro?", a: "Cabrito Assado (Roasted Kid)", o: ["A sardine festival", "A bacalhau cook-off", "A francesinha eating contest"] },
                    { q: "What is the key difference between Aguardente Vínica and Aguardente Bagaceira?", a: "Vínica is distilled from wine, Bagaceira from pomace.", o: ["Vínica is unaged, Bagaceira is aged.", "Vínica is sweet, Bagaceira is dry.", "Vínica is from the Douro, Bagaceira is from Lisbon."] },
                    { q: "The pairing of Vintage Port and Stilton is a classic example of what principle?", a: "Complementing sweetness with saltiness", o: ["Matching acidity with fat", "Contrasting textures", "Echoing aromas"] },
                    { q: "Which popular national liqueur is NOT specifically from the north but is enjoyed there?", a: "Ginjinha", o: ["Aguardente Vínica do Douro", "Licor de Singeverga", "Licor de Medronho"] },
                    { q: "A high-quality Ruby Reserve Port has the fruit character to stand up to what?", a: "Rich dark chocolate", o: ["Delicate white fish", "Spicy Asian cuisine", "Creamy pasta dishes"] },
                    { q: "The culinary landscape of Porto and the Douro is defined by dishes that are...", a: "Rich and comforting", o: ["Light and spicy", "Modern and deconstructed", "Exclusively vegetarian"] },
                    { q: "What is the defining feature of the sauce served with a Francesinha?", a: "It is a signature spicy tomato and beer sauce.", o: ["It is a creamy white sauce with cheese.", "It is a green sauce made with herbs and garlic.", "It is a sweet and sour sauce with fruit."] },
                    { q: "An Aged Tawny's flavor profile of dried figs and walnuts makes it a simple, perfect match for what?", a: "A plate of dried figs and walnuts", o: ["A platter of fresh tropical fruit", "A bowl of spicy olives", "A selection of cured meats"] },
                    { q: "Which of these is NOT a key local PDO/PGI ingredient mentioned?", a: "Arroz Carolino (rice)", o: ["Azeite de Trás-os-Montes (olive oil)", "Carne Mirandesa (beef)", "Queijo Serra da Estrela (cheese)"] },
                    { q: "What is the typical way to serve Licor Beirão?", a: "Neat or on the rocks as a digestif", o: ["Mixed with tonic as an aperitif", "Warmed with spices", "Blended into a frozen cocktail"] },
                    { q: "Which of these is a key garnish for Bacalhau à Gomes de Sá?", a: "Hard-boiled eggs and black olives", o: ["Fresh cilantro and lime", "Toasted breadcrumbs and parmesan", "Sliced chili peppers and mint"] },
                    { q: "The name 'Porto Tónico' highlights the two key ingredients: Port and what?", a: "Tonic water", o: ["Soda water", "Lemonade", "Ginger ale"] },
                    { q: "Which is the most iconic dish of the city of Porto itself?", a: "Tripas à Moda do Porto", o: ["Cabrito Assado", "Posta Mirandesa", "Bacalhau à Gomes de Sá"] },
                    { q: "The flavor profile of Aguardente Vínica is often compared to what other spirits?", a: "Cognac or Armagnac", o: ["Vodka or Gin", "Whisky or Bourbon", "Rum or Tequila"] },
                    { q: "Why is 'Cabrito Assado' particularly associated with the end of the grape harvest?", a: "It is a celebratory feast dish.", o: ["Goats are only available in autumn.", "The oven is only lit after the harvest.", "It is a required offering to the saints."] },
                    { q: "Which food pairing principle explains why the tannins in a Ruby Port work well with the fat in a hard cheese?", a: "Tannins cut through fat, cleansing the palate", o: ["Sweetness balances saltiness", "Acidity enhances flavor", "Matching intensity"] },
                    { q: "The cuisine of the Douro reflects its agricultural heritage and historical ties to what?", a: "The sea", o: ["The mountains of Spain", "The spice trade routes", "French culinary traditions"] },
                    { q: "What is 'Carne Mirandesa'?", a: "Beef from a protected, local cattle breed", o: ["Pork from the native Bísaro pig", "A type of cured ham", "Lamb from the Serra da Estrela"] },
                    { q: "Which is a more modern culinary icon of Porto, created in the 1950s?", a: "Francesinha", o: ["Tripas à Moda do Porto", "Bacalhau à Gomes de Sá", "Cabrito Assado"] }
                ]
            },
            critic: {
                title: "The Critic's Corner",
                instructions: "Answer 10 multiple-choice questions about the vintages, producers, and market context of Port wine. After a correct answer, you may have the option to generate an AI tasting note.",
                questions: [
                    { q: "Which producer is renowned for its powerful, structured, and exceptionally long-lived Vintage Ports, with Quinta de Vargellas as a key estate?", a: "Taylor Fladgate", o: ["Fonseca", "Dow's", "Graham's"], subjectType: 'producer', subjectName: 'Taylor Fladgate' },
                    { q: "Which producer is known for a more opulent, rich, and voluptuous style of Vintage Port?", a: "Fonseca", o: ["Dow's", "Warre's", "Taylor Fladgate"], subjectType: 'producer', subjectName: 'Fonseca' },
                    { q: "Which Symington-owned house is famed for its characteristically drier, more austere, and powerfully structured Vintage Ports?", a: "Dow's", o: ["Graham's", "Warre's", "Cockburn's"], subjectType: 'producer', subjectName: "Dow's" },
                    { q: "Which estate produces the legendary 'Nacional' Vintage Port from a small parcel of ungrafted, pre-phylloxera vines?", a: "Quinta do Noval", o: ["Quinta do Vesuvio", "Quinta de Vargellas", "Quinta dos Malvedos"], subjectType: 'producer', subjectName: 'Quinta do Noval Nacional' },
                    { q: "Which vintage is widely considered a modern benchmark, one of the greatest of the 21st century, producing exceptionally powerful and elegant wines?", a: "2011", o: ["2018", "2014", "2009"], subjectType: 'vintage', subjectName: '2011 Port Vintage' },
                    { q: "The 2017 and 2016 vintages were both generally declared. How does the 2016 vintage characteristically differ from the hotter 2017?", a: "2016 is more balanced, with vibrant acidity and elegant structure.", o: ["2016 is much more powerful and concentrated.", "2016 was a Single Quinta year, not generally declared.", "2016 produced better Tawny than Vintage Port."], subjectType: 'vintage', subjectName: '2016 Port Vintage' },
                    { q: "Which of these is considered a 'Value Champion', consistently offering outstanding quality-to-price ratio, especially for its LBV?", a: "Niepoort", o: ["Quinta do Noval", "Taylor Fladgate", "Wine & Soul"], subjectType: 'producer', subjectName: 'Niepoort' },
                    { q: "Which boutique winery, founded by a winemaking couple, represents the new wave of small, quality-obsessed producers and has achieved cult status for its 'Pintas' Vintage Port?", a: "Wine & Soul", o: ["Quinta da Pedra Alta", "Niepoort", "Quinta do Crasto"], subjectType: 'producer', subjectName: 'Wine & Soul' },
                    { q: "Wines aged reductively in large, inert vessels to preserve primary fruit are known as what style?", a: "Ruby Styles", o: ["Tawny Styles", "Colheita", "White Port"], subjectType: 'wine_style', subjectName: 'Ruby Port' },
                    { q: "Wines aged oxidatively in small oak casks, developing nutty and dried fruit aromas, are known as what style?", a: "Tawny Styles", o: ["Ruby Styles", "Vintage Port", "LBV"], subjectType: 'wine_style', subjectName: 'Tawny Port' },
                    { q: "Which producer, part of the Symington portfolio, represents a richer, sweeter, and more luscious style of Port?", a: "Graham's", o: ["Dow's", "Warre's", "Taylor Fladgate"], subjectType: 'producer', subjectName: "Graham's" },
                    { q: "The 2003 vintage across Europe was marked by an extremely hot summer. What was the character of the 2003 Vintage Ports?", a: "Deeply colored, aromatic, and full-bodied with ripe fruit.", o: ["Lean, acidic, and elegant.", "A very poor vintage that was not declared.", "Light in color and suitable for early drinking."], subjectType: 'vintage', subjectName: '2003 Port Vintage' },
                    { q: "In years that are good but not exceptional enough for a 'general' declaration, what might a major house release instead?", a: "A Single Quinta Vintage Port", o: ["An Aged Tawny Port", "A Crusted Port", "A Ruby Reserve"], subjectType: 'wine_style', subjectName: 'Single Quinta Vintage Port' },
                    { q: "Who is the influential modern figurehead of Niepoort, known for pioneering unfortified Douro wines and experimental Port styles?", a: "Dirk van der Niepoort", o: ["Charles Symington", "David Guimaraens", "Jorge Serôdio Borges"], subjectType: 'producer', subjectName: 'Niepoort' },
                    { q: "The 2007 vintage was a classic, generally declared year praised for what characteristics?", a: "Great purity, aromatic definition, and balance", o: ["Immense power and tannic grip", "Low yields and extreme concentration", "Early-maturing, soft fruit"], subjectType: 'vintage', subjectName: '2007 Port Vintage' },
                    { q: "Which producer is considered the oldest British Port house and a reliable source for high-quality, value-oriented LBV and Single Quinta ports?", a: "Warre's", o: ["Croft", "Sandeman", "Dow's"], subjectType: 'producer', subjectName: "Warre's" },
                    { q: "How are the cooler, elegant Single Quinta vintages like 2013, 2014, and 2015 often positioned in the market?", a: "They often offer great value and earlier drinking.", o: ["They are the most expensive and long-lived wines.", "They are only sold in Portugal.", "They are primarily used for blending."], subjectType: 'vintage', subjectName: 'Single Quinta Vintages' },
                    { q: "Which of these is NOT considered one of the 'First Growth Equivalent' iconic producers?", a: "Warre's", o: ["Taylor Fladgate", "Fonseca", "Dow's"], subjectType: 'producer', subjectName: 'Port Producer Hierarchy' },
                    { q: "What is the primary characteristic of a Ruby style Port?", a: "Primary fruit aromas like blackberry and cassis", o: ["Nutty, caramel, and dried fruit aromas", "A pale amber-tawny color", "A dry, austere finish"], subjectType: 'wine_style', subjectName: 'Ruby Port' },
                    { q: "What is the primary characteristic of an Aged Tawny Port?", a: "A complex bouquet of dried fruits, nuts, and caramel", o: ["Vibrant purple color and fresh berry flavors", "Powerful tannins requiring decades of aging", "A simple, fruity profile for immediate drinking"], subjectType: 'wine_style', subjectName: 'Aged Tawny Port' },
                    { q: "The 2018 vintage was a rare third consecutive declaration for some. How is its quality generally described?", a: "Variable, but the best are rich, concentrated, and powerful.", o: ["Uniformly classic and elegant across all houses.", "A complete failure due to a wet spring.", "Light and aromatic, for early consumption."], subjectType: 'vintage', subjectName: '2018 Port Vintage' },
                    { q: "Which producer's top cuvée is the 'Guimaraens Vintage Port', released in very good but not 'classic' declared years?", a: "Fonseca", o: ["Taylor Fladgate", "Dow's", "Graham's"], subjectType: 'producer', subjectName: 'Fonseca' },
                    { q: "Which producer's Single Quinta estate is Quinta do Bomfim?", a: "Dow's", o: ["Graham's", "Taylor Fladgate", "Warre's"], subjectType: 'producer', subjectName: 'Quinta do Bomfim' },
                    { q: "Which producer's Single Quinta estate is Quinta dos Malvedos?", a: "Graham's", o: ["Dow's", "Fonseca", "Warre's"], subjectType: 'producer', subjectName: 'Quinta dos Malvedos' },
                    { q: "The 2022 vintage was characterized by what extreme weather conditions?", a: "Remarkably hot and dry with record temperatures", o: ["Cool and wet with a late harvest", "Perfectly balanced and mild", "Severe spring frosts"], subjectType: 'vintage', subjectName: '2022 Port Vintage' },
                    { q: "Which newer estate has gained acclaim for a modern, polished style of Vintage Port that is approachable even when young?", a: "Quinta da Pedra Alta", o: ["Quinta do Noval", "Wine & Soul", "Niepoort"], subjectType: 'producer', subjectName: 'Quinta da Pedra Alta' },
                    { q: "A 'general' or 'classic' declaration occurs when what happens?", a: "Most of the major houses declare the vintage.", o: ["Only one house declares the vintage.", "The IVDP declares the vintage for everyone.", "A vintage is of average quality."], subjectType: 'vintage', subjectName: 'Vintage Port Declaration' },
                    { q: "The 2017 vintage was noted for being hot and dry, producing wines of incredible...?", a: "Intensity and concentration", o: ["Elegance and acidity", "Lightness and floral character", "Softness and early accessibility"], subjectType: 'vintage', subjectName: '2017 Port Vintage' },
                    { q: "The flagship wine of Taylor Fladgate is its Vintage Port, but what is its even rarer, more prestigious cuvée?", a: "Quinta de Vargellas Vinha Velha Vintage Port", o: ["Nacional Vintage Port", "'The Stone Terraces' Vintage Port", "Guimaraens Vintage Port"], subjectType: 'wine', subjectName: 'Taylor Fladgate Quinta de Vargellas Vinha Velha' },
                    { q: "Which producer is known for the rare 'Garrafeira' style of Port?", a: "Niepoort", o: ["Taylor Fladgate", "Sandeman", "Ferreira"], subjectType: 'producer', subjectName: 'Niepoort' },
                    { q: "The 2012 vintage was a Single Quinta year noted for producing what style of wines?", a: "Concentrated yet balanced and fine wines", o: ["Powerful, hot-vintage wines", "Light and simple wines", "Aromatic but structurally weak wines"], subjectType: 'vintage', subjectName: '2012 Port Vintage' },
                    { q: "How is the market for Port wine changing, according to the document?", a: "Sales are declining by volume but rising by value due to premiumization.", o: ["Sales are increasing rapidly in both volume and value.", "The market is shifting entirely to unfortified Douro wines.", "Basic Ruby and Tawny are becoming more expensive than Vintage Port."], subjectType: 'critic', subjectName: 'Port Wine Market' },
                    { q: "What is the key sensory difference between a Ruby and a Tawny Port?", a: "Ruby expresses primary fruit; Tawny expresses secondary/tertiary oxidative notes.", o: ["Ruby is always sweeter than Tawny.", "Tawny is always higher in alcohol than Ruby.", "Ruby is aged in bottle, Tawny is aged in wood."] },
                    { q: "The 2008 vintage was a cool year that yielded wines with what characteristics?", a: "Fresh wines with good tannic grip", o: ["Ripe, jammy, and powerful wines", "Very low acidity and soft tannins", "Deep color but diluted flavor"], subjectType: 'vintage', subjectName: '2008 Port Vintage' },
                    { q: "Which producer is NOT part of the Symington Family Estates portfolio?", a: "Taylor Fladgate", o: ["Dow's", "Graham's", "Warre's"], subjectType: 'producer', subjectName: 'Symington Family Estates' },
                    { q: "Which producer is NOT part of The Fladgate Partnership?", a: "Dow's", o: ["Taylor Fladgate", "Fonseca", "Croft"], subjectType: 'producer', subjectName: 'The Fladgate Partnership' },
                    { q: "The 2014 vintage was described as:", a: "A difficult, cool, and wet vintage with very few declarations", o: ["A classic, perfectly balanced vintage", "A hot and powerful vintage", "An average but reliable vintage"], subjectType: 'vintage', subjectName: '2014 Port Vintage' },
                    { q: "What is the primary appeal of Aged Tawny Ports for consumers?", a: "They are complex and ready to drink immediately upon release.", o: ["They require decades of cellaring to be enjoyable.", "They are the most affordable style of Port.", "They have intense, fresh fruit flavors."] },
                    { q: "What is the primary appeal of Vintage Port for collectors?", a: "Its profound capacity to evolve and gain complexity over decades.", o: ["It is ready to drink upon release.", "It is the most common and accessible style.", "It does not require decanting."] },
                    { q: "The critical perception of Port is defined by its inherent sweetness, high alcohol, and what other quality?", a: "Concentrated richness", o: ["High acidity", "Light body", "Savory character"] },
                    { q: "Which producer's entry-level Tawny Port is widely praised for its quality-to-price ratio?", a: "Dow's", o: ["Quinta do Noval", "Fonseca", "Niepoort"], subjectType: 'producer', subjectName: "Dow's" },
                    { q: "Which vintage was declared by most houses and is described as being wonderfully harmonious and suited for long-term aging, though less powerful than 2011?", a: "2007", o: ["2009", "2013", "2005"], subjectType: 'vintage', subjectName: '2007 Port Vintage' },
                    { q: "What is a defining characteristic of the wines from the 'hot, ripe vintages' like 2003, 2009, and 2022?", a: "They are rich and full-bodied, sometimes lacking finesse.", o: ["They are elegant, fresh, and aromatic.", "They are light, acidic, and best consumed young.", "They are structurally weak and do not age well."] },
                    { q: "The 2004 vintage was a Single Quinta year noted for producing what kind of wines?", a: "Very balanced and symmetrical wines", o: ["Extremely powerful and tannic wines", "Light and simple wines", "Aromatic but short-lived wines"], subjectType: 'vintage', subjectName: '2004 Port Vintage' },
                    { q: "The 'Douro Boys' are most famous for pioneering what?", a: "High-quality unfortified Douro table wines", o: ["A new style of Rosé Port", "The use of robotic lagares", "A new vineyard classification system"] },
                    { q: "Which producer owns Quinta do Vesuvio, where all Port is still made by foot treading?", a: "Symington Family Estates", o: ["The Fladgate Partnership", "Sogrape", "AXA Millésimes"], subjectType: 'producer', subjectName: 'Quinta do Vesuvio' },
                    { q: "What critical consensus defines the aging potential of Vintage Port?", a: "It can evolve for a century or more.", o: ["It should be consumed within 5 years of release.", "It peaks at 10 years and then declines.", "It does not improve with bottle age."] },
                    { q: "The 'special categories' of Port, which account for 45% of sales by value, exclude which styles?", a: "Basic Ruby, Tawny, white, and rosé", o: ["Vintage, LBV, and Aged Tawny", "Colheita and Crusted", "Single Quinta and Reserve"] },
                    { q: "Which producer is credited with creating the first iconic unfortified Douro red wine, Barca Velha?", a: "Ferreira (Casa Ferreirinha)", o: ["Ramos Pinto", "Niepoort", "Quinta do Crasto"], subjectType: 'producer', subjectName: 'Ferreira' },
                    { q: "Which historical figure was a vocal critic of heavy fortification, advocating for 'natural' unfortified wines over a century ahead of his time?", a: "Barão de Forrester", o: ["Marquês de Pombal", "George Sandeman", "Dirk van der Niepoort"], subjectType: 'producer', subjectName: 'Barão de Forrester' }
                ]
            }
        };




        // This new object contains comprehensive flashcard data, separate from the quiz questions
        const flashcardData = {
            historian: [
                { q: "The Treaty of Windsor, establishing a close alliance between Portugal and England, was signed in what year?", a: "1386" },
                { q: "In what year did the first officially recorded shipment of 'Vinho do Porto' occur?", a: "1678" },
                { q: "The Methuen Treaty, giving Portuguese wines preferential import duties in England, was signed in what year?", a: "1703" },
                { q: "The Marquês de Pombal established the Companhia Geral and demarcated the Douro region in what year?", a: "1756" },
                { q: "Who was the Portuguese Prime Minister responsible for demarcating the Douro in 1756?", a: "Sebastião José de Carvalho e Melo, the Marquês de Pombal" },
                { q: "What were the 335 stone pillars used to mark the boundaries of the Douro region called?", a: "Marcos pombalinos" },
                { q: "The Douro was the world's first what?", a: "Officially demarcated and regulated wine appellation" },
                { q: "The phylloxera epidemic, which devastated the Douro's vineyards, arrived in what decade?", a: "1870s" },
                { q: "What was the long-term solution to phylloxera in the Douro?", a: "Grafting Vitis vinifera vines onto resistant American rootstock" },
                { q: "The Instituto do Vinho do Porto (IVP) was established by the Estado Novo regime in what year?", a: "1933" },
                { q: "In what year was the IVP's mandate expanded to include unfortified Douro wines, renaming it the IVDP?", a: "2003" },
                { q: "Portugal's entry into the European Economic Community, sparking a 'modern quality revolution', occurred in what year?", a: "1986" },
                { q: "What was the 'entreposto' law?", a: "A law that mandated all Port wine be aged in and shipped from Vila Nova de Gaia." },
                { q: "The 'Douro Boys' collective, who championed modern unfortified Douro wines, began collaborating in what year?", a: "2003" },
                { q: "Who was the formidable 19th-century Portuguese entrepreneur known as 'Ferreirinha'?", a: "Dona Antónia Adelaide Ferreira" },
                { q: "Who was the pioneering 19th-century cartographer who created the first detailed maps of the Douro and was a critic of heavy fortification?", a: "Barão de Forrester (Joseph James Forrester)" },
                { q: "Which marketing visionary founded his Port house in 1790 and developed the iconic 'The Don' logo?", a: "George Sandeman" },
                { q: "The first vintage of Barca Velha, the Douro's first iconic dry red wine, was produced in what year?", a: "1952" },
                { q: "What was the crisis that prompted the Marquês de Pombal to demarcate the Douro?", a: "Rampant fraud, with producers adulterating wines with elderberry juice." },
                { q: "What are 'socalcos'?", a: "Ancient, narrow stone terraces built by hand." },
                { q: "What are abandoned terraces, victims of phylloxera, sometimes called?", a: "Mortuários (graveyards)" },
                { q: "The modern technique of fortification involves arresting fermentation by adding what?", a: "Grape brandy, or aguardente" },
                { q: "The Pinhão Railway Station is celebrated for its magnificent tile panels depicting the Port wine cycle. What are these tiles called?", a: "Azulejos" },
                { q: "Which pioneering group includes Quinta do Crasto, Niepoort, and Quinta do Vale Meão?", a: "The 'Douro Boys'" },
                { q: "What was the primary economic driver for the development of the Port trade by the British?", a: "To find a reliable alternative to French claret, which was often subject to embargoes." },
                { q: "What was the original reason for adding brandy to the wines of the Douro?", a: "To stabilize the wine for the long sea voyage to England." },
                { q: "Which city was a vital center of the early wine trade before Porto's ascendancy?", a: "Lamego" },
                { q: "The development of viticulture in the Douro was significantly influenced by which monastic orders in the Middle Ages?", a: "The Cistercians" },
                { q: "The Mateus Palace appeared on the label of what globally best-selling wine in the mid-20th century?", a: "Mateus Rosé" },
                { q: "What plague struck the Douro in the 1840s, preceding phylloxera?", a: "Oidium (powdery mildew)" },
                { q: "The Companhia established by Pombal was granted what power over the Port trade?", a: "A monopoly" },
                { q: "What is the name of the growers' association in the tripartite regulatory structure?", a: "Casa do Douro" },
                { q: "What is the name of the shippers' guild in the tripartite regulatory structure?", a: "Gremio dos Exportadores" },
                { q: "What is the Portuguese term for the estates or farms within the Douro Valley?", a: "Quintas" },
                { q: "Who was the winemaker responsible for creating Barca Velha?", a: "Fernando Nicolau de Almeida" },
                { q: "What was the title of Forrester's 1844 pamphlet that condemned the trade's practices?", a: "'A Word or Two about Port Wine'" },
                { q: "What do the azulejo tiles at Pinhão station depict?", a: "The entire traditional cycle of Port wine production." },
                { q: "What are the iconic boats historically used to transport wine barrels down the river called?", a: "Barco rabelo" },
                { q: "The modern quality revolution has seen the dramatic rise of what wine category from the region?", a: "Unfortified Douro DOC table wines" },
                { q: "The prestige of Port wine has historically been defined by what kind of model?", a: "A producer/brand-based model" },
                { q: "Who were the primary drivers of the early Port trade, establishing 'casas' in Porto?", a: "British merchant families" },
                { q: "The long sea voyage from Porto to England often caused the early, unfortified wines to do what?", a: "Spoil" },
                { q: "When did the modern technique of arresting fermentation midway through become widespread?", a: "During the 18th century" },
                { q: "The addition of spirit during fermentation preserves what in the wine, creating a sweeter style?", a: "Natural grape sugars" },
                { q: "The 1933 establishment of the IVP occurred under which political regime?", a: "The authoritarian Estado Novo regime" },
                { q: "The overturning of the 'entreposto' law fostered the growth of what type of producers?", a: "Smaller, estate-focused producers (quintas)" },
                { q: "What modern winemaking technique was introduced by the 'Douro Boys'?", a: "Mechanized lagares and temperature-controlled fermentation" },
                { q: "Which iconic producer was cemented as a national brand by Dona Antónia Ferreira?", a: "Ferreira" },
                { q: "Which iconic cultural landmark is a stunning Baroque and Rococo sanctuary in Lamego?", a: "Sanctuary of Nossa Senhora dos Remédios" },
                { q: "Forrester's controversial vision, over a century ahead of its time, was to produce what from the Douro?", a: "'Natural,' unfortified wines" }
            ],
            terroir: [
                { q: "What is the dominant bedrock of the Douro Valley?", a: "Schist" },
                { q: "The parent material for Douro's soil is officially known as the Pre-Cambrian 'Complexo Xisto...' what?", a: "Grauvaquico (Graywacke Schist Complex)" },
                { q: "What is the name of the mountain range that creates a crucial rain shadow over the Douro?", a: "Serra do Marão" },
                { q: "What are the three legally defined sub-regions of the Douro, from west to east?", a: "Baixo Corgo, Cima Corgo, Douro Superior" },
                { q: "Which sub-region is the coolest and wettest, producing lighter wines?", a: "Baixo Corgo" },
                { q: "Which sub-region is considered the heartland of quality Port, being warmer and drier?", a: "Cima Corgo" },
                { q: "Which sub-region is the hottest, driest, and most extreme?", a: "Douro Superior" },
                { q: "What is the average annual rainfall in the Baixo Corgo?", a: "900 - 1200 mm" },
                { q: "What is the average annual rainfall in the arid Douro Superior?", a: "Often below 400-600 mm" },
                { q: "The vertical layering of schist is vital for allowing vine roots to do what?", a: "Penetrate deep into bedrock to find water reserves." },
                { q: "What effect do the dark surface stones have on the microclimate?", a: "They absorb and radiate heat, moderating night temperatures and extending ripening." },
                { q: "The dominant, very shallow soil units in the Douro are classified as what?", a: "Leptosols" },
                { q: "In the vineyard classification system, which rock type is penalized with a point deduction?", a: "Granite" },
                { q: "What is the most significant viticultural risk in the Douro, especially in the east?", a: "Drought and heat stress (hydric stress)" },
                { q: "The entire system of terracing is primarily designed to mitigate what constant threat?", a: "Soil erosion" },
                { q: "What climatic risk can occur in spring, damaging new shoots in valley bottoms?", a: "Late spring frosts" },
                { q: "The Douro is the world's largest area of what type of viticulture?", a: "Mountain viticulture" },
                { q: "The soils of the Douro are naturally low in which key nutrients, helping to check vigor?", a: "Potassium and phosphorus" },
                { q: "The climate of the Douro is best described as hot, dry, and what?", a: "Continental" },
                { q: "Vineyards in the Douro are planted at elevations ranging from 40m to over what?", a: "650 meters" },
                { q: "The town of Pinhão lies in the center of which sub-region?", a: "Cima Corgo" },
                { q: "The low fertility of the schistous soils results in low yields of what kind of berries?", a: "Small, thick-skinned berries with intensely concentrated flavors." },
                { q: "What does the term 'distric' refer to when classifying Douro soils?", a: "Acidic" },
                { q: "What does the term 'eutric' refer to when classifying Douro soils?", a: "Less acidic" },
                { q: "The climate of the Baixo Corgo shows the most influence from what?", a: "The Atlantic Ocean (maritime influence)" },
                { q: "The steep slopes of Douro vineyards often exceed what gradient?", a: "30%" },
                { q: "Full phenolic maturity refers to the development of deep color, complex flavors, and what else?", a: "Ripe tannins" },
                { q: "The Douro Demarcated Region follows which river?", a: "The Douro River" },
                { q: "Which sub-region has the highest density of vineyards?", a: "Baixo Corgo" },
                { q: "Which sub-region has the lowest density of vineyards?", a: "Douro Superior" },
                { q: "What is the term for the steep earthen banks that separate modern 'patamares' terraces?", a: "Taludes" },
                { q: "The natural acidity (low pH) of the soil has what effect on vine vigor?", a: "It naturally checks (limits) it." },
                { q: "The heat retention of the schist stones ensures that grapes achieve full phenolic maturity alongside what other type of maturity?", a: "Sugar accumulation (sugar ripeness)" },
                { q: "Which sub-region is the primary source for top-tier Vintage, LBV, and Aged Tawny Ports?", a: "Cima Corgo" },
                { q: "The Douro Superior extends to the border with which country?", a: "Spain" },
                { q: "The Douro's terroir is described as a landscape of what?", a: "Extremes" },
                { q: "What is the primary soil texture in the Douro?", a: "Light clay-schist" },
                { q: "The character of Port wine is fundamentally dictated by what?", a: "The formidable terroir of the Douro Demarcated Region." },
                { q: "What is a 'mortuário'?", a: "An abandoned, ancient stone terrace, literally a 'graveyard'." },
                { q: "The excellent drainage of schist soils is particularly important during which season?", a: "Winter, due to heavy downpours." },
                { q: "What is the typical summer temperature in the Douro Superior?", a: "Extreme, often exceeding 40°C (104°F)" },
                { q: "What is the character of wines from the Baixo Corgo?", a: "Generally lighter and mature earlier." },
                { q: "What is the character of wines from the Douro Superior?", a: "Powerful, intense, and tannic." },
                { q: "The climatic gradient in the Douro intensifies from the humid west to the ___ east.", a: "Arid, continental" },
                { q: "What is the most important single factor in the Douro's viticultural potential?", a: "The bedrock (schist)" },
                { q: "The IVDP's soil classifications are based on which international system?", a: "The FAO system" },
                { q: "What is the primary reason the Douro is a hot, dry region?", a: "The rain shadow created by the Serra do Marão mountains." },
                { q: "Which sub-region is the largest by area?", a: "Douro Superior" },
                { q: "Why is deep root penetration essential for vines in the Douro?", a: "To survive the arid summer months by accessing water stored in bedrock fissures." },
                { q: "The struggle of the vines in the steep schistous terraces produces grapes of profound what?", a: "Concentration and character" }
            ],
            ampelographer: [
                { q: "Which grape is considered the cornerstone of the finest Vintage Ports?", a: "Touriga Nacional" },
                { q: "Which grape is the most widely planted in the Douro?", a: "Touriga Franca" },
                { q: "Tinta Roriz is the Portuguese name for which grape?", a: "Tempranillo" },
                { q: "Which grape's name translates to 'red dog'?", a: "Tinto Cão" },
                { q: "Which variety is often planted on cooler, north-facing slopes due to its sensitivity to extreme heat?", a: "Tinta Barroca" },
                { q: "What is the signature aromatic of Touriga Nacional, attributed to high levels of terpenes like linalool?", a: "Bergamot or Earl Grey tea" },
                { q: "Touriga Franca is a natural cross between Touriga Nacional and what other grape?", a: "Marufo" },
                { q: "What is the term for the ancient, narrow, hand-built stone terraces?", a: "Socalcos" },
                { q: "What is the term for the modern, wider, machine-built terraces with earthen banks?", a: "Patamares" },
                { q: "What is the term for planting vines in vertical rows up and down a slope?", a: "Vinha ao Alto" },
                { q: "What does the term 'Vinhas Velhas' mean?", a: "Old vines, typically a field blend of many intermingled varieties." },
                { q: "What is the maximum authorized yield for Port production set by the IVDP?", a: "55 hectoliters per hectare (hl/ha)" },
                { q: "Due to the harsh conditions, what is the more typical average yield in the Douro?", a: "Around 30 hl/ha" },
                { q: "What viticultural practice was historically forbidden but is now authorized in cases of severe hydric stress?", a: "Drip irrigation" },
                { q: "What is the primary contribution of Touriga Nacional to a blend?", a: "Structure, body, color, and aging potential" },
                { q: "What is the primary contribution of Touriga Franca to a blend?", a: "Finesse, aromatic lift, and elegance" },
                { q: "What is the primary contribution of Tinta Roriz to a blend?", a: "Robust structure, body, and firm tannins" },
                { q: "What is the primary contribution of Tinta Barroca to a blend?", a: "Alcohol, softness, and a ripe, jammy fruit character" },
                { q: "What is the primary contribution of Tinto Cão to a blend?", a: "Bright acidity, finesse, and complexity for aging" },
                { q: "Which teinturier grape is used for its intense color?", a: "Sousão" },
                { q: "Which grape variety is known for its susceptibility to poor fruit set ('coulure')?", a: "Touriga Nacional" },
                { q: "Which of the 'top five' varieties is known for its early-ripening nature?", a: "Tinta Roriz (from Spanish 'temprano')" },
                { q: "Tinta Barroca is a sibling of Touriga Franca, sharing which parent?", a: "Touriga Nacional" },
                { q: "Which variety has very thick skins, making it resistant to rot, but is notoriously low-yielding?", a: "Tinto Cão" },
                { q: "Name a principal white grape variety used for White Port.", a: "Malvasia Fina (or Gouveio, Rabigato, Viosinho)" },
                { q: "What is the aromatic grape used for Moscatel do Douro?", a: "Moscatel Galego" },
                { q: "The landmark study identifying the 'Top Five' red grapes was conducted in which decade?", a: "1970s" },
                { q: "What is the primary purpose of 'vinhas velhas' (field blends) in the modern era?", a: "They are highly prized for the complexity and concentration they provide." },
                { q: "Which terracing system allows for greater mechanization but is more susceptible to erosion?", a: "Patamares" },
                { q: "Which vine training systems are most common in modern Douro vineyards?", a: "Single or double Guyot and Cordon de Royat" },
                { q: "IVDP regulations forbid what for vineyards producing grapes for Port?", a: "Wire trellising" },
                { q: "What is the typical planting density on traditional 'socalcos'?", a: "Around 6,000-6,500 vines/ha" },
                { q: "What is the lowest planting density, found on 'patamares'?", a: "Around 3,000-3,800 vines/ha" },
                { q: "Which of the 'top five' is native to Spain?", a: "Tinta Roriz" },
                { q: "What is the most recent change to irrigation laws in the Douro, as of a 2023 Decree-Law?", a: "The restriction that irrigation could only occur in pre-identified zones was removed." },
                { q: "Besides bergamot, what is a common floral note associated with Touriga Nacional?", a: "Violet" },
                { q: "Besides roses, what is a common floral note associated with Touriga Franca?", a: "Wildflowers" },
                { q: "What is the genetic lineage of Tinta Roriz (Tempranillo)?", a: "Albillo Mayor x Benedicto" },
                { q: "What are the two parents of both Touriga Franca and Tinta Barroca?", a: "Touriga Nacional and Marufo (or Mourisco Tinto)" },
                { q: "What is another name for Tinta Amarela?", a: "Trincadeira" },
                { q: "What is another name for Bastardo?", a: "Trousseau" },
                { q: "Which of the top five grapes is a late-ripening variety?", a: "Tinto Cão" },
                { q: "Which terracing system is considered a UNESCO World Heritage feature?", a: "Socalcos" },
                { q: "What is the most efficient system for mechanization, suitable for slopes up to 40%?", a: "Vinha ao Alto" },
                { q: "The Douro has over how many authorized grape varieties?", a: "Over 100" },
                { q: "Which of the 'top five' is valued for its hardiness and productivity?", a: "Touriga Franca" },
                { q: "What is the primary viticultural challenge for Tinta Barroca?", a: "It is sensitive to extreme heat and can suffer from berry shriveling." },
                { q: "How is vine training traditionally done in the Douro?", a: "Low to the ground" },
                { q: "Why was the 1970s study on grape varieties so important?", a: "It identified the five superior red varieties that now form the basis of modern quality vineyards." },
                { q: "What is the main advantage of the 'Vinha ao Alto' system regarding sun exposure?", a: "It provides better sun exposure for the canopy." }
            ],
            lawmaker: [
                { q: "What is the name of the powerful governing body that regulates all Port and Douro wines?", a: "IVDP (Instituto dos Vinhos do Douro e do Porto)" },
                { q: "What is the legally mandated alcohol range for most Port styles?", a: "19% to 22% ABV" },
                { q: "Is chaptalization (the addition of sugar to must) legal in Portugal?", a: "No, it is strictly illegal." },
                { q: "What is the 'benefício' system?", a: "The annual quota, set by the IVDP, that determines the quantity of grapes that can be fortified into Port wine." },
                { q: "A vineyard's A-F rating in the 'cadastro' directly determines what?", a: "Its 'benefício' allocation" },
                { q: "How long is a Vintage Port aged in wood before bottling?", a: "Approximately 2 years (bottled between July 1 of the 2nd year and June 30 of the 3rd year)." },
                { q: "How long is a Late Bottled Vintage (LBV) Port aged in large vats?", a: "4 to 6 years" },
                { q: "A Colheita is a single-vintage Tawny aged in cask for a minimum of how many years?", a: "7 years" },
                { q: "What is the 'cadastro'?", a: "The official and comprehensive register of all vineyards in the Douro Demarcated Region." },
                { q: "What is the highest quality rating a vineyard can receive?", a: "A" },
                { q: "What is the name of the neutral grape spirit used to fortify Port?", a: "Aguardente" },
                { q: "The 'Porto DOC' designation is exclusively for what type of wine?", a: "Fortified wine from the Douro Demarcated Region." },
                { q: "What is the typical alcohol strength of 'aguardente' used for fortification?", a: "77% ABV" },
                { q: "Which Port style is a blend of vintages, bottled unfiltered, and must be aged for a minimum of 3 years in bottle before release?", a: "Crusted Port" },
                { q: "What is the Portuguese classification equivalent to the French Vin de Pays or European PGI?", a: "Vinho Regional (VR)" },
                { q: "What is the highest tier of the Portuguese wine classification system?", a: "DOC (Denominação de Origem Controlada)" },
                { q: "Which factor in the vineyard rating system offers the most potential points?", a: "Location" },
                { q: "Which factor in the vineyard rating system can give the largest point deduction?", a: "Altitude" },
                { q: "When can a Vintage Port be released for sale?", a: "After May 1 of the 2nd year following the harvest." },
                { q: "What is the minimum ABV for a Light Dry White Port?", a: "16.5%" },
                { q: "What is the name of the shallow, open-topped granite tanks used for traditional foot treading?", a: "Lagares" },
                { q: "What is the 'Selo de Garantia'?", a: "The official IVDP guarantee seal affixed to the neck of every certified bottle." },
                { q: "Which Port style indicates an average age on the label (e.g., 10, 20, 30, 40)?", a: "Aged Tawny" },
                { q: "What was the previous name for the most basic wine classification, 'Vinho'?", a: "Vinho de Mesa (Table Wine)" },
                { q: "In what year was the Douro first demarcated, making it the world's first regulated appellation?", a: "1756" },
                { q: "Who pioneered the use of 'robotic lagares'?", a: "The Symington Family Estates" },
                { q: "Which of these is NOT a factor in the 'cadastro' rating system?", a: "The reputation of the quinta owner" },
                { q: "The 'Douro DOC' applies to which wines?", a: "Unfortified red, white, and rosé wines from the Douro region." },
                { q: "What is a 'Colheita Tardia'?", a: "A sweet, unfortified late-harvest wine." },
                { q: "Which aging method is characteristic of Ruby styles?", a: "Reductive aging in large, inert vessels." },
                { q: "Which aging method is characteristic of Tawny styles?", a: "Oxidative aging in smaller oak casks." },
                { q: "What is the legal designation for quality sparkling wine from the Douro?", a: "Espumante do Douro (VEQPRD)" },
                { q: "What is a 'pipa'?", a: "A traditional 550-liter wooden cask for aging and transport." },
                { q: "What is the primary difference between a 'Vintage Port' and a 'Single Quinta Vintage Port'?", a: "Single Quinta Ports are typically made in good but not 'classic' declared years." },
                { q: "What is a key legal difference between LBV and Vintage Port?", a: "LBV has a much longer mandatory aging period in wood (4-6 years)." },
                { q: "What does the Vinho Regional designation 'Duriense' cover?", a: "The same geographic area as the Douro DOC, but with more flexible rules." },
                { q: "What is the purpose of the 'benefício'?", a: "To control Port volume, maintain price stability, and ensure quality." },
                { q: "From where are grapes for sparkling wine production typically sourced?", a: "Higher-altitude vineyards for high acidity." },
                { q: "What does a low grade (e.g., F) in the 'cadastro' mean for a vineyard's 'benefício'?", a: "It receives the smallest allocation, if any." },
                { q: "Is acidification a common practice in Port winemaking?", a: "No, structure relies more on the interplay of sugar, alcohol, and tannins." },
                { q: "What is the name of the traditional flat-bottomed boat used to transport Port barrels?", a: "Barco Rabelo" },
                { q: "What is the name of the growers' association?", a: "Casa do Douro" },
                { q: "What is the name of the shippers' guild?", a: "Gremio dos Exportadores" },
                { q: "What does 'Quinta' mean?", a: "A farm or estate, the fundamental unit of wine production." },
                { q: "The division between Ruby and Tawny styles is enforced by what?", a: "Strict IVDP aging regulations." },
                { q: "When was the 'entreposto' law that mandated aging in Gaia overturned?", a: "1986" },
                { q: "What must a Colheita Port state on its label besides the vintage?", a: "The date of bottling" },
                { q: "What is the minimum aging requirement for a Tawny Reserve Port?", a: "Minimum 7 years in small casks." },
                { q: "Which law was overturned in 1986, allowing for the rise of estate-bottled Ports?", a: "The 'entreposto' law" },
                { q: "Fermentation for Port is halted when the must reaches approximately what potential alcohol level?", a: "5-9% ABV" }
            ],
            gastronome: [
                { q: "Porto's residents are nicknamed 'Tripeiros' after which iconic local dish?", a: "Tripas à Moda do Porto" },
                { q: "What is a 'Francesinha'?", a: "A formidable sandwich with steak, ham, and sausage, covered in cheese and a spicy sauce." },
                { q: "What is the world-famous classic pairing for a mature Vintage Port?", a: "Stilton Cheese" },
                { q: "The nutty, caramel notes of an Aged Tawny Port pair beautifully with what type of desserts?", a: "Desserts with almonds, caramel, or dried fruits" },
                { q: "What is 'Bacalhau'?", a: "Salted cod" },
                { q: "What is the classic aperitif in Porto, made with dry White Port and tonic?", a: "Porto Tónico" },
                { q: "Which PDO-protected sheep's milk cheese is a sublime pairing for Port?", a: "Queijo Serra da Estrela" },
                { q: "The vibrant, dark fruit of an LBV Port is an excellent match for what?", a: "Rich dark chocolate desserts" },
                { q: "What is 'Aguardente Vínica'?", a: "High-quality, aged grape brandy from the Douro" },
                { q: "Which liqueur is made by infusing sour cherries ('ginja') in aguardente?", a: "Ginjinha" },
                { q: "What is 'Cabrito Assado com Arroz de Forno'?", a: "Roasted kid goat with oven-baked rice" },
                { q: "What is 'Posta Mirandesa'?", a: "A thick, bone-in steak from the Mirandesa breed of cattle." },
                { q: "Which PDO-protected product is a key flavor base for many Douro dishes?", a: "Azeite de Trás-os-Montes (Olive Oil)" },
                { q: "What is 'Aguardente Bagaceira'?", a: "A rustic pomace brandy distilled from grape skins and seeds." },
                { q: "Licor Beirão is a popular herbal liqueur with a secret recipe of how many botanicals?", a: "12" },
                { q: "Which PDO-protected meat comes from the native Bísaro pig?", a: "Carne de Bísaro Transmontano" },
                { q: "What is the origin story of 'Tripas à Moda do Porto'?", a: "Citizens gave the best meat to ships, leaving only offal for themselves." },
                { q: "A chilled dry White Port is typically accompanied by what snacks?", a: "Salted almonds and olives" },
                { q: "The Mateus Palace became famous from its depiction on the label of what wine?", a: "Mateus Rosé" },
                { q: "What does 'Posta' refer to in 'Posta Mirandesa'?", a: "A thick steak or chop" },
                { q: "Aguardente Vínica do Douro is matured in what?", a: "Oak casks" },
                { q: "Which dish is a famous Porto casserole of salt cod, potatoes, and onions?", a: "Bacalhau à Gomes de Sá" },
                { q: "The gastronomic culture of the Douro is described as what?", a: "Hearty and traditional" },
                { q: "What are 'enchidos'?", a: "Smoked sausages" },
                { q: "A Ruby Reserve Port pairs well with what kind of cheese?", a: "Strong, hard cheeses like mature Cheddar" },
                { q: "Some Douro wine estates, like Quinta de La Rosa, have begun producing what other beverage?", a: "Artisanal beers" },
                { q: "Which of these is NOT a key ingredient in Bacalhau à Gomes de Sá?", a: "Tomatoes" },
                { q: "Which PDO ingredient from the Douro is used in confectionery?", a: "Amêndoa Douro (Almonds)" },
                { q: "A 20-Year-Old Tawny Port would be a classic pairing for what dessert?", a: "Pecan pie" },
                { q: "Unaged 'bagaceira' is typically what color?", a: "Clear" },
                { q: "What are the key ingredients of a 'Francesinha'?", a: "Steak, ham, sausage, cheese, and a spicy tomato-beer sauce" },
                { q: "What is the traditional feast to mark the end of the grape harvest?", a: "Cabrito Assado (Roasted Kid)" },
                { q: "What is the key difference between Aguardente Vínica and Aguardente Bagaceira?", a: "Vínica is distilled from wine, Bagaceira from pomace." },
                { q: "The pairing of Vintage Port and Stilton is a classic example of complementing sweetness with what?", a: "Saltiness" },
                { q: "Which popular national liqueur is NOT specifically from the north but is enjoyed there?", a: "Ginjinha" },
                { q: "A high-quality Ruby Reserve Port has the fruit character to stand up to what?", a: "Rich dark chocolate" },
                { q: "The culinary landscape of Porto and the Douro is defined by dishes that are what?", a: "Rich and comforting" },
                { q: "What is the defining feature of the sauce on a Francesinha?", a: "It is a signature spicy tomato and beer sauce." },
                { q: "An Aged Tawny's flavor profile makes it a simple, perfect match for what?", a: "A plate of dried figs and walnuts" },
                { q: "Which of these is NOT a key local PDO/PGI ingredient mentioned?", a: "Arroz Carolino (rice)" },
                { q: "How is Licor Beirão typically served?", a: "Neat or on the rocks as a digestif" },
                { q: "What is a key garnish for Bacalhau à Gomes de Sá?", a: "Hard-boiled eggs and black olives" },
                { q: "What does the name 'Porto Tónico' refer to?", a: "Port and Tonic water" },
                { q: "Which is the most iconic dish of the city of Porto itself?", a: "Tripas à Moda do Porto" },
                { q: "Aguardente Vínica's flavor profile is often compared to what?", a: "Cognac or Armagnac" },
                { q: "Why is 'Cabrito Assado' associated with the end of the grape harvest?", a: "It is a celebratory feast dish." },
                { q: "The tannins in a Ruby Port work well with the fat in a hard cheese for what reason?", a: "They cut through the fat, cleansing the palate." },
                { q: "The cuisine of the Douro reflects its agricultural heritage and historical ties to what?", a: "The sea" },
                { q: "What is 'Carne Mirandesa'?", a: "Beef from a protected, local cattle breed" },
                { q: "Which is a more modern culinary icon of Porto, created in the 1950s?", a: "Francesinha" }
            ],
            critic: [
                { q: "Which producer is renowned for powerful, structured, and exceptionally long-lived Vintage Ports?", a: "Taylor Fladgate" },
                { q: "Which producer is known for a more opulent, rich, and voluptuous style of Vintage Port?", a: "Fonseca" },
                { q: "Which Symington-owned house is famed for a characteristically drier, more austere style of Vintage Port?", a: "Dow's" },
                { q: "Which estate produces the legendary 'Nacional' Vintage Port from ungrafted vines?", a: "Quinta do Noval" },
                { q: "Which vintage is widely considered a modern benchmark, one of the greatest of the 21st century?", a: "2011" },
                { q: "How does the 2016 vintage characteristically differ from the hotter 2017?", a: "2016 is more balanced, with vibrant acidity and elegant structure." },
                { q: "Which producer is a 'Value Champion', especially for its LBV?", a: "Niepoort" },
                { q: "Which boutique winery has achieved cult status for its 'Pintas' Vintage Port?", a: "Wine & Soul" },
                { q: "Wines aged reductively in large vessels to preserve primary fruit are what style?", a: "Ruby Styles" },
                { q: "Wines aged oxidatively in small casks to develop nutty aromas are what style?", a: "Tawny Styles" },
                { q: "Which Symington house represents a richer, sweeter, and more luscious style of Port?", a: "Graham's" },
                { q: "The hot 2003 vintage produced Vintage Ports with what character?", a: "Deeply colored, aromatic, and full-bodied with ripe fruit." },
                { q: "In good but not 'classic' years, what might a major house release?", a: "A Single Quinta Vintage Port" },
                { q: "Who is the influential modern figurehead of Niepoort?", a: "Dirk van der Niepoort" },
                { q: "The 2007 vintage was a classic year praised for what characteristics?", a: "Great purity, aromatic definition, and balance" },
                { q: "Which producer is the oldest British Port house and a reliable source for value?", a: "Warre's" },
                { q: "How are cooler, elegant Single Quinta vintages like 2013 and 2015 often positioned?", a: "They offer great value and earlier drinking." },
                { q: "Which of these is NOT considered a 'First Growth Equivalent' iconic producer?", a: "Warre's" },
                { q: "What is the primary characteristic of a Ruby style Port?", a: "Primary fruit aromas like blackberry and cassis" },
                { q: "What is the primary characteristic of an Aged Tawny Port?", a: "A complex bouquet of dried fruits, nuts, and caramel" },
                { q: "How is the 2018 vintage generally described?", a: "Variable, but the best are rich, concentrated, and powerful." },
                { q: "Which producer's 'Guimaraens Vintage Port' is released in very good but not 'classic' years?", a: "Fonseca" },
                { q: "Which producer's Single Quinta estate is Quinta do Bomfim?", a: "Dow's" },
                { q: "Which producer's Single Quinta estate is Quinta dos Malvedos?", a: "Graham's" },
                { q: "The 2022 vintage was characterized by what extreme weather?", a: "Remarkably hot and dry with record temperatures" },
                { q: "Which newer estate is known for a modern, polished style of Vintage Port?", a: "Quinta da Pedra Alta" },
                { q: "When does a 'general' or 'classic' declaration occur?", a: "When most of the major houses declare the vintage." },
                { q: "The hot 2017 vintage produced wines of incredible...?", a: "Intensity and concentration" },
                { q: "What is Taylor Fladgate's rarest and most prestigious cuvée?", a: "Quinta de Vargellas Vinha Velha Vintage Port" },
                { q: "Which producer is known for the rare 'Garrafeira' style of Port?", a: "Niepoort" },
                { q: "The 2012 vintage was a Single Quinta year noted for what style of wines?", a: "Concentrated yet balanced and fine wines" },
                { q: "How is the market for Port wine changing?", a: "Sales are declining by volume but rising by value due to premiumization." },
                { q: "What is the key sensory difference between Ruby and Tawny Port?", a: "Ruby expresses primary fruit; Tawny expresses oxidative notes." },
                { q: "The cool 2008 vintage yielded wines with what characteristics?", a: "Fresh wines with good tannic grip" },
                { q: "Which producer is NOT part of the Symington Family Estates portfolio?", a: "Taylor Fladgate" },
                { q: "Which producer is NOT part of The Fladgate Partnership?", a: "Dow's" },
                { q: "The 2014 vintage was described as:", a: "A difficult, cool, and wet vintage with very few declarations" },
                { q: "What is the primary appeal of Aged Tawny Ports?", a: "They are complex and ready to drink upon release." },
                { q: "What is the primary appeal of Vintage Port for collectors?", a: "Its profound capacity to evolve and gain complexity over decades." },
                { q: "Port's critical perception is defined by sweetness, high alcohol, and what else?", a: "Concentrated richness" },
                { q: "Which producer's entry-level Tawny is praised for its quality-to-price ratio?", a: "Dow's" },
                { q: "Which vintage is described as wonderfully harmonious, though less powerful than 2011?", a: "2007" },
                { q: "What is a defining characteristic of wines from 'hot, ripe vintages' like 2003 and 2009?", a: "They are rich and full-bodied, sometimes lacking finesse." },
                { q: "The 2004 vintage was a Single Quinta year noted for what kind of wines?", a: "Very balanced and symmetrical wines" },
                { q: "The 'Douro Boys' are most famous for pioneering what?", a: "High-quality unfortified Douro table wines" },
                { q: "Which producer owns Quinta do Vesuvio, where all Port is still made by foot treading?", a: "Symington Family Estates" },
                { q: "What is the aging potential of Vintage Port?", a: "It can evolve for a century or more." },
                { q: "The 'special categories' of Port exclude which styles?", a: "Basic Ruby, Tawny, white, and rosé" },
                { q: "Which producer created the first iconic unfortified Douro red, Barca Velha?", a: "Ferreira (Casa Ferreirinha)" },
                { q: "Which historical figure was a vocal critic of heavy fortification?", a: "Barão de Forrester" }
            ]
        };




        const mainMenu = document.getElementById('main-menu');
        const gameScreen = document.getElementById('game-screen');
        const modalContainer = document.getElementById('modal-container');
        const modalContentWrapper = document.getElementById('modal-content-wrapper');
        const aiSettingsBtn = document.getElementById('ai-settings-btn');




        let currentModule;
        let currentQuestionIndex;
        let score;
        let questions = [];
        let userTimeline = [];
        let historianAvailableEvents = [];
        let flashcardDeck = [];
        let currentFlashcardIndex = 0;
        let userApiKey = localStorage.getItem('geminiApiKey') || '';




        // --- Event Listeners ---
        document.querySelectorAll('.module-btn').forEach(button => {
            button.addEventListener('click', () => {
                const module = button.dataset.module;
                if (module === 'flashcard') {
                    showFlashcardTopicSelection();
                } else {
                    showInstructionalModal(module);
                }
            });
        });




        aiSettingsBtn.addEventListener('click', showAiSettingsModal);
    	
        // --- Modal Functions ---
        function showModal(content) {
            modalContentWrapper.innerHTML = content;
            modalContainer.classList.remove('hidden');
        }




        function hideModal() {
            modalContainer.classList.add('hidden');
            modalContentWrapper.innerHTML = '';
        }
    	
        function showWelcomeModal() {
            if (sessionStorage.getItem('welcomed')) return;
            const content = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">Welcome to the Gauntlet!</h2>
                    <p class="mb-4 text-gray-300">This is "Porto: A Wine Master's Challenge," an interactive study game designed for advanced wine students.</p>
                    <p class="mb-6 text-gray-300">Test your knowledge across history, terroir, grapes, law, and more. All questions are derived from a comprehensive research document on the region. Good luck!</p>
                    <button onclick="closeWelcomeModal()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Begin</button>
                </div>
            `;
            showModal(content);
        }




        function closeWelcomeModal() {
            sessionStorage.setItem('welcomed', 'true');
            hideModal();
        }




        function showInstructionalModal(module) {
            currentModule = module;
            const moduleData = gameData[module];
            const content = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">${moduleData.title}</h2>
                    <p class="mb-6 text-gray-300">${moduleData.instructions}</p>
                    <button onclick="startGame()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Start Challenge</button>
                </div>
            `;
            showModal(content);
        }




        function showEndGameModal() {
            const moduleData = gameData[currentModule];
            const content = `
                <div class="p-6 text-center">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">Module Complete!</h2>
                    <p class="text-lg mb-2 text-gray-300">You completed "${moduleData.title}".</p>
                    <p class="text-4xl font-bold mb-6">Score: ${score} / ${questions.length}</p>
                    <div class="flex space-x-4">
                        <button onclick="startGame()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Keep Going</button>
                        <button onclick="returnToMenu()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Main Menu</button>
                    </div>
                </div>
            `;
            showModal(content);
        }




        function showAiSettingsModal() {
            const content = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-purple-400">AI Settings</h2>
                        <button onclick="hideModal()" class="text-gray-400 hover:text-white">&times;</button>
                    </div>
                    <p class="mb-4 text-gray-300">To use the AI-powered features, please enter your Google AI Studio API key. You can get a key at <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-purple-400 hover:underline">aistudio.google.com/app/apikey</a>.</p>
                    <p class="text-sm text-yellow-400 mb-4">Security Reminder: Treat your API key like a password. It is saved in your browser's local storage for convenience but is not transmitted anywhere else.</p>
                    <div class="mb-4">
                        <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-1">Google AI API Key</label>
                        <input type="password" id="api-key-input" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" value="${userApiKey}">
                    </div>
                    <button onclick="saveApiKey()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Save and Close</button>
                </div>
            `;
            showModal(content);
        }
    	
        function saveApiKey() {
            userApiKey = document.getElementById('api-key-input').value;
            localStorage.setItem('geminiApiKey', userApiKey);
            hideModal();
        }




        // --- Game Flow ---
        function startGame() {
            hideModal();
            mainMenu.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            score = 0;
            currentQuestionIndex = 0;




            if (currentModule === 'historian') {
                questions = shuffleArray([...gameData.historian.questions]).slice(0, 4); 
                loadHistorianQuestion();
            } else {
                const allModuleQuestions = [...gameData[currentModule].questions];
                const correctLog = JSON.parse(localStorage.getItem('correctlyAnsweredQuestions')) || {};
                const correctQuestionsForModule = correctLog[currentModule] || [];




                let availableQuestions = allModuleQuestions.filter(q => !correctQuestionsForModule.includes(q.q));




                if (availableQuestions.length === 0 && allModuleQuestions.length > 0) {
                    const masteryContent = `
                        <div class="p-6 text-center">
                            <h2 class="text-2xl font-bold mb-4 text-green-400">Module Mastered!</h2>
                            <p class="mb-4 text-gray-300">Congratulations! You've correctly answered all questions in this module. Your progress will be reset so you can continue to sharpen your knowledge.</p>
                            <button onclick="resetAndStartGame()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Play Again</button>
                        </div>
                    `;
                    showModal(masteryContent);
                    return; 
                }
            	
                questions = shuffleArray(availableQuestions).slice(0, 10);
                loadQuestion();
            }
        }




        function resetAndStartGame() {
            let correctLog = JSON.parse(localStorage.getItem('correctlyAnsweredQuestions')) || {};
            correctLog[currentModule] = [];
            localStorage.setItem('correctlyAnsweredQuestions', JSON.stringify(correctLog));
            startGame();
        }




        function returnToMenu() {
            hideModal();
            gameScreen.classList.add('hidden');
            mainMenu.classList.remove('hidden');
            gameScreen.innerHTML = '';
            checkGlobalMastery();
        }




        // --- Multiple Choice Logic ---
        function loadQuestion() {
            if (questions.length === 0 || currentQuestionIndex >= questions.length) {
                showEndGameModal();
                return;
            }




            const q = questions[currentQuestionIndex];
            const options = shuffleArray([q.a, ...q.o]);
        	
            gameScreen.innerHTML = `
                <div class="w-full max-w-3xl">
                    <div class="flex justify-between items-center mb-2">
                        <button onclick="returnToMenu()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded text-sm">← Menu</button>
                        <p class="text-right text-gray-400">${currentQuestionIndex + 1} / ${questions.length} | Score: ${score}</p>
                    </div>
                    <div class="bg-gray-800 p-8 rounded-lg">
                        <p class="text-xl md:text-2xl font-medium mb-6">${q.q}</p>
                        <div class="space-y-4">
                            ${options.map(option => `
                                <button class="answer-btn block w-full text-left bg-gray-700 p-4 rounded-lg hover:bg-purple-700 transition-colors duration-200" onclick="checkAnswer('${option.replace(/'/g, "\\'")}')">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                        <div id="feedback-container" class="mt-6"></div>
                    </div>
                </div>
            `;
        }
    	
        function nextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }
    	
        function generateAiButtonHtml(question, isCorrect) {
            if (!question.subjectType || !question.subjectName) {
                return '';
            }
        	
            let buttonText = isCorrect ? `➡️ Dive Deeper on ${question.subjectName}` : `💡 Learn More about ${question.subjectName}`;
            if (question.subjectType === 'dish' || question.subjectType === 'wine_pairing') {
                buttonText = isCorrect ? `🍴 Explain the Pairing for ${question.subjectName}` : `💡 Learn about Pairing with ${question.subjectName}`;
            } else if (question.subjectType === 'grape' || question.subjectType === 'viticulture') {
                 buttonText = isCorrect ? `📚 Generate Ampelography Profile` : `💡 Learn More about ${question.subjectName}`;
            } else if (question.subjectType === 'producer' || question.subjectType === 'vintage' || question.subjectType === 'wine_style' || question.subjectType === 'critic') {
                buttonText = isCorrect ? `✨ Generate Tasting Note` : `💡 Learn More about ${question.subjectName}`;
            }




            return `<button onclick="handleAiRequest('${question.subjectType}', '${question.subjectName.replace(/'/g, "\\'")}')" class="mt-4 bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded text-sm">${buttonText}</button>`;
        }




        function checkAnswer(selectedOption) {
            const q = questions[currentQuestionIndex];
            const isCorrect = selectedOption === q.a;
            const feedbackContainer = document.getElementById('feedback-container');
        	
            let feedbackHtml = '';
            if (isCorrect) {
                score++;
                const questionText = q.q;
                let correctLog = JSON.parse(localStorage.getItem('correctlyAnsweredQuestions')) || {};
                if (!correctLog[currentModule]) {
                    correctLog[currentModule] = [];
                }
                if (!correctLog[currentModule].includes(questionText)) {
                    correctLog[currentModule].push(questionText);
                }
                localStorage.setItem('correctlyAnsweredQuestions', JSON.stringify(correctLog));




                feedbackHtml = `<div class="p-4 rounded-lg bg-green-900 border border-green-700">
                                    <p class="font-bold text-green-300">Correct!</p>
                                    <p class="text-green-400">${q.a}</p>
                                    ${generateAiButtonHtml(q, true)}
                                </div>`;
            } else {
                feedbackHtml = `<div class="p-4 rounded-lg bg-red-900 border border-red-700">
                                    <p class="font-bold text-red-300">Incorrect.</p>
                                    <p class="text-red-400">The correct answer was: ${q.a}</p>
                                    ${generateAiButtonHtml(q, false)}
                                </div>`;
            }




            feedbackContainer.innerHTML = feedbackHtml;
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.disabled = true;
                if(btn.innerText === q.a) {
                    btn.classList.remove('hover:bg-purple-700');
                    btn.classList.add('bg-green-700');
                }
            });
            feedbackContainer.innerHTML += `<button onclick="nextQuestion()" class="mt-4 w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Continue</button>`;
        }
    	
        // --- Historian's Scroll Logic ---
        function loadHistorianQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showEndGameModal();
                return;
            }




            const q = questions[currentQuestionIndex];
            userTimeline = [];
        	
            const eventsWithIds = q.events.map((event, index) => ({ ...event, id: `${currentQuestionIndex}-${index}` }));
            historianAvailableEvents = shuffleArray(eventsWithIds);




            gameScreen.innerHTML = `
                <div class="w-full max-w-4xl">
                    <div class="flex justify-between items-center mb-2">
                        <button onclick="returnToMenu()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded text-sm">← Menu</button>
                        <p class="text-center text-gray-400">Question ${currentQuestionIndex + 1} / ${questions.length} | Score: ${score}</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <p class="text-xl text-center font-medium mb-6">${q.question}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="font-bold text-lg mb-2 text-purple-400 text-center">Available Events</h3>
                                <div id="available-events" class="space-y-2">
                                    ${historianAvailableEvents.map(event => `
                                        <button data-id="${event.id}" class="timeline-item w-full text-left bg-gray-700 p-3 rounded hover:bg-purple-800 transition-colors duration-200">
                                            ${event.text}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-2 text-purple-400 text-center">Your Timeline (Earliest to Latest)</h3>
                                <div id="user-timeline" class="space-y-2 bg-gray-900 p-3 rounded-lg min-h-[200px]"></div>
                            </div>
                        </div>
                        <div class="text-center mt-6">
                            <button id="submit-timeline" class="bg-purple-700 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-lg" onclick="checkTimeline()">Submit</button>
                        </div>
                    </div>
                </div>
            `;
        	
            document.querySelectorAll('#available-events .timeline-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    const eventId = e.currentTarget.dataset.id;
                    const event = historianAvailableEvents.find(ev => ev.id === eventId);
                    if (event && !userTimeline.some(e => e.id === event.id)) {
                        userTimeline.push(event);
                        e.currentTarget.classList.add('selected', 'opacity-50', 'cursor-not-allowed');
                        e.currentTarget.disabled = true;
                        renderUserTimeline();
                    }
                });
            });
        }
    	
        function renderUserTimeline() {
            const timelineContainer = document.getElementById('user-timeline');
            timelineContainer.innerHTML = userTimeline.map((event, index) => `
                <div class="bg-purple-900 p-3 rounded flex items-center justify-between">
                    <span>${index + 1}. ${event.text}</span>
                    <button class="text-red-400 hover:text-red-200 font-bold" onclick="removeFromTimeline('${event.id}')">&times;</button>
                </div>
            `).join('');
        }




        function removeFromTimeline(eventId) {
            const indexToRemove = userTimeline.findIndex(event => event.id === eventId);




            if (indexToRemove > -1) {
                userTimeline.splice(indexToRemove, 1);
                const buttonToReEnable = document.querySelector(`#available-events .timeline-item[data-id="${eventId}"]`);
                if (buttonToReEnable) {
                    buttonToReEnable.disabled = false;
                    buttonToReEnable.classList.remove('selected', 'opacity-50', 'cursor-not-allowed');
                }
                renderUserTimeline();
            }
        }




        function checkTimeline() {
            const q = questions[currentQuestionIndex];
            const correctTimeline = [...q.events].sort((a, b) => a.date - b.date);
            let isCompletelyCorrect = userTimeline.length === correctTimeline.length;
        	
            if (isCompletelyCorrect) {
                for (let i = 0; i < correctTimeline.length; i++) {
                    if (userTimeline[i].text !== correctTimeline[i].text) {
                        isCompletelyCorrect = false;
                        break;
                    }
                }
            }
        	
            if(isCompletelyCorrect) {
                score++;
            }




            const userTimelineHtml = userTimeline.map((event, i) => {
                const isEventInCorrectPosition = correctTimeline[i] && correctTimeline[i].text === event.text;
                const borderColor = isEventInCorrectPosition ? 'border-green-500' : 'border-red-500';
                return `<li class="p-2 bg-gray-700 rounded border-2 ${borderColor}">${event.text}</li>`;
            }).join('');




            const correctTimelineHtml = correctTimeline.map(e => 
                `<li class="p-2 bg-gray-700 rounded border-2 border-green-500">${e.text} <span class="text-gray-400 text-sm">(${e.date})</span></li>`
            ).join('');
        	
            const feedbackContent = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 ${isCompletelyCorrect ? 'text-green-400' : 'text-yellow-400'}">${isCompletelyCorrect ? 'Perfect!' : 'Review Your Timeline'}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-bold text-lg mb-2 text-purple-400">Your Timeline</h3>
                            <ol class="list-decimal list-inside space-y-2">
                                ${userTimelineHtml}
                            </ol>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-2 text-purple-400">Correct Timeline</h3>
                            <ol class="list-decimal list-inside space-y-2">
                                ${correctTimelineHtml}
                            </ol>
                        </div>
                    </div>
                    <button onclick="nextHistorianQuestion()" class="mt-6 w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Continue</button>
                </div>
            `;
            showModal(feedbackContent);
        }




        function nextHistorianQuestion() {
            hideModal();
            currentQuestionIndex++;
            loadHistorianQuestion();
        }




        // --- Mastery Logic ---
        function checkGlobalMastery() {
            if (sessionStorage.getItem('globalMasteryAcknowledged')) {
                return;
            }




            const modulesToMaster = ['terroir', 'ampelographer', 'lawmaker', 'gastronome', 'critic'];
            const correctLog = JSON.parse(localStorage.getItem('correctlyAnsweredQuestions')) || {};
        	
            let allMastered = true;
            for (const module of modulesToMaster) {
                const totalQuestions = gameData[module].questions.length;
                const correctlyAnswered = (correctLog[module] || []).length;
                if (correctlyAnswered < totalQuestions) {
                    allMastered = false;
                    break;
                }
            }




            if (allMastered) {
                showGlobalMasteryModal();
            }
        }




        function showGlobalMasteryModal() {
            const content = `
                <div class="p-6 text-center">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">Congratulations, Wine Master!</h2>
                    <p class="mb-4 text-gray-300">You have demonstrated exceptional knowledge by correctly answering every question across all core modules. You have truly mastered Porto!</p>
                    <p class="mb-6 text-gray-300">To keep your expertise sharp, continue to practice with the <strong>Flashcard Study</strong> decks.</p>
                    <button onclick="closeGlobalMasteryModal()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Continue</button>
                </div>
            `;
            showModal(content);
        }




        function closeGlobalMasteryModal() {
            sessionStorage.setItem('globalMasteryAcknowledged', 'true');
            hideModal();
        }




        // --- Flashcard Logic ---
        function showFlashcardTopicSelection() {
            const topics = Object.keys(flashcardData); // Use flashcardData keys
            const content = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">Build Your Flashcard Deck</h2>
                    <p class="mb-6 text-gray-300">Select the topics you want to study. These decks cover the entire source document.</p>
                    <div id="flashcard-topics" class="space-y-2 mb-4">
                        ${topics.map(topic => `
                            <label class="flex items-center bg-gray-700 p-3 rounded-lg hover:bg-gray-600 cursor-pointer">
                                <input type="checkbox" class="form-checkbox h-5 w-5 text-purple-600 bg-gray-800 border-gray-600 rounded focus:ring-purple-500" data-topic="${topic}">
                                <span class="ml-3 text-white">${gameData[topic].title}</span>
                            </label>
                        `).join('')}
                    </div>
                     <label class="flex items-center bg-gray-700 p-3 rounded-lg hover:bg-gray-600 cursor-pointer mb-6">
                        <input type="checkbox" id="select-all-topics" class="form-checkbox h-5 w-5 text-purple-600 bg-gray-800 border-gray-600 rounded focus:ring-purple-500">
                        <span class="ml-3 text-white font-bold">Select All</span>
                    </label>
                    <button onclick="startFlashcardSession()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Start Studying</button>
                </div>
            `;
            showModal(content);
        	
            document.getElementById('select-all-topics').addEventListener('change', (e) => {
                document.querySelectorAll('#flashcard-topics input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });
        }




        function startFlashcardSession() {
            flashcardDeck = [];
            const selectedTopics = Array.from(document.querySelectorAll('#flashcard-topics input:checked')).map(cb => cb.dataset.topic);




            if (selectedTopics.length === 0) {
                showModal(`<div class="p-6 text-center">
                    <p class="text-lg text-yellow-400 mb-4">Please select at least one topic.</p>
                    <button onclick="showFlashcardTopicSelection()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Go Back</button>
                </div>`);
                return;
            }




            selectedTopics.forEach(topic => {
                if (flashcardData[topic]) {
                    flashcardDeck.push(...flashcardData[topic]);
                }
            });




            flashcardDeck = shuffleArray(flashcardDeck);
            currentFlashcardIndex = 0;
            hideModal();
            mainMenu.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            loadFlashcard();
        }




        function loadFlashcard() {
            if (flashcardDeck.length === 0) {
                gameScreen.innerHTML = `<div class="text-center">
                    <p class="text-2xl mb-4">No topics selected.</p>
                    <button onclick="returnToMenu()" class="bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Main Menu</button>
                </div>`;
                return;
            }
            const card = flashcardDeck[currentFlashcardIndex];
            gameScreen.innerHTML = `
                <div class="w-full max-w-2xl flex flex-col items-center">
                    <p class="text-gray-400 mb-4">${currentFlashcardIndex + 1} / ${flashcardDeck.length}</p>
                    <div class="flashcard-container w-full h-80 mb-6">
                        <div class="flashcard" onclick="this.classList.toggle('is-flipped')">
                            <div class="flashcard-face flashcard-front text-2xl font-semibold">${card.q}</div>
                            <div class="flashcard-face flashcard-back text-xl overflow-y-auto">${card.a}</div>
                        </div>
                    </div>
                    <div class="flex justify-between w-full">
                        <button id="prev-card" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded">&larr; Previous</button>
                        <button onclick="returnToMenu()" class="bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-6 rounded">End Session</button>
                        <button id="next-card" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded">Next &rarr;</button>
                    </div>
                </div>
            `;
        	
            document.getElementById('prev-card').addEventListener('click', () => {
                if (currentFlashcardIndex > 0) {
                    currentFlashcardIndex--;
                    loadFlashcard();
                }
            });
            document.getElementById('next-card').addEventListener('click', () => {
                if (currentFlashcardIndex < flashcardDeck.length - 1) {
                    currentFlashcardIndex++;
                    loadFlashcard();
                }
            });
        }
    	
        // --- AI Integration ---
        async function handleAiRequest(subjectType, subjectName) {
            if (!userApiKey) {
                showModal(`<div class="p-6 text-center">
                    <h2 class="text-2xl font-bold mb-4 text-yellow-400">API Key Required</h2>
                    <p class="mb-4 text-gray-300">Please set your Google AI API key in the 'AI Settings' on the main menu to use this feature.</p>
                    <button onclick="hideModal()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Close</button>
                </div>`);
                return;
            }




            let prompt;
            let title;
            const region = "Porto and the Douro Valley";




            switch (subjectType) {
                case 'grape':
                case 'viticulture':
                    title = `Ampelography Profile: ${subjectName}`;
                    prompt = `You are a master ampelographer and wine educator with a specialization in ${region}. Your task is to profile the grape or viticultural topic: ${subjectName}. Your response must follow this strict pyramid of importance: 1. The subject's specific expression and role within ${region}. 2. Its general characteristics as they manifest in ${region}'s climate. 3. Its history within the region. Your entire response must be framed through the lens of ${region}. Synthesize information from authoritative sources, but always prioritize the context of ${region}. Structure your response with the following sections: Overview and History in ${region}, Characteristics in ${region}, and Role in ${region} Wine. Format the output in simple HTML.`;
                    break;
                case 'wine':
                case 'producer':
                case 'vintage':
                case 'place':
                case 'wine_style':
                case 'critic':
                    title = `Critic's Focus: ${subjectName}`;
                    prompt = `You are a world-renowned wine critic specializing exclusively in the wines of ${region}. Your task is to write a professional profile for the following iconic ${region} topic: ${subjectName}. Your analysis must adhere to a strict pyramid of importance: 1) The specific subject's style or character. 2) The character of its specific appellation within ${region}. 3) The general characteristics of ${region}. Do not mention wines from other regions unless making a direct, essential stylistic comparison. Synthesize information from authoritative sources like Vinous, The Wine Advocate, and JancisRobinson.com, but ensure the final note is your own expert synthesis. Format in simple HTML.`;
                    break;
                case 'dish':
                case 'wine_pairing':
                    title = `Gastronomic Pairing: ${subjectName}`;
                    prompt = `You are a master sommelier and food theorist specializing in the cuisine and wine of ${region}. Your task is to explain the classic wine pairing for the dish: ${subjectName}. Your explanation must follow this strict pyramid of importance: 1. The specific characteristics of the dish as found in the region. 2. The typical profile of a ${region} wine that pairs with it. 3. The underlying gastronomic principles (complement, contrast, texture) that make the pairing successful within the context of ${region}'s culture. Synthesize information from expert sources, but frame your entire response within the context of ${region}. Format in simple HTML.`;
                    break;
                case 'ingredient':
                case 'gastronomy':
                    title = `Ingredient Focus: ${subjectName}`;
                    prompt = `You are a food and wine expert specializing in the cuisine of ${region}. Your task is to provide a detailed overview of the ingredient: ${subjectName}. Your response must follow this strict pyramid of importance: 1. How this ingredient is used in the local cuisine of ${region}. 2. Its typical flavor and aromatic profile. 3. How its profile might be reflected in or complement the local wines, but do not focus on specific pairings unless it is intrinsic to the ingredient itself. Synthesize from authoritative sources. Format in simple HTML.`;
                    break;
                case 'spirit':
                case 'liqueur':
                case 'beverage':
                    title = `Beverage Profile: ${subjectName}`;
                    prompt = `You are an expert on the spirits and liqueurs of Portugal, with a specialization in ${region}. Your task is to provide a detailed overview of ${subjectName}. Your response must follow this strict pyramid of importance: 1. How ${subjectName} is made and consumed specifically within ${region}. 2. Its key ingredients and typical flavor profile. 3. Its cultural significance in ${region}. Do not focus on wine pairings unless it is a key part of its consumption. Synthesize information from authoritative sources. Format in simple HTML.`;
                    break;
                default:
                    title = `Expert Overview: ${subjectName}`;
                    prompt = `You are a wine and food expert specializing in ${region}. Provide a concise and informative overview of the following topic: ${subjectName}, ensuring your response is strictly relevant to its context within ${region}. Format in simple HTML.`;
            }
        	
            showModal(`<div class="p-6 text-center">
                <h2 class="text-2xl font-bold mb-4 text-purple-400">Generating AI Response...</h2>
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto"></div>
                <p class="mt-4 text-gray-400">Please wait, contacting the master sommelier...</p>
            </div>`);




            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userApiKey}`;
            	
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });




                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `API request failed with status ${response.status}`);
                }




                const result = await response.json();
            	
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    const text = result.candidates[0].content.parts[0].text;
                    const aiContent = `
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-purple-400">${title}</h2>
                                <button onclick="hideModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            <div class="prose prose-invert prose-purple max-w-none">${text.replace(/\n/g, '<br>')}</div>
                        </div>`;
                    showModal(aiContent);
                } else {
                     throw new Error("Invalid response structure from API.");
                }




            } catch (error) {
                console.error("AI Generation Error:", error);
                const errorContent = `
                    <div class="p-6">
                        <h2 class="text-2xl font-bold mb-4 text-red-400">Error</h2>
                        <p class="mb-4 text-gray-300">Could not generate AI response. Please check your API key and network connection.</p>
                        <p class="text-sm text-gray-500 bg-gray-900 p-2 rounded">${error.message}</p>
                        <button onclick="hideModal()" class="mt-4 w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Close</button>
                    </div>`;
                showModal(errorContent);
            }
        }




        // --- Utility Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }




        // --- Initial Load ---
        window.onload = showWelcomeModal;




    </script>
</body>
</html>
